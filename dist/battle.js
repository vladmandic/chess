/*
  Chess
  homepage: <https://github.com/vladmandic/chess>
  author: <https://github.com/vladmandic>'
*/

"use strict";var da=Object.create;var Rn=Object.defineProperty;var ga=Object.getOwnPropertyDescriptor;var ma=Object.getOwnPropertyNames;var _a=Object.getPrototypeOf,va=Object.prototype.hasOwnProperty;var pa=(e,t,n)=>t in e?Rn(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n;var x=(e,t)=>()=>(t||e((t={exports:{}}).exports,t),t.exports);var Ia=(e,t,n,r)=>{if(t&&typeof t=="object"||typeof t=="function")for(let i of ma(t))!va.call(e,i)&&i!==n&&Rn(e,i,{get:()=>t[i],enumerable:!(r=ga(t,i))||r.enumerable});return e};var st=(e,t,n)=>(n=e!=null?da(_a(e)):{},Ia(t||!e||!e.__esModule?Rn(n,"default",{value:e,enumerable:!0}):n,e));var q=(e,t,n)=>(pa(e,typeof t!="symbol"?t+"":t,n),n);var Wn=x((vl,Kr)=>{"use strict";var Na=Object.create,sn=Object.defineProperty,ba=Object.getOwnPropertyDescriptor,Vr=Object.getOwnPropertyNames,wa=Object.getPrototypeOf,Ea=Object.prototype.hasOwnProperty,Sa=(e,t)=>function(){return t||(0,e[Vr(e)[0]])((t={exports:{}}).exports,t),t.exports},Pa=(e,t)=>{for(var n in t)sn(e,n,{get:t[n],enumerable:!0})},Rr=(e,t,n,r)=>{if(t&&typeof t=="object"||typeof t=="function")for(let i of Vr(t))!Ea.call(e,i)&&i!==n&&sn(e,i,{get:()=>t[i],enumerable:!(r=ba(t,i))||r.enumerable});return e},ze=(e,t,n)=>(n=e!=null?Na(wa(e)):{},Rr(t||!e||!e.__esModule?sn(n,"default",{value:e,enumerable:!0}):n,e)),Ca=e=>Rr(sn({},"__esModule",{value:!0}),e),Aa=Sa({"node_modules/.pnpm/dayjs@1.11.4/node_modules/dayjs/dayjs.min.js"(e,t){(function(n,r){typeof e=="object"&&typeof t<"u"?t.exports=r():typeof define=="function"&&define.amd?define(r):(n=typeof globalThis<"u"?globalThis:n||self).dayjs=r()})(e,function(){"use strict";var n=1e3,r=6e4,i=36e5,a="millisecond",s="second",o="minute",l="hour",u="day",d="week",c="month",m="quarter",_="year",E="date",F="Invalid Date",re=/^(\d{4})[-/]?(\d{1,2})?[-/]?(\d{0,2})[Tt\s]*(\d{1,2})?:?(\d{1,2})?:?(\d{1,2})?[.:]?(\d+)?$/,ye=/\[([^\]]+)]|Y{1,4}|M{1,4}|D{1,2}|d{1,4}|H{1,2}|h{1,2}|a|A|m{1,2}|s{1,2}|Z{1,2}|SSS/g,Tt={name:"en",weekdays:"Sunday_Monday_Tuesday_Wednesday_Thursday_Friday_Saturday".split("_"),months:"January_February_March_April_May_June_July_August_September_October_November_December".split("_")},we=function(b,g,f){var p=String(b);return!p||p.length>=g?b:""+Array(g+1-p.length).join(f)+b},it={s:we,z:function(b){var g=-b.utcOffset(),f=Math.abs(g),p=Math.floor(f/60),h=f%60;return(g<=0?"+":"-")+we(p,2,"0")+":"+we(h,2,"0")},m:function b(g,f){if(g.date()<f.date())return-b(f,g);var p=12*(f.year()-g.year())+(f.month()-g.month()),h=g.clone().add(p,c),N=f-h<0,I=g.clone().add(p+(N?-1:1),c);return+(-(p+(f-h)/(N?h-I:I-h))||0)},a:function(b){return b<0?Math.ceil(b)||0:Math.floor(b)},p:function(b){return{M:c,y:_,w:d,d:u,D:E,h:l,m:o,s,ms:a,Q:m}[b]||String(b||"").toLowerCase().replace(/s$/,"")},u:function(b){return b===void 0}},kt="en",He={};He[kt]=Tt;var Dn=function(b){return b instanceof Jt},Qt=function b(g,f,p){var h;if(!g)return kt;if(typeof g=="string"){var N=g.toLowerCase();He[N]&&(h=N),f&&(He[N]=f,h=N);var I=g.split("-");if(!h&&I.length>1)return b(I[0])}else{var k=g.name;He[k]=g,h=k}return!p&&h&&(kt=h),h||!p&&kt},K=function(b,g){if(Dn(b))return b.clone();var f=typeof g=="object"?g:{};return f.date=b,f.args=arguments,new Jt(f)},L=it;L.l=Qt,L.i=Dn,L.w=function(b,g){return K(b,{locale:g.$L,utc:g.$u,x:g.$x,$offset:g.$offset})};var Jt=function(){function b(f){this.$L=Qt(f.locale,null,!0),this.parse(f)}var g=b.prototype;return g.parse=function(f){this.$d=function(p){var h=p.date,N=p.utc;if(h===null)return new Date(NaN);if(L.u(h))return new Date;if(h instanceof Date)return new Date(h);if(typeof h=="string"&&!/Z$/i.test(h)){var I=h.match(re);if(I){var k=I[2]-1||0,G=(I[7]||"0").substring(0,3);return N?new Date(Date.UTC(I[1],k,I[3]||1,I[4]||0,I[5]||0,I[6]||0,G)):new Date(I[1],k,I[3]||1,I[4]||0,I[5]||0,I[6]||0,G)}}return new Date(h)}(f),this.$x=f.x||{},this.init()},g.init=function(){var f=this.$d;this.$y=f.getFullYear(),this.$M=f.getMonth(),this.$D=f.getDate(),this.$W=f.getDay(),this.$H=f.getHours(),this.$m=f.getMinutes(),this.$s=f.getSeconds(),this.$ms=f.getMilliseconds()},g.$utils=function(){return L},g.isValid=function(){return this.$d.toString()!==F},g.isSame=function(f,p){var h=K(f);return this.startOf(p)<=h&&h<=this.endOf(p)},g.isAfter=function(f,p){return K(f)<this.startOf(p)},g.isBefore=function(f,p){return this.endOf(p)<K(f)},g.$g=function(f,p,h){return L.u(f)?this[p]:this.set(h,f)},g.unix=function(){return Math.floor(this.valueOf()/1e3)},g.valueOf=function(){return this.$d.getTime()},g.startOf=function(f,p){var h=this,N=!!L.u(p)||p,I=L.p(f),k=function(at,ie){var De=L.w(h.$u?Date.UTC(h.$y,ie,at):new Date(h.$y,ie,at),h);return N?De:De.endOf(u)},G=function(at,ie){return L.w(h.toDate()[at].apply(h.toDate("s"),(N?[0,0,0,0]:[23,59,59,999]).slice(ie)),h)},R=this.$W,X=this.$M,xe=this.$D,Te="set"+(this.$u?"UTC":"");switch(I){case _:return N?k(1,0):k(31,11);case c:return N?k(1,X):k(0,X+1);case d:var Mt=this.$locale().weekStart||0,Ot=(R<Mt?R+7:R)-Mt;return k(N?xe-Ot:xe+(6-Ot),X);case u:case E:return G(Te+"Hours",0);case l:return G(Te+"Minutes",1);case o:return G(Te+"Seconds",2);case s:return G(Te+"Milliseconds",3);default:return this.clone()}},g.endOf=function(f){return this.startOf(f,!1)},g.$set=function(f,p){var h,N=L.p(f),I="set"+(this.$u?"UTC":""),k=(h={},h[u]=I+"Date",h[E]=I+"Date",h[c]=I+"Month",h[_]=I+"FullYear",h[l]=I+"Hours",h[o]=I+"Minutes",h[s]=I+"Seconds",h[a]=I+"Milliseconds",h)[N],G=N===u?this.$D+(p-this.$W):p;if(N===c||N===_){var R=this.clone().set(E,1);R.$d[k](G),R.init(),this.$d=R.set(E,Math.min(this.$D,R.daysInMonth())).$d}else k&&this.$d[k](G);return this.init(),this},g.set=function(f,p){return this.clone().$set(f,p)},g.get=function(f){return this[L.p(f)]()},g.add=function(f,p){var h,N=this;f=Number(f);var I=L.p(p),k=function(X){var xe=K(N);return L.w(xe.date(xe.date()+Math.round(X*f)),N)};if(I===c)return this.set(c,this.$M+f);if(I===_)return this.set(_,this.$y+f);if(I===u)return k(1);if(I===d)return k(7);var G=(h={},h[o]=r,h[l]=i,h[s]=n,h)[I]||1,R=this.$d.getTime()+f*G;return L.w(R,this)},g.subtract=function(f,p){return this.add(-1*f,p)},g.format=function(f){var p=this,h=this.$locale();if(!this.isValid())return h.invalidDate||F;var N=f||"YYYY-MM-DDTHH:mm:ssZ",I=L.z(this),k=this.$H,G=this.$m,R=this.$M,X=h.weekdays,xe=h.months,Te=function(ie,De,Vn,Zt){return ie&&(ie[De]||ie(p,N))||Vn[De].slice(0,Zt)},Mt=function(ie){return L.s(k%12||12,ie,"0")},Ot=h.meridiem||function(ie,De,Vn){var Zt=ie<12?"AM":"PM";return Vn?Zt.toLowerCase():Zt},at={YY:String(this.$y).slice(-2),YYYY:this.$y,M:R+1,MM:L.s(R+1,2,"0"),MMM:Te(h.monthsShort,R,xe,3),MMMM:Te(xe,R),D:this.$D,DD:L.s(this.$D,2,"0"),d:String(this.$W),dd:Te(h.weekdaysMin,this.$W,X,2),ddd:Te(h.weekdaysShort,this.$W,X,3),dddd:X[this.$W],H:String(k),HH:L.s(k,2,"0"),h:Mt(1),hh:Mt(2),a:Ot(k,G,!0),A:Ot(k,G,!1),m:String(G),mm:L.s(G,2,"0"),s:String(this.$s),ss:L.s(this.$s,2,"0"),SSS:L.s(this.$ms,3,"0"),Z:I};return N.replace(ye,function(ie,De){return De||at[ie]||I.replace(":","")})},g.utcOffset=function(){return 15*-Math.round(this.$d.getTimezoneOffset()/15)},g.diff=function(f,p,h){var N,I=L.p(p),k=K(f),G=(k.utcOffset()-this.utcOffset())*r,R=this-k,X=L.m(this,k);return X=(N={},N[_]=X/12,N[c]=X,N[m]=X/3,N[d]=(R-G)/6048e5,N[u]=(R-G)/864e5,N[l]=R/i,N[o]=R/r,N[s]=R/n,N)[I]||R,h?X:L.a(X)},g.daysInMonth=function(){return this.endOf(c).$D},g.$locale=function(){return He[this.$L]},g.locale=function(f,p){if(!f)return this.$L;var h=this.clone(),N=Qt(f,p,!0);return N&&(h.$L=N),h},g.clone=function(){return L.w(this.$d,this)},g.toDate=function(){return new Date(this.valueOf())},g.toJSON=function(){return this.isValid()?this.toISOString():null},g.toISOString=function(){return this.$d.toISOString()},g.toString=function(){return this.$d.toUTCString()},b}(),yr=Jt.prototype;return K.prototype=yr,[["$ms",a],["$s",s],["$m",o],["$H",l],["$W",u],["$M",c],["$y",_],["$D",E]].forEach(function(b){yr[b[1]]=function(g){return this.$g(g,b[0],b[1])}}),K.extend=function(b,g){return b.$i||(b(g,Jt,K),b.$i=!0),K},K.locale=Qt,K.isDayjs=Dn,K.unix=function(b){return K(1e3*b)},K.en=He[kt],K.Ls=He,K.p={},K})}}),qr={};Pa(qr,{access:()=>Ka,accessFile:()=>Wr,assert:()=>ja,blank:()=>Qa,client:()=>Ha,clientFile:()=>jr,configure:()=>Ya,console:()=>ss,data:()=>es,debug:()=>as,error:()=>ns,fatal:()=>rs,header:()=>za,headerJson:()=>Xa,info:()=>Ja,logFile:()=>Ur,options:()=>P,print:()=>Se,ring:()=>en,state:()=>Za,tags:()=>oe,timed:()=>Wa,verbose:()=>is,warn:()=>ts});Kr.exports=Ca(qr);var Gr=ze(require("os")),Ye=ze(require("fs")),ke=ze(require("path")),xt=ze(Aa()),qn=10,Tr=(e=0)=>t=>`\x1B[${t+e}m`,kr=(e=0)=>t=>`\x1B[${38+e};5;${t}m`,Mr=(e=0)=>(t,n,r)=>`\x1B[${38+e};2;${t};${n};${r}m`;function ya(){let e=new Map,t={modifier:{reset:[0,0],bold:[1,22],dim:[2,22],italic:[3,23],underline:[4,24],overline:[53,55],inverse:[7,27],hidden:[8,28],strikethrough:[9,29]},color:{black:[30,39],red:[31,39],green:[32,39],yellow:[33,39],blue:[34,39],magenta:[35,39],cyan:[36,39],white:[37,39],blackBright:[90,39],redBright:[91,39],greenBright:[92,39],yellowBright:[93,39],blueBright:[94,39],magentaBright:[95,39],cyanBright:[96,39],whiteBright:[97,39]},bgColor:{bgBlack:[40,49],bgRed:[41,49],bgGreen:[42,49],bgYellow:[43,49],bgBlue:[44,49],bgMagenta:[45,49],bgCyan:[46,49],bgWhite:[47,49],bgBlackBright:[100,49],bgRedBright:[101,49],bgGreenBright:[102,49],bgYellowBright:[103,49],bgBlueBright:[104,49],bgMagentaBright:[105,49],bgCyanBright:[106,49],bgWhiteBright:[107,49]}};t.color.gray=t.color.blackBright,t.bgColor.bgGray=t.bgColor.bgBlackBright,t.color.grey=t.color.blackBright,t.bgColor.bgGrey=t.bgColor.bgBlackBright;for(let[n,r]of Object.entries(t)){for(let[i,a]of Object.entries(r))t[i]={open:`\x1B[${a[0]}m`,close:`\x1B[${a[1]}m`},r[i]=t[i],e.set(a[0],a[1]);Object.defineProperty(t,n,{value:r,enumerable:!1})}return Object.defineProperty(t,"codes",{value:e,enumerable:!1}),t.color.close="\x1B[39m",t.bgColor.close="\x1B[49m",t.color.ansi=Tr(),t.color.ansi256=kr(),t.color.ansi16m=Mr(),t.bgColor.ansi=Tr(qn),t.bgColor.ansi256=kr(qn),t.bgColor.ansi16m=Mr(qn),Object.defineProperties(t,{rgbToAnsi256:{value:(n,r,i)=>n===r&&r===i?n<8?16:n>248?231:Math.round((n-8)/247*24)+232:16+36*Math.round(n/255*5)+6*Math.round(r/255*5)+Math.round(i/255*5),enumerable:!1},hexToRgb:{value:n=>{let r=/(?<colorString>[a-f\d]{6}|[a-f\d]{3})/i.exec(n.toString(16));if(!r)return[0,0,0];let{colorString:i}=r.groups;i.length===3&&(i=[...i].map(s=>s+s).join(""));let a=Number.parseInt(i,16);return[a>>16&255,a>>8&255,a&255]},enumerable:!1},hexToAnsi256:{value:n=>t.rgbToAnsi256(...t.hexToRgb(n)),enumerable:!1},ansi256ToAnsi:{value:n=>{if(n<8)return 30+n;if(n<16)return 90+(n-8);let r,i,a;if(n>=232)r=((n-232)*10+8)/255,i=r,a=r;else{n-=16;let l=n%36;r=Math.floor(n/36)/5,i=Math.floor(l/6)/5,a=l%6/5}let s=Math.max(r,i,a)*2;if(s===0)return 30;let o=30+(Math.round(a)<<2|Math.round(i)<<1|Math.round(r));return s===2&&(o+=60),o},enumerable:!1},rgbToAnsi:{value:(n,r,i)=>t.ansi256ToAnsi(t.rgbToAnsi256(n,r,i)),enumerable:!1},hexToAnsi:{value:n=>t.ansi256ToAnsi(t.hexToAnsi256(n)),enumerable:!1}}),t}var Ta=ya(),Ee=Ta,Un=ze(require("process"),1),ka=ze(require("os"),1),Or=ze(require("tty"),1);function le(e,t=Un.default.argv){let n=e.startsWith("-")?"":e.length===1?"-":"--",r=t.indexOf(n+e),i=t.indexOf("--");return r!==-1&&(i===-1||r<i)}var{env:$}=Un.default,nn;le("no-color")||le("no-colors")||le("color=false")||le("color=never")?nn=0:(le("color")||le("colors")||le("color=true")||le("color=always"))&&(nn=1);function Ma(){if("FORCE_COLOR"in $)return $.FORCE_COLOR==="true"?1:$.FORCE_COLOR==="false"?0:$.FORCE_COLOR.length===0?1:Math.min(Number.parseInt($.FORCE_COLOR,10),3)}function Oa(e){return e===0?!1:{level:e,hasBasic:!0,has256:e>=2,has16m:e>=3}}function Fa(e,{streamIsTTY:t,sniffFlags:n=!0}={}){let r=Ma();r!==void 0&&(nn=r);let i=n?nn:r;if(i===0)return 0;if(n){if(le("color=16m")||le("color=full")||le("color=truecolor"))return 3;if(le("color=256"))return 2}if(e&&!t&&i===void 0)return 0;let a=i||0;if($.TERM==="dumb")return a;if(Un.default.platform==="win32"){let s=ka.default.release().split(".");return Number(s[0])>=10&&Number(s[2])>=10586?Number(s[2])>=14931?3:2:1}if("CI"in $)return["TRAVIS","CIRCLECI","APPVEYOR","GITLAB_CI","GITHUB_ACTIONS","BUILDKITE","DRONE"].some(s=>s in $)||$.CI_NAME==="codeship"?1:a;if("TEAMCITY_VERSION"in $)return/^(9\.(0*[1-9]\d*)\.|\d{2,}\.)/.test($.TEAMCITY_VERSION)?1:0;if("TF_BUILD"in $&&"AGENT_NAME"in $)return 1;if($.COLORTERM==="truecolor")return 3;if("TERM_PROGRAM"in $){let s=Number.parseInt(($.TERM_PROGRAM_VERSION||"").split(".")[0],10);switch($.TERM_PROGRAM){case"iTerm.app":return s>=3?3:2;case"Apple_Terminal":return 2}}return/-256(color)?$/i.test($.TERM)?2:/^screen|^xterm|^vt100|^vt220|^rxvt|color|ansi|cygwin|linux/i.test($.TERM)||"COLORTERM"in $?1:a}function Fr(e,t={}){let n=Fa(e,{streamIsTTY:e&&e.isTTY,...t});return Oa(n)}var La={stdout:Fr({isTTY:Or.default.isatty(1)}),stderr:Fr({isTTY:Or.default.isatty(2)})},xa=La;function Da(e,t,n){let r=e.indexOf(t);if(r===-1)return e;let i=t.length,a=0,s="";do s+=e.substr(a,r-a)+t+n,a=r+i,r=e.indexOf(t,a);while(r!==-1);return s+=e.slice(a),s}function Va(e,t,n,r){let i=0,a="";do{let s=e[r-1]==="\r";a+=e.substr(i,(s?r-1:r)-i)+t+(s?`\r
`:`
`)+n,i=r+1,r=e.indexOf(`
`,i)}while(r!==-1);return a+=e.slice(i),a}var{stdout:Lr,stderr:xr}=xa,Gn=Symbol("GENERATOR"),ot=Symbol("STYLER"),Ft=Symbol("IS_EMPTY"),Dr=["ansi","ansi","ansi256","ansi16m"],lt=Object.create(null),Ra=(e,t={})=>{if(t.level&&!(Number.isInteger(t.level)&&t.level>=0&&t.level<=3))throw new Error("The `level` option should be an integer from 0 to 3");let n=Lr?Lr.level:0;e.level=t.level===void 0?n:t.level},qa=class{constructor(e){return $r(e)}},$r=e=>{let t=(...n)=>n.join(" ");return Ra(t,e),Object.setPrototypeOf(t,Dt.prototype),t};function Dt(e){return $r(e)}Object.setPrototypeOf(Dt.prototype,Function.prototype);for(let[e,t]of Object.entries(Ee))lt[e]={get(){let n=rn(this,Bn(t.open,t.close,this[ot]),this[Ft]);return Object.defineProperty(this,e,{value:n}),n}};lt.visible={get(){let e=rn(this,this[ot],!0);return Object.defineProperty(this,"visible",{value:e}),e}};var $n=(e,t,n,...r)=>e==="rgb"?t==="ansi16m"?Ee[n].ansi16m(...r):t==="ansi256"?Ee[n].ansi256(Ee.rgbToAnsi256(...r)):Ee[n].ansi(Ee.rgbToAnsi(...r)):e==="hex"?$n("rgb",t,n,...Ee.hexToRgb(...r)):Ee[n][e](...r),Ga=["rgb","hex","ansi256"];for(let e of Ga){lt[e]={get(){let{level:n}=this;return function(...r){let i=Bn($n(e,Dr[n],"color",...r),Ee.color.close,this[ot]);return rn(this,i,this[Ft])}}};let t="bg"+e[0].toUpperCase()+e.slice(1);lt[t]={get(){let{level:n}=this;return function(...r){let i=Bn($n(e,Dr[n],"bgColor",...r),Ee.bgColor.close,this[ot]);return rn(this,i,this[Ft])}}}}var $a=Object.defineProperties(()=>{},{...lt,level:{enumerable:!0,get(){return this[Gn].level},set(e){this[Gn].level=e}}}),Bn=(e,t,n)=>{let r,i;return n===void 0?(r=e,i=t):(r=n.openAll+e,i=t+n.closeAll),{open:e,close:t,openAll:r,closeAll:i,parent:n}},rn=(e,t,n)=>{let r=(...i)=>Ba(r,i.length===1?""+i[0]:i.join(" "));return Object.setPrototypeOf(r,$a),r[Gn]=e,r[ot]=t,r[Ft]=n,r},Ba=(e,t)=>{if(e.level<=0||!t)return e[Ft]?"":t;let n=e[ot];if(n===void 0)return t;let{openAll:r,closeAll:i}=n;if(t.includes("\x1B"))for(;n!==void 0;)t=Da(t,n.close,n.open),n=n.parent;let a=t.indexOf(`
`);return a!==-1&&(t=Va(t,i,r,a)),r+t+i};Object.defineProperties(Dt.prototype,lt);var ml=Dt(),_l=Dt({level:xr?xr.level:0}),Br=require("console"),de=new qa({level:2}),en=[],P={dateFormat:"YYYY-MM-DD HH:mm:ss",ringLength:100,console:!0,timeStamp:!0},y={logFile:!1,accessFile:!1,clientFile:!1,logStream:void 0,accessStream:void 0,clientStream:void 0},oe={blank:"",continue:":     ",info:de.cyan("INFO: "),warn:de.yellow("WARN: "),data:de.green("DATA: "),error:de.red("ERROR:"),fatal:de.bold.red("FATAL:"),assert:de.italic.bold.red("ASSERT:"),timed:de.magentaBright("TIMED:"),state:de.magenta("STATE:"),verbose:de.bgGray.yellowBright("VERB: "),debug:de.bgGray.redBright("DEBUG:"),console:de.gray("CONSOLE:")},tn={showHidden:!1,depth:5,colors:!0,showProxy:!0,maxArrayLength:1024,maxStringLength:10240,breakLength:200,compact:64,sorted:!1,getters:!1},an=new Br.Console({stdout:process.stdout,stderr:process.stderr,ignoreErrors:!0,inspectOptions:tn});function Ua(e){let t="";try{t=JSON.stringify(e)}catch{}return t}function Lt(...e){let t="";for(let n of e)t+=typeof n=="object"?Ua(n):n,t+=" ";return t}function Se(...e){let t=(0,xt.default)(Date.now()).format(P.dateFormat);P.console&&(P.timeStamp?an.log(t,...e):an.log(...e))}function Ur(e){typeof e=="string"&&(P.logFile=e,y.logFile=!0,y.logStream=Ye.createWriteStream(ke.resolve(P.logFile||""),{flags:"a"}),y.logStream&&y.logStream.on("error",t=>{Se(oe.error,"Cannot open application log",P.logFile,t),y.logFile=!1}))}function Wr(e){typeof e=="string"&&(P.accessFile=e,y.accessFile=!0,y.accessStream=Ye.createWriteStream(ke.resolve(P.accessFile),{flags:"a"}),y.accessStream&&y.accessStream.on("error",t=>{Se(oe.error,"Cannot open application log",P.accessFile,t),y.accessFile=!1}))}function jr(e){typeof e=="string"&&(P.clientFile=e,y.clientFile=!0,y.clientStream=Ye.createWriteStream(ke.resolve(P.clientFile),{flags:"a"}),y.clientStream&&y.clientStream.on("error",t=>{Se(oe.error,"Cannot open application log",P.clientFile,t),y.clientFile=!1}))}async function Wa(e,...t){arguments.length<2&&(t=[e],e=process.hrtime.bigint());let n=process.hrtime.bigint(),r=0;try{r=parseInt((n-e).toString())}catch{}r=Math.round(r/1e6);let i=(0,xt.default)(Date.now()).format(P.dateFormat);P.console&&an.log(i,oe.timed,`${r.toLocaleString()} ms`,...t),y.logFile&&y.logStream&&y.logStream.write(`${oe.timed} ${i} ${r.toLocaleString()} ms ${Lt(...t)}
`)}async function J(e,...t){let n=(0,xt.default)(Date.now()).format(P.dateFormat);oe[e]?Se(oe[e],...t):Se(...t),y.logFile&&y.logStream&&y.logStream.write(`${n} ${oe[e]} ${Lt(...t)}
`),en.push({tag:e,time:n,msg:Lt(...t)}),en.length>P.ringLength&&en.shift()}async function ja(e,t,...n){e!==t&&J("assert",...n,{res:e,exp:t})}async function Ka(...e){let t=(0,xt.default)(Date.now()).format(P.dateFormat);y.accessFile&&y.accessStream&&y.accessStream.write(`${t} ${Lt(...e)}
`)}async function Ha(...e){let t=(0,xt.default)(Date.now()).format(P.dateFormat);y.clientFile&&y.clientStream&&y.clientStream.write(`${t} ${Lt(...e)}
`)}function Ya(e){!e||(e.dateFormat&&(P.dateFormat=e.dateFormat),e.ringLength&&(P.ringLength=e.ringLength),e.logFile&&Ur(e.logFile),e.accessFile&&Wr(e.accessFile),e.clientFile&&jr(e.clientFile),e.inspect&&(tn={...tn,...e.inspect}),an=new Br.Console({stdout:process.stdout,stderr:process.stderr,ignoreErrors:!0,inspectOptions:tn}))}function za(){let e="./package.json";if(!Ye.existsSync(e))return;let t=JSON.parse(Ye.readFileSync(e).toString());process.title=t.name,J("info",t.name,"version",t.version),J("info","User:",Gr.userInfo().username,"Platform:",process.platform,"Arch:",process.arch,"Node:",process.version),P.logFile&&y.logFile&&Se(oe.state,"Application log:",ke.resolve(P.logFile)),P.accessFile&&y.accessFile&&Se(oe.state,"Access log:",ke.resolve(P.accessFile)),P.clientFile&&y.clientFile&&Se(oe.state,"Client log:",ke.resolve(P.clientFile))}function Xa(){let e="./package.json";if(!Ye.existsSync(e))return;let t=JSON.parse(Ye.readFileSync(e).toString());process.title=t.name,J("info",{application:t.name,version:t.version}),J("info",{user:Gr.userInfo().username,platform:process.platform,arch:process.arch,node:process.version}),(P.logFile||P.accessFile||P.clientFile)&&Se(oe.state,{log:ke.resolve(P.logFile||""),access:ke.resolve(P.accessFile||""),client:ke.resolve(P.clientFile||"")})}var Qa=(...e)=>J("blank",...e),Ja=(...e)=>J("info",...e),Za=(...e)=>J("state",...e),es=(...e)=>J("data",...e),ts=(...e)=>J("warn",...e),ns=(...e)=>J("error",...e),rs=(...e)=>J("fatal",...e),is=(...e)=>J("verbose",...e),as=(...e)=>J("debug",...e),ss=(...e)=>J("console",...e)});var Me=x(Vt=>{"use strict";Object.defineProperty(Vt,"__esModule",{value:!0});Vt.i18n=void 0;var os;(function(e){e.WRONG_NUMBER_OF_FEN_FIELDS="A FEN string must contain exactly 6 space-separated fields.",e.WRONG_NUMBER_OF_SUBFIELDS_IN_BOARD_FIELD="The 1st field of a FEN string must contain exactly 8 `/`-separated subfields.",e.UNEXPECTED_CHARACTER_IN_BOARD_FIELD="Unexpected character in the 1st field of the FEN string: `{0}`.",e.UNEXPECTED_END_OF_SUBFIELD_IN_BOARD_FIELD="Subfield {0} of the FEN string 1st field is unexpectedly short.",e.INVALID_TURN_FIELD="The 2nd field of a FEN string must be either `w` or `b`.",e.INVALID_CASTLING_FIELD="The 3rd field of a FEN string must be either `-` or a list of characters among `K`, `Q`, `k` and `q` (in this order).",e.INVALID_EN_PASSANT_FIELD="The 4th field of a FEN string must be either `-` or a square from the 3rd or 6th rank where en-passant is allowed.",e.WRONG_RANK_IN_EN_PASSANT_FIELD="The rank number indicated in the FEN string 4th field is inconsistent with respect to the 2nd field.",e.INEFFECTIVE_EN_PASSANT_FIELD="No en-passant capture can happen on file {0} in the position defined in the FEN string.",e.INVALID_HALF_MOVE_COUNT_FIELD="The 5th field of a FEN string must be a number, indicating the number of half-move since the last pawn move or capture.",e.INVALID_MOVE_NUMBER_FIELD="The 6th field of a FEN string must be a number, indicating the move number of the game.",e.INVALID_VARIANT_PREFIX="Invalid variant prefix: `{0}`.",e.INVALID_UCI_NOTATION_SYNTAX="The syntax of the UCI notation is invalid.",e.ILLEGAL_UCI_MOVE="The UCI move is not legal.",e.INVALID_MOVE_NOTATION_SYNTAX="The syntax of the move notation is invalid.",e.ILLEGAL_POSITION="The position is not legal.",e.ILLEGAL_NO_KING_CASTLING="Castling is not legal in the considered position as it has no king.",e.ILLEGAL_QUEEN_SIDE_CASTLING="Queen-side castling is not legal in the considered position.",e.ILLEGAL_KING_SIDE_CASTLING="King-side castling is not legal in the considered position.",e.NO_PIECE_CAN_MOVE_TO="No {0} can move to {1}.",e.NO_PIECE_CAN_MOVE_TO_DISAMBIGUATION="No {0} on the specified rank/file can move to {1}.",e.REQUIRE_DISAMBIGUATION="Cannot determine uniquely which {0} is supposed to move to {1}.",e.WRONG_DISAMBIGUATION_SYMBOL="Wrong disambiguation symbol (expected: `{0}`, observed: `{1}`).",e.CASTLING_MOVE_ENCODED_WITH_ZERO="Capital O must be used for castling moves (instead of digit 0).",e.TRYING_TO_CAPTURE_YOUR_OWN_PIECES="Capturing its own pieces is not legal.",e.CAPTURE_IS_MANDATORY="Capture is mandatory.",e.INVALID_PIECE_SYMBOL="Character `{0}` is not a valid piece symbol.",e.INVALID_PIECE_SYMBOL_COLOR="Invalid color for piece symbol `{0}`.",e.INVALID_CAPTURING_PAWN_MOVE="Invalid capturing pawn move.",e.INVALID_NON_CAPTURING_PAWN_MOVE="Invalid non-capturing pawn move.",e.NOT_SAFE_FOR_WHITE_KING="This move would let the white king in check.",e.NOT_SAFE_FOR_BLACK_KING="This move would let the black king in check.",e.MISSING_PROMOTION="A promoted piece must be specified for this move.",e.MISSING_PROMOTION_SYMBOL="Character `=` is required to specify a promoted piece.",e.INVALID_PROMOTED_PIECE="{0} cannot be specified as a promoted piece.",e.ILLEGAL_PROMOTION="Specifying a promoted piece is illegal for this move.",e.ILLEGAL_NULL_MOVE="Cannot play a null-move in this position.",e.MISSING_CAPTURE_SYMBOL="Capture symbol `x` is missing.",e.INVALID_CAPTURE_SYMBOL="This move is not a capture move.",e.WRONG_CHECK_CHECKMATE_SYMBOL="Wrong check/checkmate symbol (expected: `{0}`, observed: `{1}`).",e.INVALID_PGN_TOKEN="Unrecognized character or group of characters.",e.INVALID_MOVE_IN_PGN_TEXT="Invalid move ({0}). {1}",e.INVALID_FEN_IN_PGN_TEXT="Invalid FEN string in the initial position header. {0}",e.UNEXPECTED_PGN_HEADER="Unexpected PGN game header.",e.MISSING_PGN_HEADER_ID="Missing or invalid PGN game header ID.",e.MISSING_PGN_HEADER_VALUE="Missing or invalid PGN game header value.",e.MISSING_END_OF_PGN_HEADER="Missing or invalid end of PGN game header.",e.UNEXPECTED_BEGIN_OF_VARIATION="Unexpected begin of variation.",e.UNEXPECTED_END_OF_VARIATION="Unexpected end of variation.",e.UNEXPECTED_END_OF_GAME="Unexpected end of game: there are pending variations.",e.UNEXPECTED_END_OF_TEXT="Unexpected end of text: there is a pending game.",e.INVALID_GAME_INDEX="Game index {0} is invalid (only {1} game(s) found in the PGN data).",e.UNKNOWN_VARIANT="Unknown chess game variant ({0}).",e.VARIANT_WITHOUT_FEN="For game variant {0}, the FEN header is mandatory."})(os=Vt.i18n||(Vt.i18n={}))});var Z=x(Pe=>{"use strict";Object.defineProperty(Pe,"__esModule",{value:!0});Pe.InvalidPGN=Pe.InvalidNotation=Pe.InvalidFEN=Pe.IllegalArgument=void 0;var jn=class{constructor(t){this.functionName=t}toString(){return`Illegal argument in function ${this.functionName}`}};Pe.IllegalArgument=jn;var Kn=class{constructor(t,n,...r){this.fen=t,this.message=zn(n,r)}toString(){return Xn("InvalidFEN",this.message)}};Pe.InvalidFEN=Kn;var Hn=class{constructor(t,n,r,...i){this.fen=t,this.notation=n,this.message=zn(r,i)}toString(){return Xn("InvalidNotation",this.message)}};Pe.InvalidNotation=Hn;var Yn=class{constructor(t,n,r,i,...a){this.pgn=t,this.index=n,this.lineNumber=r,this.message=zn(i,a)}toString(){return Xn("InvalidPGN",`[character=${this.index} line=${this.lineNumber}] ${this.message}`)}};Pe.InvalidPGN=Yn;function zn(e,t){return e.replace(/{(\d+)}/g,(n,r)=>{let i=Number(r);return i<t.length?t[i]:n})}function Xn(e,t){return e+" -> "+t}});var Ve=x(w=>{"use strict";Object.defineProperty(w,"__esModule",{value:!0});w.coloredPieceFromString=w.coloredPieceToString=w.squareFromString=w.squareToString=w.variantFromString=w.resultFromString=w.fileFromString=w.rankFromString=w.figurineFromString=w.pieceFromString=w.colorFromString=w.variantToString=w.resultToString=w.fileToString=w.rankToString=w.figurineToString=w.pieceToString=w.colorToString=void 0;var on=[..."wb"],ln=[..."kqrbnp"],Hr=[..."\u2654\u265A\u2655\u265B\u2656\u265C\u2657\u265D\u2658\u265E\u2659\u265F"],un=[..."12345678"],fn=[..."abcdefgh"],Yr=["1-0","0-1","1/2-1/2","*"],zr=["regular","chess960","no-king","white-king-only","black-king-only","antichess","horde"];function ls(e){return on[e]}w.colorToString=ls;function us(e){return ln[e]}w.pieceToString=us;function fs(e){return Hr[e]}w.figurineToString=fs;function cs(e){return un[e]}w.rankToString=cs;function hs(e){return fn[e]}w.fileToString=hs;function ds(e){return Yr[e]}w.resultToString=ds;function gs(e){return zr[e]}w.variantToString=gs;function ms(e){return on.indexOf(e)}w.colorFromString=ms;function _s(e){return ln.indexOf(e)}w.pieceFromString=_s;function vs(e){return Hr.indexOf(e)}w.figurineFromString=vs;function ps(e){return un.indexOf(e)}w.rankFromString=ps;function Is(e){return fn.indexOf(e)}w.fileFromString=Is;function Ns(e){return Yr.indexOf(e)}w.resultFromString=Ns;function bs(e){return zr.indexOf(e)}w.variantFromString=bs;function ws(e){return fn[e%16]+un[Math.trunc(e/16)]}w.squareToString=ws;function Es(e){if(typeof e!="string"||!/^[a-h][1-8]$/.test(e))return-1;let t=fn.indexOf(e[0]);return un.indexOf(e[1])*16+t}w.squareFromString=Es;function Ss(e){return on[e%2]+ln[Math.trunc(e/2)]}w.coloredPieceToString=Ss;function Ps(e){if(typeof e!="string"||!/^[wb][kqrbnp]$/.test(e))return-1;let t=on.indexOf(e[0]);return ln.indexOf(e[1])*2+t}w.coloredPieceFromString=Ps});var Rt=x(ue=>{"use strict";Object.defineProperty(ue,"__esModule",{value:!0});ue.makeCopy=ue.make960FromScharnagl=ue.makeInitial=ue.makeEmpty=ue.hasCanonicalStartPosition=void 0;var Cs=[-1,-1,-1,-1,-1,-1,-1,-1,-2,-2,-2,-2,-2,-2,-2,-2,-1,-1,-1,-1,-1,-1,-1,-1,-2,-2,-2,-2,-2,-2,-2,-2,-1,-1,-1,-1,-1,-1,-1,-1,-2,-2,-2,-2,-2,-2,-2,-2,-1,-1,-1,-1,-1,-1,-1,-1,-2,-2,-2,-2,-2,-2,-2,-2,-1,-1,-1,-1,-1,-1,-1,-1,-2,-2,-2,-2,-2,-2,-2,-2,-1,-1,-1,-1,-1,-1,-1,-1,-2,-2,-2,-2,-2,-2,-2,-2,-1,-1,-1,-1,-1,-1,-1,-1,-2,-2,-2,-2,-2,-2,-2,-2,-1,-1,-1,-1,-1,-1,-1,-1],Xr=[4,8,6,2,0,6,8,4,-2,-2,-2,-2,-2,-2,-2,-2,10,10,10,10,10,10,10,10,-2,-2,-2,-2,-2,-2,-2,-2,-1,-1,-1,-1,-1,-1,-1,-1,-2,-2,-2,-2,-2,-2,-2,-2,-1,-1,-1,-1,-1,-1,-1,-1,-2,-2,-2,-2,-2,-2,-2,-2,-1,-1,-1,-1,-1,-1,-1,-1,-2,-2,-2,-2,-2,-2,-2,-2,-1,-1,-1,-1,-1,-1,-1,-1,-2,-2,-2,-2,-2,-2,-2,-2,11,11,11,11,11,11,11,11,-2,-2,-2,-2,-2,-2,-2,-2,5,9,7,3,1,7,9,5],As=[10,10,10,10,10,10,10,10,-2,-2,-2,-2,-2,-2,-2,-2,10,10,10,10,10,10,10,10,-2,-2,-2,-2,-2,-2,-2,-2,10,10,10,10,10,10,10,10,-2,-2,-2,-2,-2,-2,-2,-2,10,10,10,10,10,10,10,10,-2,-2,-2,-2,-2,-2,-2,-2,-1,10,10,-1,-1,10,10,-1,-2,-2,-2,-2,-2,-2,-2,-2,-1,-1,-1,-1,-1,-1,-1,-1,-2,-2,-2,-2,-2,-2,-2,-2,11,11,11,11,11,11,11,11,-2,-2,-2,-2,-2,-2,-2,-2,5,9,7,3,1,7,9,5],Qr=[{board:Xr,castling:[129,129],king:[4,116]},null,null,null,null,{board:Xr,castling:[0,0],king:[-1,-1]},{board:As,castling:[0,129],king:[-1,116]}];function ys(e){return Qr[e]!==null}ue.hasCanonicalStartPosition=ys;function Ts(e){return{board:Cs.slice(),turn:0,castling:[0,0],enPassant:-1,variant:e,legal:e===2,king:[-1,-1],effectiveCastling:[0,0],effectiveEnPassant:-1}}ue.makeEmpty=Ts;function ks(e){let t=Qr[e];return{board:t.board.slice(),turn:0,castling:t.castling.slice(),enPassant:-1,variant:e,legal:!0,king:t.king.slice(),effectiveCastling:t.castling.slice(),effectiveEnPassant:-1}}ue.makeInitial=ks;function Ms(e){let t=Os(e),n=t.pieceScheme.map(i=>i*2+0),r=t.pieceScheme.map(i=>i*2+1);return{board:[n[0],n[1],n[2],n[3],n[4],n[5],n[6],n[7],-2,-2,-2,-2,-2,-2,-2,-2,10,10,10,10,10,10,10,10,-2,-2,-2,-2,-2,-2,-2,-2,-1,-1,-1,-1,-1,-1,-1,-1,-2,-2,-2,-2,-2,-2,-2,-2,-1,-1,-1,-1,-1,-1,-1,-1,-2,-2,-2,-2,-2,-2,-2,-2,-1,-1,-1,-1,-1,-1,-1,-1,-2,-2,-2,-2,-2,-2,-2,-2,-1,-1,-1,-1,-1,-1,-1,-1,-2,-2,-2,-2,-2,-2,-2,-2,11,11,11,11,11,11,11,11,-2,-2,-2,-2,-2,-2,-2,-2,r[0],r[1],r[2],r[3],r[4],r[5],r[6],r[7]],turn:0,castling:[t.castling,t.castling],enPassant:-1,variant:1,legal:!0,king:[0+t.kingFile,112+t.kingFile],effectiveCastling:[t.castling,t.castling],effectiveEnPassant:-1}}ue.make960FromScharnagl=Ms;function Os(e){let t=[-1,-1,-1,-1,-1,-1,-1,-1],n=0,r=-1;function i(s){let o=0;for(let l=0;l<8;++l)t[l]>=0||(s(l,o),++o)}function a(s,o,l){i((u,d)=>{(d===o||d===l)&&(t[u]=s)})}switch(t[e%4*2+1]=3,e=Math.trunc(e/4),t[e%4*2]=3,e=Math.trunc(e/4),a(1,e%6,-1),e=Math.trunc(e/6),e){case 0:a(4,0,1);break;case 1:a(4,0,2);break;case 2:a(4,0,3);break;case 3:a(4,0,4);break;case 4:a(4,1,2);break;case 5:a(4,1,3);break;case 6:a(4,1,4);break;case 7:a(4,2,3);break;case 8:a(4,2,4);break;case 9:a(4,3,4);break}return i((s,o)=>{o===1?(t[s]=0,r=s):(t[s]=2,n|=1<<s)}),{pieceScheme:t,castling:n,kingFile:r}}function Fs(e){return{board:e.board.slice(),turn:e.turn,castling:e.castling.slice(),enPassant:e.enPassant,variant:e.variant,legal:e.legal,king:e.king.slice(),effectiveCastling:e.effectiveCastling===null?null:e.effectiveCastling.slice(),effectiveEnPassant:e.effectiveEnPassant}}ue.makeCopy=Fs});var qt=x(H=>{"use strict";Object.defineProperty(H,"__esModule",{value:!0});H.isValidECO=H.nagSymbol=H.variantWithCanonicalStartPosition=H.oppositeColor=H.coordinatesToSquare=H.squareToCoordinates=H.squareColor=H.forEachSquare=void 0;var ut=Z(),Re=Ve(),Ls=Rt();function xs(e){for(let t=0;t<8;++t)for(let n=0;n<8;++n)e((0,Re.squareToString)(t*16+n))}H.forEachSquare=xs;function Ds(e){let t=(0,Re.squareFromString)(e);if(t<0)throw new ut.IllegalArgument("squareColor()");return Math.trunc(t/16)%2===t%2?"b":"w"}H.squareColor=Ds;function Vs(e){let t=(0,Re.squareFromString)(e);if(t<0)throw new ut.IllegalArgument("squareToCoordinates()");return{rank:Math.trunc(t/16),file:t%16}}H.squareToCoordinates=Vs;function Rs(e,t){let n=typeof e=="number"?e:e.file,r=typeof e=="number"?t:e.rank;if(!Number.isInteger(n)||!Number.isInteger(r)||n<0||n>=8||r<0||r>=8)throw new ut.IllegalArgument("coordinatesToSquare()");return(0,Re.fileToString)(n)+(0,Re.rankToString)(r)}H.coordinatesToSquare=Rs;function qs(e){let t=(0,Re.colorFromString)(e);if(t<0)throw new ut.IllegalArgument("oppositeColor()");return(0,Re.colorToString)(1-t)}H.oppositeColor=qs;function Gs(e){let t=(0,Re.variantFromString)(e);if(t<0)throw new ut.IllegalArgument("variantWithCanonicalStartPosition()");return(0,Ls.hasCanonicalStartPosition)(t)}H.variantWithCanonicalStartPosition=Gs;var T=new Map;T.set(1,"!");T.set(2,"?");T.set(3,"!!");T.set(4,"??");T.set(5,"!?");T.set(6,"?!");T.set(7,"\u25A1");T.set(8,"\u25A1");T.set(10,"=");T.set(11,"=");T.set(13,"\u221E");T.set(14,"\u2A72");T.set(15,"\u2A71");T.set(16,"\xB1");T.set(17,"\u2213");T.set(18,"+\u2212");T.set(19,"\u2212+");T.set(22,"\u2A00");T.set(32,"\u27F3");T.set(36,"\u2191");T.set(40,"\u2192");T.set(132,"\u21C6");T.set(138,"\u2A01");T.set(140,"\u2206");T.set(141,"\u2207");T.set(142,"\u2313");T.set(143,"\u2264");T.set(145,"RR");T.set(146,"N");function $s(e){if(!Number.isInteger(e)||e<0)throw new ut.IllegalArgument("nagSymbol()");let t=T.get(e);return t===void 0?"$"+e:t}H.nagSymbol=$s;function Bs(e){return/^[A-E][0-9][0-9]$/.test(e)}H.isValidECO=Bs});var cn=x(Ge=>{"use strict";var qe=Ge&&Ge.__classPrivateFieldSet||function(e,t,n,r,i){if(r==="m")throw new TypeError("Private method is not writable");if(r==="a"&&!i)throw new TypeError("Private accessor was defined without a setter");if(typeof t=="function"?e!==t||!i:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return r==="a"?i.call(e,n):i?i.value=n:t.set(e,n),n},V=Ge&&Ge.__classPrivateFieldGet||function(e,t,n,r){if(n==="a"&&!r)throw new TypeError("Private accessor was defined without a getter");if(typeof t=="function"?e!==t||!r:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return n==="m"?r:n==="a"?r.call(e):r?r.value:t.get(e)},ft,ge,fe,me;Object.defineProperty(Ge,"__esModule",{value:!0});Ge.DateValue=void 0;var Qn=Z(),Zn=class{constructor(t,n,r){if(ft.set(this,void 0),ge.set(this,void 0),fe.set(this,void 0),me.set(this,void 0),t instanceof Date)qe(this,ft,"ymd","f"),qe(this,ge,t.getFullYear(),"f"),qe(this,fe,t.getMonth()+1,"f"),qe(this,me,t.getDate(),"f");else{let i=Zr(t,n,r);if(!i)throw new Qn.IllegalArgument("DateValue()");qe(this,ft,i,"f"),qe(this,ge,t,"f"),qe(this,fe,n===null?void 0:n,"f"),qe(this,me,r===null?void 0:r,"f")}}type(){return V(this,ft,"f")}year(){return V(this,ge,"f")}month(){if(V(this,fe,"f")===void 0)throw new Qn.IllegalArgument("DateValue.month()");return V(this,fe,"f")}day(){if(V(this,me,"f")===void 0)throw new Qn.IllegalArgument("DateValue.day()");return V(this,me,"f")}toDate(){let t=V(this,fe,"f")===void 0?0:V(this,fe,"f")-1,n=V(this,me,"f")===void 0?1:V(this,me,"f");return new Date(V(this,ge,"f"),t,n)}toString(){return Jr(V(this,ge,"f"),V(this,fe,"f"),V(this,me,"f"),"-","**")}toPGNString(){return Jr(V(this,ge,"f"),V(this,fe,"f"),V(this,me,"f"),".","??")}toHumanReadableString(t){switch(V(this,ft,"f")){case"ymd":{let n=new Date(V(this,ge,"f"),V(this,fe,"f")-1,V(this,me,"f"));return new Intl.DateTimeFormat(t,{dateStyle:"long"}).format(n)}case"ym":{let n=new Date(V(this,ge,"f"),V(this,fe,"f")-1,1);return new Intl.DateTimeFormat(t,{month:"long",year:"numeric"}).format(n)}default:return String(V(this,ge,"f"))}}static isValid(t,n,r){return Boolean(Zr(t,n,r))}};Ge.DateValue=Zn;ft=new WeakMap,ge=new WeakMap,fe=new WeakMap,me=new WeakMap;function Jr(e,t,n,r,i){let a=String(e).padStart(4,"0"),s=t===void 0?i:String(t).padStart(2,"0"),o=n===void 0?i:String(n).padStart(2,"0");return a+r+s+r+o}function Zr(e,t,n){return n!=null?Jn(e)&&ei(t)&&Number.isInteger(n)&&n>=1&&n<=Us(e,t)?"ymd":!1:t!=null?Jn(e)&&ei(t)?"ym":!1:Jn(e)?"y":!1}function Jn(e){return Number.isInteger(e)&&e>=0}function ei(e){return Number.isInteger(e)&&e>=1&&e<=12}function Us(e,t){return new Date(e,t,0).getDate()}});var er=x(ct=>{"use strict";Object.defineProperty(ct,"__esModule",{value:!0});ct.isMoveDescriptor=ct.MoveDescriptor=void 0;var hn=class{constructor(){}toString(){let t=this.from()+this.to();return this.isPromotion()?t+=this.promotion().toUpperCase():this.isCastling()&&(t+="O"),t}};ct.MoveDescriptor=hn;function Ws(e){return e instanceof hn}ct.isMoveDescriptor=Ws});var Gt=x(ce=>{"use strict";Object.defineProperty(ce,"__esModule",{value:!0});ce.getAttacks=ce.isAttacked=ce.ATTACK_DIRECTIONS=void 0;ce.ATTACK_DIRECTIONS=[[-17,-16,-15,-1,1,15,16,17],[-17,-16,-15,-1,1,15,16,17],[-17,-16,-15,-1,1,15,16,17],[-17,-16,-15,-1,1,15,16,17],[-16,-1,1,16],[-16,-1,1,16],[-17,-15,15,17],[-17,-15,15,17],[-33,-31,-18,-14,14,18,31,33],[-33,-31,-18,-14,14,18,31,33],[15,17],[-17,-15]];function js(e,t,n){return tr(e,t,0*2+n)||tr(e,t,4*2+n)||tr(e,t,5*2+n)||ti(e,t,2*2+n,1*2+n)||ti(e,t,3*2+n,1*2+n)}ce.isAttacked=js;function tr(e,t,n){let r=ce.ATTACK_DIRECTIONS[n];for(let i=0;i<r.length;++i){let a=t-r[i];if((a&136)===0&&e.board[a]===n)return!0}return!1}function ti(e,t,n,r){let i=ce.ATTACK_DIRECTIONS[n];for(let a=0;a<i.length;++a){let s=t;for(;;){if(s-=i[a],(s&136)===0){let o=e.board[s];if(o===-1)continue;if(o===n||o===r)return!0}break}}return!1}function Ks(e,t,n){let r=[];return nr(e,t,r,0*2+n),nr(e,t,r,4*2+n),nr(e,t,r,5*2+n),ni(e,t,r,2*2+n,1*2+n),ni(e,t,r,3*2+n,1*2+n),r}ce.getAttacks=Ks;function nr(e,t,n,r){let i=ce.ATTACK_DIRECTIONS[r];for(let a=0;a<i.length;++a){let s=t-i[a];(s&136)===0&&e.board[s]===r&&n.push(s)}}function ni(e,t,n,r,i){let a=ce.ATTACK_DIRECTIONS[r];for(let s=0;s<a.length;++s){let o=t;for(;;){if(o-=a[s],(o&136)===0){let l=e.board[o];if(l===-1)continue;(l===r||l===i)&&n.push(o)}break}}}});var ht=x(ae=>{"use strict";Object.defineProperty(ae,"__esModule",{value:!0});ae.isEqual=ae.refreshEffectiveEnPassant=ae.refreshEffectiveCastling=ae.isKingSafeAfterMove=ae.refreshLegalFlagAndKingSquares=ae.isLegal=void 0;var oi=Gt();function Hs(e){return dn(e),e.legal}ae.isLegal=Hs;function dn(e){if(e.legal!==null)return;e.legal=!1;let t=ri(e,0),n=ri(e,1);if(!t||!n)return;if(e.variant===5){if(!ii(e,1-e.turn))return}else if(e.variant===6&&e.turn===1&&!ii(e,0))return;if(e.king[1-e.turn]>=0&&(0,oi.isAttacked)(e,e.king[1-e.turn],e.turn))return;let r=e.variant===6?-2:10;for(let i=0;i<8;++i){let a=e.board[0+i],s=e.board[112+i];if(a===r||s===10||a===11||s===11)return}e.legal=!0}ae.refreshLegalFlagAndKingSquares=dn;function ri(e,t){let n=0+t;if(e.king[t]=-1,e.variant===5)return!0;if(e.variant===2||e.variant===4-t||e.variant===6&&t===0){for(let r=0;r<120;r+=(r&7)===7?9:1)if(e.board[r]===n)return!1;return!0}else{for(let r=0;r<120;r+=(r&7)===7?9:1)if(e.board[r]===n)if(e.king[t]<0)e.king[t]=r;else return e.king[t]=-1,!1;return e.king[t]>=0}}function ii(e,t){for(let n=0;n<120;n+=(n&7)===7?9:1)if(e.board[n]!==-1&&e.board[n]%2===t)return!0;return!1}function rr(e,t,n,r=-1){if(e.king[e.turn]<0)return!0;let i=e.board[t],a=e.board[n],s=Math.trunc(i/2);e.board[n]=i,e.board[t]=-1,r>=0&&(e.board[r]=-1);try{return!(0,oi.isAttacked)(e,s===0?n:e.king[e.turn],1-e.turn)}finally{e.board[t]=i,e.board[n]=a,r>=0&&(e.board[r]=5*2+1-e.turn)}}ae.isKingSafeAfterMove=rr;function ir(e){e.effectiveCastling===null&&(dn(e),e.effectiveCastling=e.variant===1?[si(e,0),si(e,1)]:[ai(e,0),ai(e,1)])}ae.refreshEffectiveCastling=ir;function ai(e,t){let n=112*t;if(e.king[t]!==n+4||e.castling[t]===0)return 0;let r=2*2+t,i=0;return(e.castling[t]&1)!==0&&e.board[n]===r&&(i|=1),(e.castling[t]&128)!==0&&e.board[n+7]===r&&(i|=128),i}function si(e,t){let n=112*t;if(e.king[t]<=n||e.king[t]>=n+7||e.castling[t]===0)return 0;let r=2*2+t,i=0,a=-1;for(let o=e.king[t]%16-1;o>=0;--o)if(!((e.castling[t]&1<<o)===0||e.board[n+o]!==r))if(a<0)a=o;else{a=-1;break}a>=0&&(i|=1<<a);let s=-1;for(let o=e.king[t]%16+1;o<8;++o)if(!((e.castling[t]&1<<o)===0||e.board[n+o]!==r))if(s<0)s=o;else{s=-1;break}return s>=0&&(i|=1<<s),i}function ar(e){if(e.effectiveEnPassant!==null||(e.effectiveEnPassant=-1,e.enPassant<0))return;let t=(6-e.turn*5)*16+e.enPassant,n=(5-e.turn*3)*16+e.enPassant,r=(4-e.turn)*16+e.enPassant,i=5*2+e.turn,a=5*2+1-e.turn;if(e.board[t]!==-1||e.board[n]!==-1||e.board[r]!==a)return;let s=(r-1&136)===0&&e.board[r-1]===i,o=(r+1&136)===0&&e.board[r+1]===i;!s&&!o||(dn(e),!(!(s&&rr(e,r-1,n,r))&&!(o&&rr(e,r+1,n,r)))&&(e.effectiveEnPassant=e.enPassant))}ae.refreshEffectiveEnPassant=ar;function Ys(e,t){if(e.turn!==t.turn||e.variant!==t.variant)return!1;for(let n=0;n<120;n+=(n&7)===7?9:1)if(e.board[n]!==t.board[n])return!1;return ir(e),ir(t),e.effectiveCastling[0]!==t.effectiveCastling[0]||e.effectiveCastling[1]!==t.effectiveCastling[1]?!1:(ar(e),ar(t),e.effectiveEnPassant===t.effectiveEnPassant)}ae.isEqual=Ys});var gn=x($e=>{"use strict";Object.defineProperty($e,"__esModule",{value:!0});$e.parseFEN=$e.getFEN=$e.ascii=void 0;var Ce=Ve(),zs=Rt(),sr=ht(),_e=Z(),ve=Me(),or=[..."KkQqRrBbNnPp"],ui=["6","3"];function Xs(e){let t=`+---+---+---+---+---+---+---+---+
`;for(let n=7;n>=0;--n){for(let r=0;r<8;++r){let i=e.board[n*16+r];t+="| "+(i===-1?" ":or[i])+" "}t+=`|
`,t+=`+---+---+---+---+---+---+---+---+
`}return t+=(0,Ce.colorToString)(e.turn)+" "+fi(e)+" "+ci(e),e.variant!==0&&(t+=" ("+(0,Ce.variantToString)(e.variant)+")"),t}$e.ascii=Xs;function Qs(e,t=0,n=1,r=!1){let i="";for(let a=7;a>=0;--a){let s=0;for(let o=0;o<8;++o){let l=e.board[a*16+o];l===-1?++s:(s>0&&(i+=s,s=0),i+=or[l])}s>0&&(i+=s),a>0&&(i+="/")}return i+=" "+(0,Ce.colorToString)(e.turn)+" "+fi(e,r)+" "+ci(e),i+=" "+t+" "+n,i}$e.getFEN=Qs;function fi(e,t=!1){if((0,sr.refreshEffectiveCastling)(e),e.variant===1){if(t){let i=li(e,0),a=li(e,1);if(i!==!1&&a!==!1)return i===""&&a===""?"-":i.toUpperCase()+a}let n="",r="";for(let i=0;i<8;++i)e.effectiveCastling[0]&1<<i&&(n+=(0,Ce.fileToString)(i)),e.effectiveCastling[1]&1<<i&&(r+=(0,Ce.fileToString)(i));return n===""&&r===""?"-":n.toUpperCase()+r}else{let n="";return e.effectiveCastling[0]&128&&(n+="K"),e.effectiveCastling[0]&1&&(n+="Q"),e.effectiveCastling[1]&128&&(n+="k"),e.effectiveCastling[1]&1&&(n+="q"),n===""?"-":n}}function li(e,t){let n=1<<e.king[t]%16,r=e.effectiveCastling[t]&~(n|n-1),i=e.effectiveCastling[t]&n-1,a="",s=112*t,o=112*t+7,l=2*2+t;if(r!==0){let u=!1;for(let d=e.king[t]+1;d<=o;++d)if(e.board[d]===l){if(u)return!1;u=!0}a+="k"}if(i!==0){let u=!1;for(let d=e.king[t]-1;d>=s;--d)if(e.board[d]===l){if(u)return!1;u=!0}a+="q"}return a}function ci(e){return(0,sr.refreshEffectiveEnPassant)(e),e.effectiveEnPassant<0?"-":(0,Ce.fileToString)(e.effectiveEnPassant)+ui[e.turn]}function Js(e,t,n){let r=n?t.split(" "):t.replace(/^\s+|\s+$/g,"").split(/\s+/);if(r.length!==6)throw new _e.InvalidFEN(t,ve.i18n.WRONG_NUMBER_OF_FEN_FIELDS);let i=r[0].split("/");if(i.length!==8)throw new _e.InvalidFEN(t,ve.i18n.WRONG_NUMBER_OF_SUBFIELDS_IN_BOARD_FIELD);let a=(0,zs.makeEmpty)(e);a.legal=null,a.effectiveCastling=null,a.effectiveEnPassant=null;for(let u=7;u>=0;--u){let d=i[7-u],c=0,m=0;for(;c<d.length&&m<8;){let _=d[c],E=or.indexOf(_);if(/^[1-8]$/.test(_))m+=parseInt(_,10);else if(E>=0)a.board[u*16+m]=E,++m;else throw new _e.InvalidFEN(t,ve.i18n.UNEXPECTED_CHARACTER_IN_BOARD_FIELD,_);++c}if(c!==d.length||m!==8)throw new _e.InvalidFEN(t,ve.i18n.UNEXPECTED_END_OF_SUBFIELD_IN_BOARD_FIELD,8-u)}if(a.turn=(0,Ce.colorFromString)(r[1]),a.turn<0)throw new _e.InvalidFEN(t,ve.i18n.INVALID_TURN_FIELD);let s=e===1?eo(r[2],n,a.board):Zs(r[2],n);if(s===null)throw new _e.InvalidFEN(t,ve.i18n.INVALID_CASTLING_FIELD);a.castling=s;let o=r[3];if(o!=="-"){if(!/^[a-h][36]$/.test(o))throw new _e.InvalidFEN(t,ve.i18n.INVALID_EN_PASSANT_FIELD);if(a.enPassant=(0,Ce.fileFromString)(o[0]),n){if(o[1]!==ui[a.turn])throw new _e.InvalidFEN(t,ve.i18n.WRONG_RANK_IN_EN_PASSANT_FIELD);if((0,sr.refreshEffectiveEnPassant)(a),a.enPassant!==a.effectiveEnPassant)throw new _e.InvalidFEN(t,ve.i18n.INEFFECTIVE_EN_PASSANT_FIELD,(0,Ce.fileToString)(a.enPassant))}}let l=n?/^(?:0|[1-9][0-9]*)$/:/^[0-9]+$/;if(!l.test(r[4]))throw new _e.InvalidFEN(t,ve.i18n.INVALID_HALF_MOVE_COUNT_FIELD);if(!l.test(r[5]))throw new _e.InvalidFEN(t,ve.i18n.INVALID_MOVE_NUMBER_FIELD);return{position:a,fiftyMoveClock:parseInt(r[4],10),fullMoveNumber:parseInt(r[5],10)}}$e.parseFEN=Js;function Zs(e,t){let n=[0,0];return e==="-"?n:(t?/^K?Q?k?q?$/:/^[KQkq]*$/).test(e)?(e.indexOf("K")>=0&&(n[0]|=1<<7),e.indexOf("Q")>=0&&(n[0]|=1<<0),e.indexOf("k")>=0&&(n[1]|=1<<7),e.indexOf("q")>=0&&(n[1]|=1<<0),n):null}function eo(e,t,n){let r=[0,0];if(e==="-")return r;if(!(t?/^[A-H]{0,2}[a-h]{0,2}$/:/^[A-Ha-h]*|[KQkq]*$/).test(e))return null;function i(s){let o=4+s,l=0*2+s;for(let u=112*s;u<112*s+8;++u){if(n[u]===o)return u%8;if(n[u]===l)break}return 0}function a(s){let o=4+s,l=0*2+s;for(let u=112*s+7;u>=112*s;--u){if(n[u]===o)return u%8;if(n[u]===l)break}return 7}t||(e.indexOf("K")>=0&&(r[0]|=1<<a(0)),e.indexOf("Q")>=0&&(r[0]|=1<<i(0)),e.indexOf("k")>=0&&(r[1]|=1<<a(1)),e.indexOf("q")>=0&&(r[1]|=1<<i(1)));for(let s=0;s<8;++s){let o=(0,Ce.fileToString)(s);e.indexOf(o.toUpperCase())>=0&&(r[0]|=1<<s),e.indexOf(o)>=0&&(r[1]|=1<<s)}return r}});var vn=x(_n=>{"use strict";Object.defineProperty(_n,"__esModule",{value:!0});_n.MoveDescriptorImpl=void 0;var he=Ve(),Xe=Z(),to=er(),hi=1,di=2,mn=4,gi=8,Be=class extends to.MoveDescriptor{constructor(t,n,r,i,a,s,o,l){super(),this._flags=t,this._from=n,this._to=r,this._movingColoredPiece=i,this._finalColoredPiece=a,this._optionalColoredPiece=s,this._optionalSquare1=o,this._optionalSquare2=l}static make(t,n,r,i){let a=i===-1?0:mn;return new Be(a,t,n,r,r,i,-1,-1)}static makeCastling(t,n,r,i,a){let s=0+a,o=2*2+a;return new Be(hi,t,n,s,s,o,r,i)}static makeEnPassant(t,n,r,i){let a=di|mn,s=5*2+i,o=5*2+1-i;return new Be(a,t,n,s,s,o,r,-1)}static makePromotion(t,n,r,i,a){let s=gi|(i===-1?0:mn),o=5*2+r,l=a*2+r;return new Be(s,t,n,o,l,i,-1,-1)}isCastling(){return(this._flags&hi)!==0}isEnPassant(){return(this._flags&di)!==0}isCapture(){return(this._flags&mn)!==0}isPromotion(){return(this._flags&gi)!==0}from(){return(0,he.squareToString)(this._from)}to(){return(0,he.squareToString)(this._to)}color(){return(0,he.colorToString)(this._movingColoredPiece%2)}movingPiece(){return(0,he.pieceToString)(Math.trunc(this._movingColoredPiece/2))}movingColoredPiece(){return(0,he.coloredPieceToString)(this._movingColoredPiece)}capturedPiece(){if(!this.isCapture())throw new Xe.IllegalArgument("MoveDescriptor.capturedPiece()");return(0,he.pieceToString)(Math.trunc(this._optionalColoredPiece/2))}capturedColoredPiece(){if(!this.isCapture())throw new Xe.IllegalArgument("MoveDescriptor.capturedColoredPiece()");return(0,he.coloredPieceToString)(this._optionalColoredPiece)}rookFrom(){if(!this.isCastling())throw new Xe.IllegalArgument("MoveDescriptor.rookFrom()");return(0,he.squareToString)(this._optionalSquare1)}rookTo(){if(!this.isCastling())throw new Xe.IllegalArgument("MoveDescriptor.rookTo()");return(0,he.squareToString)(this._optionalSquare2)}enPassantSquare(){if(!this.isEnPassant())throw new Xe.IllegalArgument("MoveDescriptor.enPassantSquare()");return(0,he.squareToString)(this._optionalSquare1)}promotion(){if(!this.isPromotion())throw new Xe.IllegalArgument("MoveDescriptor.promotion()");return(0,he.pieceToString)(Math.trunc(this._finalColoredPiece/2))}coloredPromotion(){if(!this.isPromotion())throw new Xe.IllegalArgument("MoveDescriptor.coloredPromotion()");return(0,he.coloredPieceToString)(this._finalColoredPiece)}};_n.MoveDescriptorImpl=Be});var In=x(D=>{"use strict";Object.defineProperty(D,"__esModule",{value:!0});D.playNullMove=D.isNullMoveLegal=D.play=D.isMoveLegal=D.isCastlingMoveLegal=D.isCaptureMandatory=D.moves=D.hasMove=D.isInsufficientMaterial=D.isStalemate=D.isCheckmate=D.isCheck=void 0;var dt=Gt(),B=ht(),Q=vn(),no=[204,0,0,0,0,0,0,60,0,0,0,0,0,0,204,0,0,204,0,0,0,0,0,60,0,0,0,0,0,204,0,0,0,0,204,0,0,0,0,60,0,0,0,0,204,0,0,0,0,0,0,204,0,0,0,60,0,0,0,204,0,0,0,0,0,0,0,0,204,0,0,60,0,0,204,0,0,0,0,0,0,0,0,0,0,204,768,60,768,204,0,0,0,0,0,0,0,0,0,0,0,768,2255,2111,2255,768,0,0,0,0,0,0,60,60,60,60,60,60,63,0,63,60,60,60,60,60,60,0,0,0,0,0,0,768,1231,1087,1231,768,0,0,0,0,0,0,0,0,0,0,0,204,768,60,768,204,0,0,0,0,0,0,0,0,0,0,204,0,0,60,0,0,204,0,0,0,0,0,0,0,0,204,0,0,0,60,0,0,0,204,0,0,0,0,0,0,204,0,0,0,0,60,0,0,0,0,204,0,0,0,0,204,0,0,0,0,0,60,0,0,0,0,0,204,0,0,204,0,0,0,0,0,0,60,0,0,0,0,0,0,204,0],ro=[-17,0,0,0,0,0,0,-16,0,0,0,0,0,0,-15,0,0,-17,0,0,0,0,0,-16,0,0,0,0,0,-15,0,0,0,0,-17,0,0,0,0,-16,0,0,0,0,-15,0,0,0,0,0,0,-17,0,0,0,-16,0,0,0,-15,0,0,0,0,0,0,0,0,-17,0,0,-16,0,0,-15,0,0,0,0,0,0,0,0,0,0,-17,0,-16,0,-15,0,0,0,0,0,0,0,0,0,0,0,0,-17,-16,-15,0,0,0,0,0,0,0,-1,-1,-1,-1,-1,-1,-1,0,1,1,1,1,1,1,1,0,0,0,0,0,0,0,15,16,17,0,0,0,0,0,0,0,0,0,0,0,0,15,0,16,0,17,0,0,0,0,0,0,0,0,0,0,15,0,0,16,0,0,17,0,0,0,0,0,0,0,0,15,0,0,0,16,0,0,0,17,0,0,0,0,0,0,15,0,0,0,0,16,0,0,0,0,17,0,0,0,0,15,0,0,0,0,0,16,0,0,0,0,0,17,0,0,15,0,0,0,0,0,0,16,0,0,0,0,0,0,17,0];function _i(e,t){for(let n=0;n<120;n+=(n&7)===7?9:1)if(e.board[n]!==-1&&e.board[n]%2===t)return!0;return!1}function pn(e){return e.king[e.turn]>=0&&(0,dt.isAttacked)(e,e.king[e.turn],1-e.turn)}function io(e){return(0,B.isLegal)(e)&&pn(e)}D.isCheck=io;function ao(e){return!(0,B.isLegal)(e)||lr(e)?!1:e.variant===5?!0:e.variant===6&&e.turn===0?!_i(e,0):pn(e)}D.isCheckmate=ao;function so(e){return!(0,B.isLegal)(e)||lr(e)?!1:e.variant===5?!0:e.variant===6&&e.turn===0?_i(e,0):!pn(e)}D.isStalemate=so;function oo(e,t){if(e.variant===5)return!1;if(e.variant===6&&e.turn===0)return!1;{let n=[..."KkQqRrBbNnPp"],r=["kk","kkn","kbk","knkn"],i=["bkbk","bkkn"],a=e.board.map(l=>n[l]),[s,o]=[a.filter(l=>l&&l.match("[A-Z]")).sort((l,u)=>l>u?1:-1).join("").toLowerCase(),a.filter(l=>l&&l.match("[a-z]")).sort((l,u)=>l>u?1:-1).join("")];return!!(r.includes(s+o)||r.includes(o+s)||t&&(i.includes(s+o)||i.includes(o+s)))}}D.isInsufficientMaterial=oo;function lr(e){class t{}try{return vi(e,()=>{throw new t}),!1}catch(n){if(n instanceof t)return!0;throw n}}D.hasMove=lr;function lo(e){let t=[];return vi(e,n=>{t.push(n)}),t}D.moves=lo;function vi(e,t){if(!(0,B.isLegal)(e))return;let n=!ur(e);if((0,B.refreshEffectiveCastling)(e),n&&e.effectiveCastling[e.turn]!==0){let r=112*e.turn;for(let i=0;i<8;++i)if((e.effectiveCastling[e.turn]&1<<i)!==0){let a=r+i,s=r+(a<e.king[e.turn]?3:5),o=r+(a<e.king[e.turn]?2:6);Ii(e,e.king[e.turn],o,a,s)&&t(Q.MoveDescriptorImpl.makeCastling(e.king[e.turn],o,a,s,e.turn))}}if((0,B.refreshEffectiveEnPassant)(e),e.effectiveEnPassant>=0){let r=(5-e.turn*3)*16+e.effectiveEnPassant,i=(4-e.turn)*16+e.effectiveEnPassant,a=5*2+e.turn;(i-1&136)===0&&e.board[i-1]===a&&(0,B.isKingSafeAfterMove)(e,i-1,r,i)&&t(Q.MoveDescriptorImpl.makeEnPassant(i-1,r,i,e.turn)),(i+1&136)===0&&e.board[i+1]===a&&(0,B.isKingSafeAfterMove)(e,i+1,r,i)&&t(Q.MoveDescriptorImpl.makeEnPassant(i+1,r,i,e.turn))}for(let r=0;r<120;r+=(r&7)===7?9:1){let i=e.board[r],a=Math.trunc(i/2);if(!(i===-1||i%2!==e.turn))if(a===5){let s=dt.ATTACK_DIRECTIONS[i];for(let o=0;o<s.length;++o){let l=r+s[o];(l&136)===0&&e.board[l]!==-1&&e.board[l]%2!==e.turn&&(0,B.isKingSafeAfterMove)(e,r,l)&&mi(e,r,l,t)}if(n){let o=16-e.turn*32,l=r+o;if(e.board[l]===-1){(0,B.isKingSafeAfterMove)(e,r,l)&&mi(e,r,l,t);let u=e.turn*96;r>=u&&r<u+24&&(l+=o,e.board[l]===-1&&(0,B.isKingSafeAfterMove)(e,r,l)&&t(Q.MoveDescriptorImpl.make(r,l,i,-1)))}}}else if(a===4||a===0){let s=dt.ATTACK_DIRECTIONS[i];for(let o=0;o<s.length;++o){let l=r+s[o];if((l&136)===0){let u=e.board[l];(u===-1?n:u%2!==e.turn)&&(0,B.isKingSafeAfterMove)(e,r,l)&&t(Q.MoveDescriptorImpl.make(r,l,i,u))}}}else{let s=dt.ATTACK_DIRECTIONS[i];for(let o=0;o<s.length;++o)for(let l=r+s[o];(l&136)===0;l+=s[o]){let u=e.board[l];if((u===-1?n:u%2!==e.turn)&&(0,B.isKingSafeAfterMove)(e,r,l)&&t(Q.MoveDescriptorImpl.make(r,l,i,u)),u!==-1)break}}}}function mi(e,t,n,r){let i=e.board[n];n<8||n>=112?(r(Q.MoveDescriptorImpl.makePromotion(t,n,e.turn,i,1)),r(Q.MoveDescriptorImpl.makePromotion(t,n,e.turn,i,2)),r(Q.MoveDescriptorImpl.makePromotion(t,n,e.turn,i,3)),r(Q.MoveDescriptorImpl.makePromotion(t,n,e.turn,i,4)),e.variant===5&&r(Q.MoveDescriptorImpl.makePromotion(t,n,e.turn,i,0))):r(Q.MoveDescriptorImpl.make(t,n,5*2+e.turn,i))}function ur(e){if(e.variant!==5)return!1;for(let t=0;t<120;t+=(t&7)===7?9:1){let n=e.board[t];if(n!==-1&&n%2!==e.turn&&(0,dt.isAttacked)(e,t,e.turn))return!0}return(0,B.refreshEffectiveEnPassant)(e),e.effectiveEnPassant>=0}D.isCaptureMandatory=ur;function pi(e,t,n){let r=-1,i=-1;if(e.variant===1){let a=n%16;if(Math.trunc(n/16)!==e.turn*7||(e.effectiveCastling[e.turn]&1<<a)===0)return!1;r=n,i=(t>n?3:5)+112*e.turn,n=(t>n?2:6)+112*e.turn}else if(n===2+e.turn*112){if((e.effectiveCastling[e.turn]&1)===0)return!1;r=112*e.turn,i=3+112*e.turn}else if(n===6+e.turn*112){if((e.effectiveCastling[e.turn]&1<<7)===0)return!1;r=7+112*e.turn,i=5+112*e.turn}else return!1;return Ii(e,t,n,r,i)?Q.MoveDescriptorImpl.makeCastling(t,n,r,i,e.turn):!1}D.isCastlingMoveLegal=pi;function Ii(e,t,n,r,i){e.board[t]=-1,e.board[r]=-1;try{for(let s=Math.min(t,n,r,i);s<=Math.max(t,n,r,i);++s)if(e.board[s]!==-1)return!1;let a=1-e.turn;for(let s=Math.min(t,n);s<=Math.max(t,n);++s)if((0,dt.isAttacked)(e,s,a))return!1;return!0}finally{e.board[t]=0*2+e.turn,e.board[r]=2*2+e.turn}}function uo(e,t,n){if(!(0,B.isLegal)(e))return!1;let r=e.board[t],i=e.board[n],a=Math.trunc(r/2);if(r===-1||r%2!==e.turn)return!1;let s=n-t+119,o=-1,l=!1,u=a===5&&(n<8||n>=112),d=ur(e);if(a===0&&!d&&((0,B.refreshEffectiveCastling)(e),e.effectiveCastling[e.turn]!==0)){let c=pi(e,t,n);if(c)return{type:"regular",moveDescriptor:c}}if((no[s]&1<<r)===0)if(a===5&&s===151-e.turn*64){let c=e.turn*96;if(t<c||t>=c+24)return!1;l=!0}else return!1;if(a===5){if((0,B.refreshEffectiveEnPassant)(e),s===135-e.turn*32||l){if(d||i!==-1)return!1}else if(i===-1){if(n!==(5-e.turn*3)*16+e.effectiveEnPassant)return!1;o=(4-e.turn)*16+e.effectiveEnPassant}else if(i%2===e.turn)return!1}else if(i===-1?d:i%2===e.turn)return!1;if(a===3||a===2||a===1){let c=ro[s];for(let m=t+c;m!==n;m+=c)if(e.board[m]!==-1)return!1}else if(l&&e.board[(t+n)/2]!==-1)return!1;return(0,B.isKingSafeAfterMove)(e,t,n,o)?u?{type:"promotion",moveDescriptorFactory:fo(t,n,e.variant,e.turn,i)}:{type:"regular",moveDescriptor:o>=0?Q.MoveDescriptorImpl.makeEnPassant(t,n,o,e.turn):Q.MoveDescriptorImpl.make(t,n,r,i)}:!1}D.isMoveLegal=uo;function fo(e,t,n,r,i){return a=>a===5||a===0&&n!==5?!1:Q.MoveDescriptorImpl.makePromotion(e,t,r,i,a)}function co(e,t){(0,B.refreshEffectiveCastling)(e),e.board[t._from]=-1,t.isEnPassant()?e.board[t._optionalSquare1]=-1:t.isCastling()&&(e.board[t._optionalSquare1]=-1,e.board[t._optionalSquare2]=t._optionalColoredPiece),e.board[t._to]=t._finalColoredPiece;let n=Math.trunc(t._movingColoredPiece/2);if(n===0&&(e.effectiveCastling[e.turn]=0),t._from<8&&(e.effectiveCastling[0]&=~(1<<t._from)),t._to<8&&(e.effectiveCastling[0]&=~(1<<t._to)),t._from>=112&&(e.effectiveCastling[1]&=~(1<<t._from%16)),t._to>=112&&(e.effectiveCastling[1]&=~(1<<t._to%16)),e.castling[0]=e.effectiveCastling[0],e.castling[1]=e.effectiveCastling[1],e.enPassant=-1,e.effectiveEnPassant=-1,n===5&&Math.abs(t._from-t._to)===32){let r=(1+5*e.turn)*16;if(t._from>=r&&t._from<r+8){let i=t._movingColoredPiece^1;((t._to-1&136)===0&&e.board[t._to-1]===i||(t._to+1&136)===0&&e.board[t._to+1]===i)&&(e.enPassant=t._to%16,e.effectiveEnPassant=null)}}n===0&&e.king[e.turn]>=0&&(e.king[e.turn]=t._to),e.turn=1-e.turn}D.play=co;function Ni(e){return(0,B.isLegal)(e)&&!pn(e)}D.isNullMoveLegal=Ni;function ho(e){return Ni(e)?(e.turn=1-e.turn,e.enPassant=-1,e.effectiveEnPassant=-1,!0):!1}D.playNullMove=ho});var Ci=x(mt=>{"use strict";Object.defineProperty(mt,"__esModule",{value:!0});mt.parseNotation=mt.getNotation=void 0;var wi=Gt(),ee=Ve(),C=gn(),go=Rt(),$t=ht(),bn=vn(),gt=In(),A=Z(),S=Me();function mo(e,t,n){let r="";return t.isCastling()?r=t._to%16===6?"O-O":"O-O-O":Math.trunc(t._movingColoredPiece/2)===5?(t.isCapture()&&(r+=(0,ee.fileToString)(t._from%16)+"x"),r+=(0,ee.squareToString)(t._to),t.isPromotion()&&(r+="="+bi(t._finalColoredPiece,n))):(r+=bi(t._movingColoredPiece,n),r+=Si(e,t._from,t._to),t.isCapture()&&(r+="x"),r+=(0,ee.squareToString)(t._to)),r+=Ei(e,t),r}mt.getNotation=mo;function bi(e,t){switch(t){case"figurine":return(0,ee.figurineToString)(e);case"standard":return(0,ee.pieceToString)(Math.trunc(e/2)).toUpperCase()}}function Ei(e,t){let n=(0,go.makeCopy)(e);return(0,gt.play)(n,t),(0,gt.isCheckmate)(n)?"#":(0,gt.isCheck)(n)?"+":""}function Si(e,t,n){let r=(0,wi.getAttacks)(e,n,e.turn).filter(u=>e.board[u]===e.board[t]);if(r.length<2)return"";let i=!1,a=!1,s=!1,o=Math.trunc(t/16),l=t%16;for(let u=0;u<r.length;++u){let d=r[u];d===t||_o(e,d,n)||(i=!0,o===Math.trunc(d/16)&&(a=!0),l===d%16&&(s=!0))}return s?a?(0,ee.squareToString)(t):(0,ee.rankToString)(o):i?(0,ee.fileToString)(l):""}function _o(e,t,n){let r=e.king[e.turn];if(r<0)return!1;let i=Math.abs(r-t),a=Math.abs(n-t),s=1*2+1-e.turn,o=2*2+1-e.turn,l=3*2+1-e.turn;return i<8?a>=8&&Nn(e,r,t,r<t?1:-1,o,s):i%16===0?a%16!==0&&Nn(e,r,t,r<t?16:-16,o,s):i%15===0?a%15!==0&&Nn(e,r,t,r<t?15:-15,l,s):i%17===0?a%17!==0&&Nn(e,r,t,r<t?17:-17,l,s):!1}function Nn(e,t,n,r,i,a){for(let s=t+r;s!==n;s+=r)if(e.board[s]!==-1)return!1;for(let s=n+r;(s&136)===0;s+=r)if(e.board[s]!==-1)return e.board[s]===i||e.board[s]===a;return!1}function vo(e,t,n,r){let i=/^(?:(O-O-O|0-0-0)|(O-O|0-0)|([A-Z\u2654-\u265f])([a-h])?([1-8])?(x)?([a-h][1-8])|(?:([a-h])(x)?)?([a-h][1-8])(?:(=)?([A-Z\u2654-\u265f]))?)([+#])?$/.exec(t);if(i===null)throw new A.InvalidNotation((0,C.getFEN)(e),t,S.i18n.INVALID_MOVE_NOTATION_SYNTAX);if(!(0,$t.isLegal)(e))throw new A.InvalidNotation((0,C.getFEN)(e),t,S.i18n.ILLEGAL_POSITION);let a=!1;if(i[1]!==void 0||i[2]!==void 0?a=po(e,t,n,i[1],i[2]):i[3]!==void 0?a=No(e,t,n,r,i[3],i[4],i[5],i[7]):a=bo(e,t,n,r,i[8],i[10],i[11],i[12]),n){let s=i[6]!==void 0||i[9]!==void 0;if(a.isCapture()!==s){let u=a.isCapture()?S.i18n.MISSING_CAPTURE_SYMBOL:S.i18n.INVALID_CAPTURE_SYMBOL;throw new A.InvalidNotation((0,C.getFEN)(e),t,u)}let o=Ei(e,a),l=i[13]===void 0?"":i[13];if(o!==l)throw new A.InvalidNotation((0,C.getFEN)(e),t,S.i18n.WRONG_CHECK_CHECKMATE_SYMBOL,o,l)}return a}mt.parseNotation=vo;function po(e,t,n,r,i){let a=e.king[e.turn];if(a<0)throw new A.InvalidNotation((0,C.getFEN)(e),t,S.i18n.ILLEGAL_NO_KING_CASTLING);(0,$t.refreshEffectiveCastling)(e);let s=i!==void 0,o=Io(e,s),l=o>=0?(0,gt.isCastlingMoveLegal)(e,a,o+112*e.turn):!1;if(!l){let u=s?S.i18n.ILLEGAL_KING_SIDE_CASTLING:S.i18n.ILLEGAL_QUEEN_SIDE_CASTLING;throw new A.InvalidNotation((0,C.getFEN)(e),t,u)}if(n&&(s?i:r).charAt(0)==="0")throw new A.InvalidNotation((0,C.getFEN)(e),t,S.i18n.CASTLING_MOVE_ENCODED_WITH_ZERO);return l}function Io(e,t){if(e.variant===1){if(e.effectiveCastling[e.turn]!==0){let n=0+e.turn;for(let r=t?7:0;e.board[r+112*e.turn]!==n;r+=t?-1:1)if((e.effectiveCastling[e.turn]&1<<r)!==0)return r}return-1}else return t?6:2}function No(e,t,n,r,i,a,s,o){let l=Pi(e,t,i,n,r)*2+e.turn,u=(0,ee.squareFromString)(o),d=e.board[u];if(d!==-1&&d%2===e.turn)throw new A.InvalidNotation((0,C.getFEN)(e),t,S.i18n.TRYING_TO_CAPTURE_YOUR_OWN_PIECES);if(d===-1&&(0,gt.isCaptureMandatory)(e))throw new A.InvalidNotation((0,C.getFEN)(e),t,S.i18n.CAPTURE_IS_MANDATORY);let c=(0,wi.getAttacks)(e,u,e.turn).filter(_=>e.board[_]===l);if(a!==void 0){let _=(0,ee.fileFromString)(a);c=c.filter(E=>E%16===_)}if(s!==void 0){let _=(0,ee.rankFromString)(s);c=c.filter(E=>Math.trunc(E/16)===_)}if(c.length===0){let _=a===void 0&&s===void 0?S.i18n.NO_PIECE_CAN_MOVE_TO:S.i18n.NO_PIECE_CAN_MOVE_TO_DISAMBIGUATION;throw new A.InvalidNotation((0,C.getFEN)(e),t,_,i,o)}let m=!1;for(let _=0;_<c.length;++_)if((0,$t.isKingSafeAfterMove)(e,c[_],u)){if(m)throw new A.InvalidNotation((0,C.getFEN)(e),t,S.i18n.REQUIRE_DISAMBIGUATION,i,o);m=bn.MoveDescriptorImpl.make(c[_],u,l,d)}if(!m){let _=e.turn===0?S.i18n.NOT_SAFE_FOR_WHITE_KING:S.i18n.NOT_SAFE_FOR_BLACK_KING;throw new A.InvalidNotation((0,C.getFEN)(e),t,_)}if(n){let _=Si(e,m._from,u),E=(a===void 0?"":a)+(s===void 0?"":s);if(_!==E)throw new A.InvalidNotation((0,C.getFEN)(e),t,S.i18n.WRONG_DISAMBIGUATION_SYMBOL,_,E)}return m}function bo(e,t,n,r,i,a,s,o){let l=10+e.turn,u=(0,ee.squareFromString)(a),d=e.board[u],c=16-e.turn*32,m=u-c,_=-1;if(i!==void 0){if((m&136)!==0)throw new A.InvalidNotation((0,C.getFEN)(e),t,S.i18n.INVALID_CAPTURING_PAWN_MOVE);let E=(0,ee.fileFromString)(i),F=u%16;if(F-E===1)m-=1;else if(F-E===-1)m+=1;else throw new A.InvalidNotation((0,C.getFEN)(e),t,S.i18n.INVALID_CAPTURING_PAWN_MOVE);if(e.board[m]!==l)throw new A.InvalidNotation((0,C.getFEN)(e),t,S.i18n.INVALID_CAPTURING_PAWN_MOVE);if(d===-1){if((0,$t.refreshEffectiveEnPassant)(e),u!==(5-e.turn*3)*16+e.effectiveEnPassant)throw new A.InvalidNotation((0,C.getFEN)(e),t,S.i18n.INVALID_CAPTURING_PAWN_MOVE);_=(4-e.turn)*16+e.effectiveEnPassant}else if(d%2===e.turn)throw new A.InvalidNotation((0,C.getFEN)(e),t,S.i18n.INVALID_CAPTURING_PAWN_MOVE)}else{if((0,gt.isCaptureMandatory)(e))throw new A.InvalidNotation((0,C.getFEN)(e),t,S.i18n.CAPTURE_IS_MANDATORY);if((m&136)!==0)throw new A.InvalidNotation((0,C.getFEN)(e),t,S.i18n.INVALID_NON_CAPTURING_PAWN_MOVE);if(d!==-1)throw new A.InvalidNotation((0,C.getFEN)(e),t,S.i18n.INVALID_NON_CAPTURING_PAWN_MOVE);if(e.board[m]===-1){m-=c;let E=e.turn*96;if(m<E||m>=E+24||e.board[m]!==l)throw new A.InvalidNotation((0,C.getFEN)(e),t,S.i18n.INVALID_NON_CAPTURING_PAWN_MOVE)}else if(e.board[m]!==l)throw new A.InvalidNotation((0,C.getFEN)(e),t,S.i18n.INVALID_NON_CAPTURING_PAWN_MOVE)}if(!(0,$t.isKingSafeAfterMove)(e,m,u,_)){let E=e.turn===0?S.i18n.NOT_SAFE_FOR_WHITE_KING:S.i18n.NOT_SAFE_FOR_BLACK_KING;throw new A.InvalidNotation((0,C.getFEN)(e),t,E)}if(u<8||u>=112){if(o===void 0)throw new A.InvalidNotation((0,C.getFEN)(e),t,S.i18n.MISSING_PROMOTION);let E=Pi(e,t,o,n,r);if(E===5||E===0&&e.variant!==5)throw new A.InvalidNotation((0,C.getFEN)(e),t,S.i18n.INVALID_PROMOTED_PIECE,o);if(n&&s===void 0)throw new A.InvalidNotation((0,C.getFEN)(e),t,S.i18n.MISSING_PROMOTION_SYMBOL);return bn.MoveDescriptorImpl.makePromotion(m,u,e.turn,d,E)}else{if(o!==void 0)throw new A.InvalidNotation((0,C.getFEN)(e),t,S.i18n.ILLEGAL_PROMOTION);return _>=0?bn.MoveDescriptorImpl.makeEnPassant(m,u,_,e.turn):bn.MoveDescriptorImpl.make(m,u,l,d)}}function Pi(e,t,n,r,i){switch(i){case"figurine":{let a=(0,ee.figurineFromString)(n);if(a<0)throw new A.InvalidNotation((0,C.getFEN)(e),t,S.i18n.INVALID_PIECE_SYMBOL,n);if(r&&a%2!==e.turn)throw new A.InvalidNotation((0,C.getFEN)(e),t,S.i18n.INVALID_PIECE_SYMBOL_COLOR,n);return Math.trunc(a/2)}case"standard":{let a=(0,ee.pieceFromString)(n.toLowerCase());if(a<0)throw new A.InvalidNotation((0,C.getFEN)(e),t,S.i18n.INVALID_PIECE_SYMBOL,n);return a}}}});var Ai=x(_t=>{"use strict";Object.defineProperty(_t,"__esModule",{value:!0});_t.parseUCINotation=_t.getUCINotation=void 0;var fr=Ve(),Qe=gn(),wo=ht(),Eo=In(),Je=Z(),Ze=Me();function So(e,t,n){let r=t.from();return t.isCastling()?r+=n||e.variant===1?t.rookFrom():t.to():r+=t.to(),t.isPromotion()&&(r+=t.promotion()),r}_t.getUCINotation=So;function Po(e,t,n){let r=/^([a-h][1-8])([a-h][1-8])([kqrbnp]?)$/.exec(t);if(r===null)throw new Je.InvalidNotation((0,Qe.getFEN)(e),t,Ze.i18n.INVALID_UCI_NOTATION_SYNTAX);if(!(0,wo.isLegal)(e))throw new Je.InvalidNotation((0,Qe.getFEN)(e),t,Ze.i18n.ILLEGAL_POSITION);let i=(0,fr.squareFromString)(r[1]),a=(0,fr.squareFromString)(r[2]),s=!1,o=-1;if(e.variant!==1&&!n&&e.board[i]!==-1&&e.board[a]!==-1&&e.board[i]%2===e.board[a]%2){let d=Math.trunc(e.board[i]/2),c=Math.trunc(e.board[a]/2);d===0&&c===2&&(s=!0,o=a,a=e.turn*112+(i<a?6:2))}let l=(0,Eo.isMoveLegal)(e,i,a),u=!1;if(!l)throw new Je.InvalidNotation((0,Qe.getFEN)(e),t,Ze.i18n.ILLEGAL_UCI_MOVE);if(l.type==="promotion"){if(r[3]==="")throw new Je.InvalidNotation((0,Qe.getFEN)(e),t,Ze.i18n.ILLEGAL_UCI_MOVE);if(u=l.moveDescriptorFactory((0,fr.pieceFromString)(r[3])),!u)throw new Je.InvalidNotation((0,Qe.getFEN)(e),t,Ze.i18n.ILLEGAL_UCI_MOVE)}else{if(r[3]!=="")throw new Je.InvalidNotation((0,Qe.getFEN)(e),t,Ze.i18n.ILLEGAL_UCI_MOVE);u=l.moveDescriptor}if(s&&(!u.isCastling()||o!==u._optionalSquare1))throw new Je.InvalidNotation((0,Qe.getFEN)(e),t,Ze.i18n.ILLEGAL_UCI_MOVE);return u}_t.parseUCINotation=Po});var vt=x(En=>{"use strict";Object.defineProperty(En,"__esModule",{value:!0});En.Position=void 0;var O=Z(),Co=Me(),yi=Gt(),M=Ve(),Ue=gn(),te=Rt(),Bt=ht(),Ut=vn(),pe=In(),et=Ci(),wn=Ai(),tt=class{constructor(t,n){switch(arguments.length){case 0:this._impl=(0,te.makeInitial)(0);break;case 1:{if(t==="start")this._impl=(0,te.makeInitial)(0);else if(t==="empty")this._impl=(0,te.makeEmpty)(0);else if(t instanceof tt)this._impl=(0,te.makeCopy)(t._impl);else{let r=(0,M.variantFromString)(t);if(r>=0){if(!(0,te.hasCanonicalStartPosition)(r))throw new O.IllegalArgument("Position()");this._impl=(0,te.makeInitial)(r)}else if(typeof t=="string"){let i=t.indexOf(":");if(i<0)this._impl=(0,Ue.parseFEN)(0,t,!1).position;else{let a=t.substring(0,i),s=(0,M.variantFromString)(a);if(s<0)throw new O.InvalidFEN(t,Co.i18n.INVALID_VARIANT_PREFIX,a);this._impl=(0,Ue.parseFEN)(s,t.substring(i+1),!1).position}}else throw new O.IllegalArgument("Position()")}break}default:{let r=(0,M.variantFromString)(t);if(r<0)throw new O.IllegalArgument("Position()");if(n==="start"){if(!(0,te.hasCanonicalStartPosition)(r))throw new O.IllegalArgument("Position()");this._impl=(0,te.makeInitial)(r)}else if(n==="empty")this._impl=(0,te.makeEmpty)(r);else if(typeof n=="number"){if(r!==1||!Ti(n))throw new O.IllegalArgument("Position()");this._impl=(0,te.make960FromScharnagl)(n)}else if(typeof n=="string")this._impl=(0,Ue.parseFEN)(r,n,!1).position;else throw new O.IllegalArgument("Position()");break}}}clear(t="regular"){let n=(0,M.variantFromString)(t);if(n<0)throw new O.IllegalArgument("Position.clear()");this._impl=(0,te.makeEmpty)(n)}reset(){this._impl=(0,te.makeInitial)(0)}reset960(t){if(!Ti(t))throw new O.IllegalArgument("Position.reset960()");this._impl=(0,te.make960FromScharnagl)(t)}resetAntichess(){this._impl=(0,te.makeInitial)(5)}resetHorde(){this._impl=(0,te.makeInitial)(6)}static isEqual(t,n){return t instanceof tt&&n instanceof tt&&(0,Bt.isEqual)(t._impl,n._impl)}ascii(){return(0,Ue.ascii)(this._impl)}fen(t,n){if(arguments.length===0)return(0,Ue.getFEN)(this._impl);if(arguments.length===1&&typeof t=="object"){let r=Ao(t,"Position.fen()"),i=r("fiftyMoveClock",0,l=>Number.isInteger(l)),a=r("fullMoveNumber",1,l=>Number.isInteger(l)),s=r("withVariant",!1,l=>typeof l=="boolean"),o=r("regularFENIfPossible",!1,l=>typeof l=="boolean");return(s?(0,M.variantToString)(this._impl.variant)+":":"")+(0,Ue.getFEN)(this._impl,i,a,o)}else if(arguments.length===1&&typeof t=="string"){let r=(0,Ue.parseFEN)(this._impl.variant,t,!1);return this._impl=r.position,{fiftyMoveClock:r.fiftyMoveClock,fullMoveNumber:r.fullMoveNumber}}else if(arguments.length>=2&&typeof t=="string"&&typeof n=="boolean"){let r=(0,Ue.parseFEN)(this._impl.variant,t,n);return this._impl=r.position,{fiftyMoveClock:r.fiftyMoveClock,fullMoveNumber:r.fullMoveNumber}}else throw new O.IllegalArgument("Position.fen()")}variant(){return(0,M.variantToString)(this._impl.variant)}square(t,n){let r=(0,M.squareFromString)(t);if(r<0)throw new O.IllegalArgument("Position.square()");if(arguments.length===1){let i=this._impl.board[r];return i===-1?"-":(0,M.coloredPieceToString)(i)}else if(n==="-")this._impl.board[r]=-1,this._impl.legal=null,this._impl.effectiveCastling=null,this._impl.effectiveEnPassant=null;else{let i=(0,M.coloredPieceFromString)(n);if(i<0)throw new O.IllegalArgument("Position.square()");this._impl.board[r]=i,this._impl.legal=null,this._impl.effectiveCastling=null,this._impl.effectiveEnPassant=null}}turn(t){if(arguments.length===0)return(0,M.colorToString)(this._impl.turn);{let n=(0,M.colorFromString)(t);if(n<0)throw new O.IllegalArgument("Position.turn()");this._impl.turn=n,this._impl.legal=null,this._impl.effectiveEnPassant=null}}castling(t,n){if(typeof t!="string"||!(this._impl.variant===1?/^[wb][a-h]$/:/^[wb][kq]$/).test(t))throw new O.IllegalArgument("Position.castling()");let r=(0,M.colorFromString)(t[0]),i=this._impl.variant===1?(0,M.fileFromString)(t[1]):t[1]==="k"?7:0;if(arguments.length===1)return(this._impl.castling[r]&1<<i)!==0;if(typeof n=="boolean")n?this._impl.castling[r]|=1<<i:this._impl.castling[r]&=~(1<<i),this._impl.effectiveCastling=null;else throw new O.IllegalArgument("Position.castling()")}effectiveCastling(t){if(typeof t!="string"||!(this._impl.variant===1?/^[wb][a-h]$/:/^[wb][kq]$/).test(t))throw new O.IllegalArgument("Position.effectiveCastling()");let n=(0,M.colorFromString)(t[0]),r=this._impl.variant===1?(0,M.fileFromString)(t[1]):t[1]==="k"?7:0;return(0,Bt.refreshEffectiveCastling)(this._impl),(this._impl.effectiveCastling[n]&1<<r)!==0}enPassant(t){if(arguments.length===0)return this._impl.enPassant<0?"-":(0,M.fileToString)(this._impl.enPassant);if(t==="-")this._impl.enPassant=-1,this._impl.effectiveEnPassant=-1;else{let n=(0,M.fileFromString)(t);if(n<0)throw new O.IllegalArgument("Position.enPassant()");this._impl.enPassant=n,this._impl.effectiveEnPassant=null}}effectiveEnPassant(){return(0,Bt.refreshEffectiveEnPassant)(this._impl),this._impl.effectiveEnPassant<0?"-":(0,M.fileToString)(this._impl.effectiveEnPassant)}isAttacked(t,n){let r=(0,M.squareFromString)(t),i=(0,M.colorFromString)(n);if(r<0||i<0)throw new O.IllegalArgument("Position.isAttacked()");return(0,yi.isAttacked)(this._impl,r,i)}getAttacks(t,n){let r=(0,M.squareFromString)(t),i=(0,M.colorFromString)(n);if(r<0||i<0)throw new O.IllegalArgument("Position.getAttacks()");return(0,yi.getAttacks)(this._impl,r,i).map(M.squareToString)}isLegal(){return(0,Bt.isLegal)(this._impl)}kingSquare(t){let n=(0,M.colorFromString)(t);if(n<0)throw new O.IllegalArgument("Position.kingSquare()");(0,Bt.refreshLegalFlagAndKingSquares)(this._impl);let r=this._impl.king[n];return r<0?!1:(0,M.squareToString)(r)}isCheck(){return(0,pe.isCheck)(this._impl)}isCheckmate(){return(0,pe.isCheckmate)(this._impl)}isStalemate(){return(0,pe.isStalemate)(this._impl)}isInsufficientMaterial(t){return(0,pe.isInsufficientMaterial)(this._impl,t)}hasMove(){return(0,pe.hasMove)(this._impl)}moves(){return(0,pe.moves)(this._impl)}isMoveLegal(t,n){let r=(0,M.squareFromString)(t),i=(0,M.squareFromString)(n);if(r<0||i<0)throw new O.IllegalArgument("Position.isMoveLegal()");let a=(0,pe.isMoveLegal)(this._impl,r,i);if(!a)return!1;switch(a.type){case"promotion":{let s=o=>{let l=(0,M.pieceFromString)(o);if(l>=0){let u=a.moveDescriptorFactory(l);if(u)return u}throw new O.IllegalArgument("Position.isMoveLegal()")};return s.status="promotion",s}case"regular":{let s=()=>a.moveDescriptor;return s.status="regular",s}}}play(t){if(typeof t=="string")try{return(0,pe.play)(this._impl,(0,et.parseNotation)(this._impl,t,!1,"standard")),!0}catch(n){if(n instanceof O.InvalidNotation)return!1;throw n}else{if(t instanceof Ut.MoveDescriptorImpl)return(0,pe.play)(this._impl,t),!0;throw new O.IllegalArgument("Position.play()")}}isNullMoveLegal(){return(0,pe.isNullMoveLegal)(this._impl)}playNullMove(){return(0,pe.playNullMove)(this._impl)}notation(t,n){if(arguments.length===1&&t instanceof Ut.MoveDescriptorImpl)return(0,et.getNotation)(this._impl,t,"standard");if(arguments.length===1&&typeof t=="string")return(0,et.parseNotation)(this._impl,t,!1,"standard");if(arguments.length>=2&&typeof t=="string"&&typeof n=="boolean")return(0,et.parseNotation)(this._impl,t,n,"standard");throw new O.IllegalArgument("Position.notation()")}figurineNotation(t,n){if(arguments.length===1&&t instanceof Ut.MoveDescriptorImpl)return(0,et.getNotation)(this._impl,t,"figurine");if(arguments.length===1&&typeof t=="string")return(0,et.parseNotation)(this._impl,t,!1,"figurine");if(arguments.length>=2&&typeof t=="string"&&typeof n=="boolean")return(0,et.parseNotation)(this._impl,t,n,"figurine");throw new O.IllegalArgument("Position.figurineNotation()")}uci(t,n){if(arguments.length===1&&t instanceof Ut.MoveDescriptorImpl)return(0,wn.getUCINotation)(this._impl,t,!1);if(arguments.length>=2&&t instanceof Ut.MoveDescriptorImpl&&typeof n=="boolean")return(0,wn.getUCINotation)(this._impl,t,n);if(arguments.length===1&&typeof t=="string")return(0,wn.parseUCINotation)(this._impl,t,!1);if(arguments.length>=2&&typeof t=="string"&&typeof n=="boolean")return(0,wn.parseUCINotation)(this._impl,t,n);throw new O.IllegalArgument("Position.uci()")}};En.Position=tt;function Ti(e){return Number.isInteger(e)&&e>=0&&e<960}function Ao(e,t){return function(n,r,i){if(e[n]===void 0)return r;{let a=e[n];if(!i(a))throw new O.IllegalArgument(t);return a}}}});var jt=x(We=>{"use strict";Object.defineProperty(We,"__esModule",{value:!0});We.Variation=We.Node=We.AbstractNode=void 0;var Wt=class{constructor(){}};We.AbstractNode=Wt;var cr=class extends Wt{constructor(){super()}isVariation(){return!1}toString(){return`${this.id()}[${this.notation()}]`}};We.Node=cr;var hr=class extends Wt{constructor(){super()}isVariation(){return!0}toString(){return this.id()}};We.Variation=hr});var Pn=x(Sn=>{"use strict";Object.defineProperty(Sn,"__esModule",{value:!0});Sn.trimAndCollapseSpaces=void 0;function yo(e){return e.replace(/^\s+|\s+$/g,"").replace(/\s+/g," ")}Sn.trimAndCollapseSpaces=yo});var Ri=x(yn=>{"use strict";Object.defineProperty(yn,"__esModule",{value:!0});yn.MoveTreeRoot=void 0;var se=Z(),To=Me(),Oi=jt(),Oe=vt(),je=class{constructor(){this._position=new Oe.Position,this._fullMoveNumber=1,this._mainVariationData=An(this,!0)}clearTree(){this._mainVariationData=An(this,!0)}mainVariation(){return new rt(this._mainVariationData,this._position)}findById(t){let n=t.split("-");if(n.length%2!==1)return;let r=new Oe.Position(this._position),i=this._mainVariationData;for(let s=0;s+1<n.length;s+=2){let o=ki(i,n[s],r);if(o===void 0)return;let l=/^v(\d+)$/.exec(n[s+1]);if(!l)return;let u=parseInt(l[1]);if(u>=o.variations.length)return;i=o.variations[u]}let a=n[n.length-1];if(a==="start")return new rt(i,r);{let s=ki(i,a,r);return s===void 0?void 0:new Ie(s,r)}}};yn.MoveTreeRoot=je;function ki(e,t,n){let r=e.child;for(;r!==void 0;){if(t===r.fullMoveNumber+r.moveColor)return r;nt(n,r),r=r.child}}function Fi(e,t,n,r){return{parentVariation:e,child:void 0,variations:[],moveColor:t,fullMoveNumber:n,moveDescriptor:r,nags:new Set,tags:new Map,comment:void 0,isLongComment:!1}}function An(e,t){return{parent:e,child:void 0,isLongVariation:t,nags:new Set,tags:new Map,comment:void 0,isLongComment:!1}}function Li(e,t){if(t==="--"){if(!e.isNullMoveLegal())throw new se.InvalidNotation(e.fen(),"--",To.i18n.ILLEGAL_NULL_MOVE);return null}else return e.notation(t)}function nt(e,t){t.moveDescriptor===null?e.playNullMove():e.play(t.moveDescriptor)}function dr(e){if(e.parent instanceof je)return new Oe.Position(e.parent._position);{let t=e.parent.parentVariation.child,n=dr(e.parent.parentVariation);for(;t!==e.parent;)nt(n,t),t=t.child;return n}}function xi(e){return Di(e.parentVariation)+e.fullMoveNumber+e.moveColor}function Di(e){if(e.parent instanceof je)return"";{let t=xi(e.parent),n=e.parent.variations.indexOf(e);return`${t}-v${n}-`}}function gr(e){for(;;){if(!e.isLongVariation)return!1;if(e.parent instanceof je)return!0;e=e.parent.parentVariation}}function Cn(e,t){return Number.isInteger(e)&&e>=0&&e<t.variations.length}function pt(e){return Number.isInteger(e)&&e>=0}function Vi(e){return typeof e=="string"&&/^\w+$/.test(e)}var Ie=class extends Oi.Node{constructor(t,n){super(),this._data=t,this._positionBefore=n}id(){return xi(this._data)}nags(){let t=[];for(let n of this._data.nags)t.push(n);return t.sort((n,r)=>n-r)}hasNag(t){if(!pt(t))throw new se.IllegalArgument("Node.hasNag()");return this._data.nags.has(t)}addNag(t){if(!pt(t))throw new se.IllegalArgument("Node.addNag()");return this._data.nags.add(t)}removeNag(t){if(!pt(t))throw new se.IllegalArgument("Node.removeNag()");return this._data.nags.delete(t)}tags(){let t=[];for(let n of this._data.tags.keys())t.push(n);return t.sort()}tag(t,n){if(!Vi(t))throw new se.IllegalArgument("Node.tag()");if(arguments.length===1)return this._data.tags.get(t);if(arguments.length>=2)n==null?this._data.tags.delete(t):this._data.tags.set(t,String(n));else throw new se.IllegalArgument("Node.tag()")}comment(t,n){if(arguments.length===0)return this._data.comment;t==null?(this._data.comment=void 0,this._data.isLongComment=!1):(this._data.comment=String(t),this._data.isLongComment=Boolean(n))}isLongComment(){return this._data.isLongComment&&gr(this._data.parentVariation)}parentVariation(){let t=dr(this._data.parentVariation);return new rt(this._data.parentVariation,t)}previous(){let t=this._data.parentVariation.child;if(t===this._data)return;let n=dr(this._data.parentVariation);for(;t.child!==this._data;)nt(n,t),t=t.child;return new Ie(t,n)}next(){if(this._data.child===void 0)return;let t=new Oe.Position(this._positionBefore);return nt(t,this._data),new Ie(this._data.child,t)}notation(){return this._data.moveDescriptor===null?"--":this._positionBefore.notation(this._data.moveDescriptor)}figurineNotation(){return this._data.moveDescriptor===null?"--":this._positionBefore.figurineNotation(this._data.moveDescriptor)}positionBefore(){return new Oe.Position(this._positionBefore)}position(){let t=new Oe.Position(this._positionBefore);return nt(t,this._data),t}fullMoveNumber(){return this._data.fullMoveNumber}moveColor(){return this._data.moveColor}variations(){return this._data.variations.map(t=>new rt(t,this._positionBefore))}play(t){let n=new Oe.Position(this._positionBefore);nt(n,this._data);let r=n.turn(),i=r==="w"?this._data.fullMoveNumber+1:this._data.fullMoveNumber;return this._data.child=Fi(this._data.parentVariation,r,i,Li(n,t)),new Ie(this._data.child,n)}removeFollowingMoves(){this._data.child=void 0}addVariation(t){let n=An(this._data,t===void 0?!1:t);return this._data.variations.push(n),new rt(n,this._positionBefore)}removeVariation(t){if(!Cn(t,this._data))throw new se.IllegalArgument("Node.removeVariation()");this._data.variations=this._data.variations.slice(0,t).concat(this._data.variations.slice(t+1))}swapVariations(t,n){if(!Cn(t,this._data)||!Cn(n,this._data))throw new se.IllegalArgument("Node.swapVariations()");let r=this._data.variations[t];this._data.variations[t]=this._data.variations[n],this._data.variations[n]=r}promoteVariation(t){if(!Cn(t,this._data)||this._data.variations[t].child===void 0)throw new se.IllegalArgument("Node.promoteVariation()");let n=this._data,r=this._data.variations[t].child,i=n.variations;n.variations=[],i[t]=An(r,!1),i[t].child=n,this._data=r,r.variations=i.concat(r.variations),ko(n).child=r,Mi(r,n.parentVariation),Mi(n,i[t]);for(let a of r.variations)a.parent=r}};function ko(e){let t=e.parentVariation;for(;t.child!==e;)t=t.child;return t}function Mi(e,t){let n=e;for(;n!==void 0;)n.parentVariation=t,n=n.child}var rt=class extends Oi.Variation{constructor(t,n){super(),this._data=t,this._initialPosition=n}id(){return Di(this._data)+"start"}nags(){let t=[];for(let n of this._data.nags)t.push(n);return t.sort((n,r)=>n-r)}hasNag(t){if(!pt(t))throw new se.IllegalArgument("Variation.hasNag()");return this._data.nags.has(t)}addNag(t){if(!pt(t))throw new se.IllegalArgument("Variation.addNag()");return this._data.nags.add(t)}removeNag(t){if(!pt(t))throw new se.IllegalArgument("Variation.removeNag()");return this._data.nags.delete(t)}tags(){let t=[];for(let n of this._data.tags.keys())t.push(n);return t.sort()}tag(t,n){if(!Vi(t))throw new se.IllegalArgument("Variation.tag()");if(arguments.length===1)return this._data.tags.get(t);if(arguments.length>=2)n==null?this._data.tags.delete(t):this._data.tags.set(t,String(n));else throw new se.IllegalArgument("Variation.tag()")}comment(t,n){if(arguments.length===0)return this._data.comment;t==null?(this._data.comment=void 0,this._data.isLongComment=!1):(this._data.comment=String(t),this._data.isLongComment=Boolean(n))}isLongComment(){return this._data.isLongComment&&gr(this._data)}parentNode(){return this._data.parent instanceof je?void 0:new Ie(this._data.parent,this._initialPosition)}first(){return this._data.child===void 0?void 0:new Ie(this._data.child,this._initialPosition)}nodes(){let t=[],n=this._data.child,r,i=this._initialPosition;for(;n!==void 0;)i=new Oe.Position(i),r!==void 0&&nt(i,r),t.push(new Ie(n,i)),r=n,n=n.child;return t}plyCount(){let t=0,n=this._data.child;for(;n!==void 0;)++t,n=n.child;return t}isLongVariation(){return gr(this._data)}initialPosition(){return new Oe.Position(this._initialPosition)}initialFullMoveNumber(){return this._data.parent instanceof je?this._data.parent._fullMoveNumber:this._data.parent.fullMoveNumber}play(t){let n=this._initialPosition.turn(),r=this.initialFullMoveNumber();return this._data.child=Fi(this._data,n,r,Li(this._initialPosition,t)),new Ie(this._data.child,this._initialPosition)}clearMoves(){this._data.child=void 0}}});var kn=x(Tn=>{"use strict";Object.defineProperty(Tn,"__esModule",{value:!0});Tn.Game=void 0;var It=cn(),Ae=Z(),mr=qt(),Kt=vt(),$i=Pn(),Mo=Ri(),Nt=Ve(),_r=class{constructor(){this._playerName=[void 0,void 0],this._playerElo=[void 0,void 0],this._playerTitle=[void 0,void 0],this._result=3,this._moveTreeRoot=new Mo.MoveTreeRoot}playerName(t,n){let r=(0,Nt.colorFromString)(t);if(r<0)throw new Ae.IllegalArgument("Game.playerName()");if(arguments.length===1)return this._playerName[r];this._playerName[r]=Ne(n)}playerElo(t,n){let r=(0,Nt.colorFromString)(t);if(r<0)throw new Ae.IllegalArgument("Game.playerElo()");if(arguments.length===1)return this._playerElo[r];if(n=Oo(n),n===void 0||Number.isInteger(n)&&n>=0)this._playerElo[r]=n;else throw new Ae.IllegalArgument("Game.playerElo()")}playerTitle(t,n){let r=(0,Nt.colorFromString)(t);if(r<0)throw new Ae.IllegalArgument("Game.playerTitle()");if(arguments.length===1)return this._playerTitle[r];this._playerTitle[r]=Ne(n)}event(t){if(arguments.length===0)return this._event;this._event=Ne(t)}round(t){if(arguments.length===0)return this._round;this._round=Ne(t)}date(t,n,r){switch(arguments.length){case 0:return this._date;case 1:if(t==null)this._date=void 0;else if(t instanceof It.DateValue)this._date=t;else if(t instanceof Date)this._date=new It.DateValue(t);else if(It.DateValue.isValid(t))this._date=new It.DateValue(t);else throw new Ae.IllegalArgument("Game.date()");break;default:if(It.DateValue.isValid(t,n,r))this._date=new It.DateValue(t,n,r);else throw new Ae.IllegalArgument("Game.date()");break}}dateAsDate(){return this._date===void 0?void 0:this._date.toDate()}dateAsString(t){return this._date===void 0?void 0:this._date.toHumanReadableString(t)}site(t){if(arguments.length===0)return this._site;this._site=Ne(t)}annotator(t){if(arguments.length===0)return this._annotator;this._annotator=Ne(t)}eco(t){if(arguments.length===0)return this._eco;if(t=Ne(t),t!==void 0&&!(0,mr.isValidECO)(t))throw new Ae.IllegalArgument("Game.eco()");this._eco=t}opening(t){if(arguments.length===0)return this._opening;this._opening=Ne(t)}openingVariation(t){if(arguments.length===0)return this._openingVariation;this._openingVariation=Ne(t)}openingSubVariation(t){if(arguments.length===0)return this._openingSubVariation;this._openingSubVariation=Ne(t)}termination(t){if(arguments.length===0)return this._termination;this._termination=Ne(t)}result(t){if(arguments.length===0)return(0,Nt.resultToString)(this._result);{let n=(0,Nt.resultFromString)(t);if(n<0)throw new Ae.IllegalArgument("Game.result()");this._result=n}}variant(){return this._moveTreeRoot._position.variant()}initialPosition(t,n){if(arguments.length===0)return new Kt.Position(this._moveTreeRoot._position);if(!(t instanceof Kt.Position))throw new Ae.IllegalArgument("Game.initialPosition()");if(arguments.length>=2){if(!Number.isInteger(n))throw new Ae.IllegalArgument("Game.initialPosition()");this._moveTreeRoot._fullMoveNumber=n}else this._moveTreeRoot._fullMoveNumber=1;this._moveTreeRoot._position=new Kt.Position(t),this._moveTreeRoot.clearTree()}mainVariation(){return this._moveTreeRoot.mainVariation()}nodes(t=!1){if(!t)return this.mainVariation().nodes();let n=[];function r(i){for(let a of i.nodes()){for(let s of a.variations())r(s);n.push(a)}}return r(this.mainVariation()),n}plyCount(){return this._moveTreeRoot.mainVariation().plyCount()}findById(t){return this._moveTreeRoot.findById(t)}ascii(){let t=[];function n(o){o!==void 0&&t.push(o)}n(Fo(this._event,this._round)),n(Ht("Site",this._site)),n(Ht("Date",this.dateAsString("en-us"))),n(qi("White",this._playerName[0],this._playerElo[0],this._playerTitle[0])),n(qi("Black",this._playerName[1],this._playerElo[1],this._playerTitle[1])),n(Ht("Annotator",this._annotator)),n(Ht("ECO",this._eco)),n(Lo(this._opening,this._openingVariation,this._openingSubVariation)),n(Ht("Termination",this._termination));let r=this._moveTreeRoot._position.variant();r!=="regular"&&t.push("Variant: "+r),(!(0,mr.variantWithCanonicalStartPosition)(r)||!Kt.Position.isEqual(this._moveTreeRoot._position,new Kt.Position(r)))&&t.push(this._moveTreeRoot._position.ascii());function i(o){return o.first()!==void 0||o.nags().length>0||o.tags().length>0||o.comment()!==void 0}function a(o,l,u){let d=l+o.fullMoveNumber()+(o.moveColor()==="w"?".":"...")+o.notation(),c=Gi(o);t.push(c.length===0?d:d+" "+c.join(" "));let m=!1;for(let _ of o.variations())i(_)&&(t.push(l+" |"),s(_,l+(u?" |  ":"    "),l+" +- ",!1),m=!0);return m}function s(o,l,u,d){let c=Gi(o);c.length>0&&t.push(u+c.join(" "));let m=o.first(),_=!1,E=!0;for(;m!==void 0;){_&&t.push(l+" |");let F=m.next();_=a(m,E&&c.length===0?u:l,d||F!==void 0),E=!1,m=F}}return s(this._moveTreeRoot.mainVariation(),"","",!1),t.push((0,Nt.resultToString)(this._result)),t.join(`
`)}};Tn.Game=_r;function Ne(e){return e==null?void 0:String(e)}function Oo(e){return e==null?void 0:Number(e)}function be(e){return e=(0,$i.trimAndCollapseSpaces)(e),e===""?"<empty>":e}function Ht(e,t){return t===void 0?void 0:`${e}: ${be(t)}`}function Fo(e,t){if(e===void 0&&t===void 0)return;let n=e===void 0?"Event: <undefined>":`Event: ${be(e)}`;return t!==void 0&&(n+=` (${be(t)})`),n}function qi(e,t,n,r){if(t===void 0&&n===void 0&&r===void 0)return;let i=t===void 0?`${e}: <undefined>`:`${e}: ${be(t)}`;return n!==void 0&&r!==void 0?i+=` (${be(r)} ${n})`:n!==void 0?i+=` (${n})`:r!==void 0&&(i+=` (${be(r)})`),i}function Lo(e,t,n){if(e===void 0&&t===void 0&&n===void 0)return;let r=e===void 0?"Opening: <undefined>":`Opening: ${be(e)}`;return n!==void 0?r+=` (${t===void 0?"<undefined>":be(t)}, ${be(n)})`:t!==void 0&&(r+=` (${be(t)})`),r}function Gi(e){let t=[];for(let r of e.nags())t.push((0,mr.nagSymbol)(r));for(let r of e.tags())t.push(`${r}={${(0,$i.trimAndCollapseSpaces)(e.tag(r))}}`);let n=e.comment();return n!==void 0&&t.push(be(n)),t}});var Mn=x(bt=>{"use strict";Object.defineProperty(bt,"__esModule",{value:!0});bt.Database=bt.isValidGameIndex=void 0;var xo=Z();function Bi(e){return Number.isInteger(e)&&e>=0}bt.isValidGameIndex=Bi;var vr=class{constructor(){}gameCount(){return this.doGameCount()}game(t){if(!Bi(t))throw new xo.IllegalArgument("Database.game()");return this.doGame(t)}};bt.Database=vr});var Ui=x(On=>{"use strict";Object.defineProperty(On,"__esModule",{value:!0});On.TokenStream=void 0;var pr=Z(),Ir=Me(),Nr=Pn();function Y(e,t){let n=e;return n.needIncrementLineIndex=t!==void 0&&t,n.matchedIndex=-1,n.matched=null,n}var Do=5,Vo=11,U=new Map;U.set("!!",3);U.set("!",1);U.set("!?",5);U.set("?!",6);U.set("?",2);U.set("??",4);U.set("+-",18);U.set("+/-",16);U.set("+/=",14);U.set("+=",14);U.set("=",10);U.set("~",13);U.set("inf",13);U.set("=/+",15);U.set("=+",15);U.set("-/+",17);U.set("-+",19);U.set("RR",145);U.set("N",146);var br=class{constructor(t,n){this._pos=0,this._lineIndex=1,this._token=0,this._tokenValue=null,this._tokenCharacterIndex=-1,this._tokenLineIndex=-1,this._emptyLineBeforeToken=!1,this._emptyLineAfterToken=!1,this._matchSpaces=Y(/[ \f\t\v]+/g),this._matchLineBreak=Y(/\r?\n|\r/g,!0),this._matchFastAdvance=Y(/[^ \f\t\v\r\n"{][^ \f\t\v\r\n"{10*]*/g),this._matchBeginHeader=Y(/\[/g),this._matchEndHeader=Y(/\]/g),this._matchHeaderId=Y(/(\w+)/g),this._matchEnterHeaderValue=Y(/"/g),this._matchMoveNumber=Y(/[0-9]+\.(?:\.\.)?/g),this._matchMove=Y(/(?:O-O(?:-O)?|0-0(?:-0)?|[KQRBN][a-h]?[1-8]?x?[a-h][1-8]|(?:[a-h]x?)?[a-h][1-8](?:=?[KQRBNP])?)[+#]?|--/g),this._matchNag=Y(/([!?][!?]?|\+\/?[-=]|[-=]\/?\+|=|inf|~|RR|N)|\$([1-9][0-9]*)/g),this._matchEnterComment=Y(/\{/g),this._matchBeginVariation=Y(/\(/g),this._matchEndVariation=Y(/\)/g),this._matchEndOfGame=Y(/1-0|0-1|1\/2-1\/2|\*/g),this._headerValueMode=Y(/((?:[^\\"\f\t\v\r\n]|\\[^\f\t\v\r\n])*)"/g),this._headerValueDegradedMode=Y(/[^\r\n]*/g),this._commentMode=Y(/((?:[^\\}]|\\(?:.|[\r\n]))*)\}/g,!0),t.codePointAt(0)===65279&&(t=t.substring(1)),this._text=t,n!==void 0&&(this._pos=n.pos,this._lineIndex=n.lineIndex)}text(){return this._text}currentLocation(){return{pos:this._pos,lineIndex:this._lineIndex}}emptyLineBeforeToken(){return this._emptyLineBeforeToken}emptyLineAfterToken(){return this._emptyLineAfterToken}token(){return this._token}tokenValue(){return this._tokenValue}tokenCharacterIndex(){return this._tokenCharacterIndex}tokenLineIndex(){return this._tokenLineIndex}isMoveTextSection(){return this._token>=Do&&this._token<=Vo}consumeToken(){if(this._emptyLineBeforeToken=this._token===0||this._token===11?this.skipBlanks():this._emptyLineAfterToken,this._pos>=this._text.length)return this._tokenCharacterIndex=this._text.length,this._tokenLineIndex=this._lineIndex,!1;if(this._tokenCharacterIndex=this._pos,this._tokenLineIndex=this._lineIndex,this.testAtPos(this._matchMoveNumber))this._token=5,this._tokenValue=null;else if(this.testAtPos(this._matchMove))this._token=6,this._tokenValue=this._matchMove.matched[0];else if(this.testAtPos(this._matchNag))this._token=7,this._tokenValue=this._matchNag.matched[2]===void 0?U.get(this._matchNag.matched[1]):parseInt(this._matchNag.matched[2],10);else if(this.testAtPos(this._matchEnterComment)){if(!this.testAtPos(this._commentMode))throw new pr.InvalidPGN(this._text,this._pos,this._lineIndex,Ir.i18n.INVALID_PGN_TOKEN);this._token=8,this._tokenValue=qo(this._commentMode.matched[1])}else if(this.testAtPos(this._matchBeginVariation))this._token=9,this._tokenValue=null;else if(this.testAtPos(this._matchEndVariation))this._token=10,this._tokenValue=null;else if(this.testAtPos(this._matchEndOfGame))this._token=11,this._tokenValue=this._matchEndOfGame.matched[0];else if(this.testAtPos(this._matchBeginHeader))this._token=1,this._tokenValue=null;else if(this.testAtPos(this._matchEndHeader))this._token=2,this._tokenValue=null;else if(this.testAtPos(this._matchHeaderId))this._token=3,this._tokenValue=this._matchHeaderId.matched[1];else if(this.testAtPos(this._matchEnterHeaderValue)){if(!this.testAtPos(this._headerValueMode))throw new pr.InvalidPGN(this._text,this._pos,this._lineIndex,Ir.i18n.INVALID_PGN_TOKEN);this._token=4,this._tokenValue=Ro(this._headerValueMode.matched[1])}else throw new pr.InvalidPGN(this._text,this._pos,this._lineIndex,Ir.i18n.INVALID_PGN_TOKEN);return this._emptyLineAfterToken=this._token===11?!1:this.skipBlanks(),!0}skipGame(){let t=!1;for(this._token=0;;){if(this.skipBlanks(),this._pos>=this._text.length)return t;if(t=!0,this.testAtPos(this._matchEnterComment)){if(!this.testAtPos(this._commentMode))return this._pos=this._text.length,!0}else if(this.testAtPos(this._matchEnterHeaderValue))this.testAtPos(this._headerValueMode)||this.testAtPos(this._headerValueDegradedMode);else{if(this.testAtPos(this._matchEndOfGame))return!0;this.testAtPos(this._matchFastAdvance)}}}skipBlanks(){let t=0;for(;this._pos<this._text.length;)if(!this.testAtPos(this._matchSpaces))if(this.testAtPos(this._matchLineBreak))++t;else break;return t>=2}testAtPos(t){if(t.matchedIndex<this._pos&&(t.lastIndex=this._pos,t.matched=t.exec(this._text),t.matchedIndex=t.matched===null?this._text.length:t.matched.index),t.matchedIndex===this._pos){if(this._pos=t.lastIndex,t.needIncrementLineIndex){let n=/\r?\n|\r/g;for(;n.exec(t.matched[0]);)++this._lineIndex}return!0}else return!1}};On.TokenStream=br;function Ro(e){return(0,Nr.trimAndCollapseSpaces)(e.replace(/\\([\\"])/g,"$1"))}function qo(e){e=e.replace(/\\([\\}])/g,"$1");let t=new Map,n=e.replace(/\[%(\w+)\s([^[\]]*)\]/g,(r,i,a)=>(a=(0,Nr.trimAndCollapseSpaces)(a),a!==""&&t.set(i,a)," "));return n=(0,Nr.trimAndCollapseSpaces)(n),n===""&&(n=void 0),{comment:n,tags:t}}});var Yi=x(wt=>{"use strict";Object.defineProperty(wt,"__esModule",{value:!0});wt.readOneGame=wt.readDatabase=void 0;var Go=Mn(),Fe=cn(),z=Z(),$o=kn(),Ki=qt(),ne=Me(),Wi=jt(),wr=vt(),Er=Ui();function Yt(e){return e==="?"?void 0:e}function ji(e){if(/^\d+$/.test(e)){let t=Number(e);if(Number.isInteger(t))return t}}function Bo(e){if(/^([0-9]{4})\.([0-9]{2})\.([0-9]{2})$/.test(e)){let t=RegExp.$1,n=RegExp.$2,r=RegExp.$3,i=parseInt(t,10),a=parseInt(n,10),s=parseInt(r,10);return Fe.DateValue.isValid(i,a,s)?new Fe.DateValue(i,a,s):Fe.DateValue.isValid(i,a)?new Fe.DateValue(i,a):new Fe.DateValue(i)}else if(/^([0-9]{4})\.([0-9]{2})\.\?\?$/.test(e)){let t=RegExp.$1,n=RegExp.$2,r=parseInt(t,10),i=parseInt(n,10);return Fe.DateValue.isValid(r,i)?new Fe.DateValue(r,i):new Fe.DateValue(r)}else if(/^([0-9]{4})(?:\.\?\?\.\?\?)?$/.test(e)){let t=parseInt(RegExp.$1,10);return new Fe.DateValue(t)}else return}function Uo(e){return(0,Ki.isValidECO)(e)?e:void 0}function Wo(e){return e=e.toLowerCase(),e==="regular"||e==="standard"?"regular":e==="fischerandom"||/^chess[ -]?960$/.test(e)?"chess960":/^no[ -]king$/.test(e)?"no-king":/^white[ -]king[ -]only$/.test(e)?"white-king-only":/^black[ -]king[ -]only$/.test(e)?"black-king-only":/^anti[ -]?chess/.test(e)?"antichess":e==="horde"?"horde":void 0}function jo(e,t,n,r,i,a,s){switch(i=i.trim(),r){case"White":t.playerName("w",Yt(i));break;case"Black":t.playerName("b",Yt(i));break;case"WhiteElo":t.playerElo("w",ji(i));break;case"BlackElo":t.playerElo("b",ji(i));break;case"WhiteTitle":t.playerTitle("w",i);break;case"BlackTitle":t.playerTitle("b",i);break;case"Event":t.event(Yt(i));break;case"Round":t.round(Yt(i));break;case"Date":t.date(Bo(i));break;case"Site":t.site(Yt(i));break;case"Annotator":t.annotator(i);break;case"ECO":t.eco(Uo(i));break;case"Opening":t.opening(i);break;case"Variation":t.openingVariation(i);break;case"SubVariation":t.openingSubVariation(i);break;case"Termination":t.termination(i);break;case"FEN":n.fen=i,n.fenTokenCharacterIndex=a,n.fenTokenLineIndex=s;break;case"Variant":if(n.variant=Wo(i),n.variant===void 0)throw new z.InvalidPGN(e.text(),a,s,ne.i18n.UNKNOWN_VARIANT,i);n.variantTokenCharacterIndex=a,n.variantTokenLineIndex=s;break}}function Ko(e,t,n){if(n.fen!==void 0)try{let r=n.variant===void 0?new wr.Position:new wr.Position(n.variant,"empty"),i=r.fen(n.fen);t.initialPosition(r,i.fullMoveNumber)}catch(r){throw r instanceof z.InvalidFEN?new z.InvalidPGN(e.text(),n.fenTokenCharacterIndex,n.fenTokenLineIndex,ne.i18n.INVALID_FEN_IN_PGN_TEXT,r.message):r}else if(n.variant!==void 0)if((0,Ki.variantWithCanonicalStartPosition)(n.variant)){let r=new wr.Position(n.variant,"start");t.initialPosition(r,1)}else throw new z.InvalidPGN(e.text(),n.variantTokenCharacterIndex,n.variantTokenLineIndex,ne.i18n.VARIANT_WITHOUT_FEN,n.variant)}function Hi(e){let t=null,n=null,r=[],i={};for(;e.consumeToken();)switch(t===null&&(t=new $o.Game),e.isMoveTextSection()&&n===null&&(Ko(e,t,i),n=t.mainVariation()),e.token()){case 1:{if(n!==null)throw new z.InvalidPGN(e.text(),e.tokenCharacterIndex(),e.tokenLineIndex(),ne.i18n.UNEXPECTED_PGN_HEADER);if(!e.consumeToken()||e.token()!==3)throw new z.InvalidPGN(e.text(),e.tokenCharacterIndex(),e.tokenLineIndex(),ne.i18n.MISSING_PGN_HEADER_ID);let a=e.tokenValue();if(!e.consumeToken()||e.token()!==4)throw new z.InvalidPGN(e.text(),e.tokenCharacterIndex(),e.tokenLineIndex(),ne.i18n.MISSING_PGN_HEADER_VALUE);let s=e.tokenValue(),o=e.tokenCharacterIndex(),l=e.tokenLineIndex();if(!e.consumeToken()||e.token()!==2)throw new z.InvalidPGN(e.text(),e.tokenCharacterIndex(),e.tokenLineIndex(),ne.i18n.MISSING_END_OF_PGN_HEADER);jo(e,t,i,a,s,o,l);break}case 5:break;case 6:try{n=n.play(e.tokenValue())}catch(a){throw a instanceof z.InvalidNotation?new z.InvalidPGN(e.text(),e.tokenCharacterIndex(),e.tokenLineIndex(),ne.i18n.INVALID_MOVE_IN_PGN_TEXT,a.notation,a.message):a}break;case 7:n.addNag(e.tokenValue());break;case 8:{let a=e.tokenValue();for(let[s,o]of a.tags)n.tag(s,o);if(a.comment!==void 0){let s=n instanceof Wi.Variation?e.emptyLineAfterToken():e.emptyLineBeforeToken();n.comment(a.comment,s)}break}case 9:if(n instanceof Wi.Variation)throw new z.InvalidPGN(e.text(),e.tokenCharacterIndex(),e.tokenLineIndex(),ne.i18n.UNEXPECTED_BEGIN_OF_VARIATION);r.push(n),n=n.addVariation(e.emptyLineBeforeToken());break;case 10:if(r.length===0)throw new z.InvalidPGN(e.text(),e.tokenCharacterIndex(),e.tokenLineIndex(),ne.i18n.UNEXPECTED_END_OF_VARIATION);n=r.pop();break;case 11:if(r.length!==0)throw new z.InvalidPGN(e.text(),e.tokenCharacterIndex(),e.tokenLineIndex(),ne.i18n.UNEXPECTED_END_OF_GAME);return t.result(e.tokenValue()),t;default:throw new z.InvalidPGN(e.text(),e.tokenCharacterIndex(),e.tokenLineIndex(),ne.i18n.INVALID_PGN_TOKEN)}throw new z.InvalidPGN(e.text(),e.tokenCharacterIndex(),e.tokenLineIndex(),ne.i18n.UNEXPECTED_END_OF_TEXT)}var Sr=class extends Go.Database{constructor(t){for(super(),this._currentGameIndex=-1,this._text=t,this._gameLocations=[],this._stream=new Er.TokenStream(t);;){let n=this._stream.currentLocation();if(!this._stream.skipGame())break;this._gameLocations.push(n)}}doGameCount(){return this._gameLocations.length}doGame(t){if(t>=this._gameLocations.length)throw new z.InvalidPGN(this._text,-1,-1,ne.i18n.INVALID_GAME_INDEX,t,this._gameLocations.length);this._currentGameIndex!==t&&(this._stream=new Er.TokenStream(this._text,this._gameLocations[t])),this._currentGameIndex=-1;let n=Hi(this._stream);return this._currentGameIndex=t+1,n}};function Ho(e){return new Sr(e)}wt.readDatabase=Ho;function Yo(e,t){let n=new Er.TokenStream(e),r=0;for(;r!==t;)if(n.skipGame())++r;else throw new z.InvalidPGN(e,-1,-1,ne.i18n.INVALID_GAME_INDEX,t,r);return Hi(n)}wt.readOneGame=Yo});var na=x(Et=>{"use strict";Object.defineProperty(Et,"__esModule",{value:!0});Et.writeGames=Et.writeGame=void 0;var zo=qt(),Xo=jt(),zi=vt(),Fn=Pn();function Ji(e){return e.replace(/([\\"])/g,"\\$1")}function Xi(e){return e.replace(/([\\}])/g,"\\$1")}function zt(e){return e!==void 0&&(e=(0,Fn.trimAndCollapseSpaces)(e)),e?Ji(e):"?"}function Qo(e){return e===void 0?"????.??.??":e.toPGNString()}function Jo(e){switch(e){case"regular":return;case"chess960":return"Fischerandom";case"antichess":return"Antichess";case"horde":return"Horde";default:return e}}function Le(e,t){return t!==void 0&&(t=(0,Fn.trimAndCollapseSpaces)(t)),t?`[${e} "${Ji(t)}"]
`:""}function Qi(e,t){return t===void 0?"":`[${e} "${t}"]
`}function Zi(e,t,n,r){for(let l of e.nags())n("$"+l,!1,!1);let i=e.comment();i!==void 0&&(i=(0,Fn.trimAndCollapseSpaces)(i));let a=e.tags(),s=new Map,o=!1;for(let l of a){let u=(0,Fn.trimAndCollapseSpaces)(e.tag(l).replace(/[[\]]/g,""));u&&(s.set(l,u),o=!0)}if(o||i){i&&e.isLongComment()&&e instanceof Xo.Node&&r(),n("{",!1,!0);for(let l of a){let u=s.get(l);if(u){n("[%"+l,!1,!1);for(let d of Xi(u+"]").split(" "))n(d,!1,!1)}}if(i)for(let l of Xi(i).split(" "))n(l,!1,!1);return n("}",!0,!1),i&&e.isLongComment()&&t&&r(),!0}else return!1}function Zo(e,t,n,r,i){e.moveColor()==="w"?r(e.fullMoveNumber()+".",!1,!1):t&&r(e.fullMoveNumber()+"...",!1,!1),r(e.notation(),!1,!1);let a=e.variations(),s=-1;for(let l=a.length-1;l>=0;--l)if(a[l].first()!==void 0){s=l;break}let o=Zi(e,(n||e.next()!==void 0)&&s<0,r,i);for(let l=0;l<a.length;++l){let u=a[l];u.first()!==void 0&&(u.isLongVariation()&&i(),r("(",!1,!0),ea(u,!1,r,i),r(")",!0,!1),l===s&&u.isLongVariation()&&i(),o=!0)}return o}function ea(e,t,n,r){Zi(e,!0,n,r);let i=e.first(),a=!0;for(;i!==void 0;)a=Zo(i,a,t,n,r),i=i.next()}function ta(e,t){let n="";n+=`[Event "${zt(e.event())}"]
`,n+=`[Site "${zt(e.site())}"]
`,n+=`[Date "${Qo(e.date())}"]
`,n+=`[Round "${zt(e.round())}"]
`,n+=`[White "${zt(e.playerName("w"))}"]
`,n+=`[Black "${zt(e.playerName("b"))}"]
`,n+=`[Result "${e.result()}"]
`;let r=e.variant(),i=e.initialPosition(),a=!(0,zo.variantWithCanonicalStartPosition)(r)||!zi.Position.isEqual(i,new zi.Position(r));n+=Le("Annotator",e.annotator()),n+=Qi("BlackElo",e.playerElo("b")),n+=Le("BlackTitle",e.playerTitle("b")),n+=Le("ECO",e.eco()),a&&(n+=`[FEN "${i.fen({fullMoveNumber:e.mainVariation().initialFullMoveNumber(),regularFENIfPossible:!0})}"]
`),n+=Le("Opening",e.opening()),t.withPlyCount&&(n+=`[PlyCount "${e.plyCount()}"]
`),a&&(n+=`[SetUp "1"]
`),n+=Le("SubVariation",e.openingSubVariation()),n+=Le("Termination",e.termination()),n+=Le("Variant",Jo(r)),n+=Le("Variation",e.openingVariation()),n+=Qi("WhiteElo",e.playerElo("w")),n+=Le("WhiteTitle",e.playerTitle("w")),n+=`
`;let s="",o=!1;function l(d,c,m){s.length===0?s=d:s.length+d.length+(o||c?0:1)<=80?s+=(o||c?"":" ")+d:(n+=s+`
`,s=d),o=m}function u(){n+=s+`
`,n+=`
`,s="",o=!1}return ea(e.mainVariation(),!0,l,u),l(e.result(),!1,!1),n+=s+`
`,n}Et.writeGame=ta;function el(e,t){return e.map(n=>ta(n,t)).join(`

`)}Et.writeGames=el});var sa=x(St=>{"use strict";Object.defineProperty(St,"__esModule",{value:!0});St.pgnWrite=St.pgnRead=void 0;var tl=Mn(),Pr=Z(),ra=kn(),ia=Yi(),aa=na();function nl(e,t){if(typeof e!="string")throw new Pr.IllegalArgument("pgnRead()");if(arguments.length===1)return(0,ia.readDatabase)(e);if(!(0,tl.isValidGameIndex)(t))throw new Pr.IllegalArgument("pgnRead()");return(0,ia.readOneGame)(e,t)}St.pgnRead=nl;function rl(e,t){if(t==null&&(t={}),e instanceof ra.Game)return(0,aa.writeGame)(e,t);if(Array.isArray(e)&&e.every(n=>n instanceof ra.Game))return(0,aa.writeGames)(e,t);throw new Pr.IllegalArgument("pgnWrite()")}St.pgnWrite=rl});var ua=x(v=>{"use strict";Object.defineProperty(v,"__esModule",{value:!0});v.pgnWrite=v.pgnRead=v.Database=v.Game=v.Variation=v.Node=v.AbstractNode=v.Position=v.isMoveDescriptor=v.MoveDescriptor=v.DateValue=v.isValidECO=v.nagSymbol=v.variantWithCanonicalStartPosition=v.oppositeColor=v.coordinatesToSquare=v.squareToCoordinates=v.squareColor=v.forEachSquare=v.exception=v.i18n=void 0;var il=Me();Object.defineProperty(v,"i18n",{enumerable:!0,get:function(){return il.i18n}});v.exception=Z();var Ke=qt();Object.defineProperty(v,"forEachSquare",{enumerable:!0,get:function(){return Ke.forEachSquare}});Object.defineProperty(v,"squareColor",{enumerable:!0,get:function(){return Ke.squareColor}});Object.defineProperty(v,"squareToCoordinates",{enumerable:!0,get:function(){return Ke.squareToCoordinates}});Object.defineProperty(v,"coordinatesToSquare",{enumerable:!0,get:function(){return Ke.coordinatesToSquare}});Object.defineProperty(v,"oppositeColor",{enumerable:!0,get:function(){return Ke.oppositeColor}});Object.defineProperty(v,"variantWithCanonicalStartPosition",{enumerable:!0,get:function(){return Ke.variantWithCanonicalStartPosition}});Object.defineProperty(v,"nagSymbol",{enumerable:!0,get:function(){return Ke.nagSymbol}});Object.defineProperty(v,"isValidECO",{enumerable:!0,get:function(){return Ke.isValidECO}});var al=cn();Object.defineProperty(v,"DateValue",{enumerable:!0,get:function(){return al.DateValue}});var oa=er();Object.defineProperty(v,"MoveDescriptor",{enumerable:!0,get:function(){return oa.MoveDescriptor}});Object.defineProperty(v,"isMoveDescriptor",{enumerable:!0,get:function(){return oa.isMoveDescriptor}});var sl=vt();Object.defineProperty(v,"Position",{enumerable:!0,get:function(){return sl.Position}});var Cr=jt();Object.defineProperty(v,"AbstractNode",{enumerable:!0,get:function(){return Cr.AbstractNode}});Object.defineProperty(v,"Node",{enumerable:!0,get:function(){return Cr.Node}});Object.defineProperty(v,"Variation",{enumerable:!0,get:function(){return Cr.Variation}});var ol=kn();Object.defineProperty(v,"Game",{enumerable:!0,get:function(){return ol.Game}});var ll=Mn();Object.defineProperty(v,"Database",{enumerable:!0,get:function(){return ll.Database}});var la=sa();Object.defineProperty(v,"pgnRead",{enumerable:!0,get:function(){return la.pgnRead}});Object.defineProperty(v,"pgnWrite",{enumerable:!0,get:function(){return la.pgnWrite}})});var xn=st(require("fs")),j=st(Wn()),yt=st(ua());var Ln=st(require("fs")),Ct=st(Wn()),fa=require("child_process");var Pt=class{constructor(t,n){q(this,"score");q(this,"type");this.score=t,this.type=n}toString(){switch(this.type){case"cp":return this.score;case"syzygy":return`solved score ${this.score}`;case"mate":return`mate in ${this.score}`;case"lowerbound":return`>= ${this.score}`;case"upperbound":return`<= ${this.score}`;default:return""}}},Xt=class{constructor(t){q(this,"instance");q(this,"buffer");q(this,"timeout");q(this,"startTime",process.hrtime.bigint());q(this,"noMoves",!1);q(this,"lines",new Map);q(this,"depth",0);q(this,"turn");q(this,"engineOptions",[]);q(this,"duration",0);q(this,"lastFen","");q(this,"lastReady",0n);q(this,"ascii",[]);q(this,"syzygy",{wdl:void 0,dtz:void 0});q(this,"name");q(this,"info",[]);q(this,"options",{lines:1,depth:10,maxTime:0,engine:"",nnue:"",syzygy:"",debug:!1,maxScore:10,options:[]});q(this,"state");if(t?.depth&&(this.options.depth=t.depth),t?.lines&&(this.options.lines=t.lines),t?.maxTime&&(this.options.maxTime=t.maxTime),t?.debug&&(this.options.debug=t.debug),t?.engine&&(this.options.engine=t.engine),t?.syzygy&&(this.options.syzygy=t.syzygy),t?.nnue&&(this.options.nnue=t.nnue),t?.options&&(this.options.options=t.options),!Ln.existsSync(this.options.engine))throw new Error(`uci: engine not found: ${this.options.engine}`);if(!Ln.statSync(this.options.engine).isFile())throw new Error(`uci: engine not valid: ${this.options.engine}`);this.instance=(0,fa.spawn)(this.options.engine),this.buffer=Buffer.alloc(0),this.instance.stdout?.on("data",n=>{this.options.debug&&Ct.data("uci",{stdout:n.toString()}),n=Buffer.concat([this.buffer,n]);let r=n.lastIndexOf(`
`);r!==n.length-1?this.buffer=n.slice(r+1):this.buffer=Buffer.alloc(0),this.process(n.slice(0,r).toString())}),this.send("compiler"),this.send("uci"),this.send("setoption name UCI_AnalyseMode value true"),this.send("setoption name Ponder value false"),this.options.nnue.length>0?(this.send(`setoption name EvalFile value ${this.options.nnue}`),this.send("setoption name Use NNUE value true")):this.send("setoption name Use NNUE value false");for(let n of this.options.options)this.send(`setoption name ${n}`);this.options.syzygy.length>0&&this.send(`setoption name SyzygyPath value ${this.options.syzygy}`),this.send("go depth 1"),this.send("stop"),this.send("isready"),this.state="starting",this.reset()}async reset(){this.startTime=process.hrtime.bigint(),this.duration=0,this.lines=new Map,this.depth=0,this.noMoves=!1,this.ascii=[],this.state="busy",this.send("stop"),this.send("ucinewgame"),this.send("position startpos"),this.send("isready"),await this.ready()}async ready(){return new Promise(t=>{let n=setInterval(()=>{(this.state==="ready"||this.state==="terminated")&&(this.lastReady=process.hrtime.bigint(),clearInterval(n),t(!0)),this.lastReady>0n&&Number(process.hrtime.bigint()-this.lastReady)/1e3/1e3>2*this.options.maxTime&&(this.send("stop"),this.send("isready"))},5)})}set fen(t){this.lastFen=t,this.noMoves=!1,this.send(`position fen ${t}`),this.turn=t.split(" ")[1]==="b"?"black":"white"}get fen(){return this.lastFen}get validOptions(){return this.engineOptions}set move(t){this.send(`position startpos moves ${t}`),this.turn=t.split(" ").length%2?"black":"white"}start(t){this.state="busy",this.startTime=process.hrtime.bigint(),this.lines=new Map,this.depth=0,t?.depth&&t?.depth>0&&(this.options.depth=t.depth),t?.lines&&t?.lines>0&&(this.options.lines=t.lines),t?.maxTime&&t?.maxTime>0&&(this.options.maxTime=t.maxTime),this.options.lines>1&&this.send(`setoption name MultiPV value ${this.options.lines}`),this.options.depth>0?this.send(`go depth ${this.options.depth}`):this.send("go infinite"),this.timeout&&clearTimeout(this.timeout),this.options.maxTime&&this.options.maxTime>0&&(this.timeout=setTimeout(()=>this.send("stop"),this.options.maxTime))}async stop(){this.send("stop"),this.state="stopping",await this.ready()}async board(){return this.ascii=[],this.state="busy",this.send("d"),this.send("isready"),await this.ready(),this.ascii.join(`
`)}async play(t){return this.fen=t,this.start(),await this.ready(),this.best}async solve(){await this.board();let t=this.syzygy.wdl?{wdl:this.syzygy.wdl||""}:void 0;return this.syzygy.dtz&&t&&(t.dtz=this.syzygy.dtz),t}process(t){let n=t.split(`
`).map(r=>r.trim()).filter(r=>r.length>0);for(let r of n)if(r.startsWith("id name")&&(this.name=r.replace("id name ","")),r.startsWith("option")&&this.engineOptions.push(r.replace("option name ","")),r.startsWith("uciok")&&(this.state="started"),(r.startsWith("readyok")||r.startsWith("bestmove")||r.startsWith("error"))&&(this.duration=Number((process.hrtime.bigint()-this.startTime)/1000n/1000n),this.state="ready"),!(this.state!=="ready"&&this.state!=="busy")){if(r.startsWith("info")){if(r.includes(" pv "))this.processInfo(r);else if(r.includes("mate 0")||r.includes("cp 0"))this.noMoves=!0;else if(r.startsWith("info string")){let i=r.replace("info string ","");this.info.includes(i)||this.info.push(i)}else if(r.includes("currmove"))continue}if(r.startsWith("Tablebases")&&this.processSolve(r),r.startsWith("|")){let i=r.replace(/[1-8,|]/g,"");this.ascii.push(i)}if(r.startsWith("Compil")){let i=r.replace("Compiled by","").replace("Compilation settings include:","").trim();this.info.includes(i)||this.info.push(i)}}}processSolve(t){let n=t.split(" ").map(l=>l.trim()).filter(l=>l),r=l=>n.findIndex(u=>u===l)+1,i=l=>r(l)>0?n[r(l)]:void 0,a=l=>Number(i(l)),s=i("WDL:"),o=a("DTZ:");s&&(this.syzygy.wdl=s),o&&(this.syzygy.dtz=o)}processInfo(t){if(t.indexOf(" score ")===-1||t.indexOf(" depth ")===-1)return;let n=t.split(" ").map(re=>re.trim()),r=re=>n.findIndex(ye=>ye===re)+1,i=re=>n[r(re)],a=re=>Number(i(re)),s=a("seldepth")||a("depth")||0,o=a("multipv")||1,l=a("tbhits")||0,u=a("nodes")||0,d=i("score"),c=Number(n[r("score")+1])||0,m;switch(d){case"cp":m=new Pt(c/100,"cp");break;case"lowerbound":m=new Pt(c/100,"lowerbound");break;case"upperbound":m=new Pt(c/100,"upperbound");break;case"mate":m=new Pt(c,"mate");break;default:Ct.data("uci: unknown score type",{scoreType:d})}if(!m)return;this.turn==="black"&&(m.score*=-1);let _=n.slice(r("pv")),E={score:m,moves:_,nodes:u,tb:l},F=this.lines.get(s)||new Array(this.options.lines);F[o-1]=E,this.lines.set(s,F),s>this.depth&&(this.depth=s)}get best(){if(this.noMoves)return{depth:0,time:0,lines:[{score:{type:"mate",score:0},nodes:0,tb:0,moves:[]}]};let t=this.lines.get(this.depth)||[];return{depth:this.depth,time:this.duration,lines:t.filter(n=>n)}}send(t){this.instance?.stdin?.writable&&!this.instance.exitCode?this.instance?.stdin?.write(`${t}
`):(Ct.error("uci: send failed",{pid:this.instance?.pid,command:t,code:this.instance?.exitCode,killed:this.instance?.killed,signal:this.instance?.signalCode}),this.state="terminated")}terminate(){this.state="terminated",!this.instance.exitCode&&(this.send("stop"),this.send("quit"),setTimeout(()=>this.instance.kill("SIGTERM"),10),setTimeout(()=>this.instance.kill("SIGKILL"),100),setTimeout(()=>{this.options.debug&&Ct.data("engine exit",{code:this.instance.exitCode,signal:this.instance.signalCode})},200))}};var ca=st(require("fs")),At=[],fl=(e,t)=>{if(t.length<e.length)return!1;let n=!0;for(let r=0;r<e.length;r++)if(e[r]!==t[r]){n=!1;break}return n},Ar=(e="src/openings.json")=>{let t=ca.readFileSync(e,"utf8");At=JSON.parse(t),At.forEach(n=>n.uciMoves=n.uci?.split(" ")||[]),At.forEach(n=>n.agMoves=n.pgn?.replace(/[0-9]?[0-9]\. /g,"").split(" ")||[]),At.forEach(n=>n.depth=n.uciMoves?.length||0)},ha=e=>{At.length===0&&Ar();let t=At.find(n=>n.uciMoves.length===e.length&&fl(e,n.uciMoves));if(t)return t};var W,cl=["a1","b1","c1","d1","e1","f1","g1","h1","a2","b2","c2","d2","e2","f2","g2","h2","a3","b3","c3","d3","e3","f3","g3","h3","a4","b4","c4","d4","e4","f4","g4","h4","a5","b5","c5","d5","e5","f5","g5","h5","a6","b6","c6","d6","e6","f6","g6","h6","a7","b7","c7","d7","e7","f7","g7","h7","a8","b8","c8","d8","e8","f8","g8","h8"];async function hl(e,t,n){await e.reset(),await t.reset();let r=new yt.Game;r.date(new Date),r.event("battle"),r.playerName("w",e.name?.toLocaleLowerCase()),r.playerName("b",t.name?.toLocaleLowerCase()),r.annotator("https://github.com/vladmandic/chess"),r.site("https://github.com/vladmandic/chess"),r.playerTitle("w",`depth:${e.options.depth} maxtime:${e.options.maxTime}`),r.playerTitle("b",`depth:${t.options.depth} maxtime:${t.options.maxTime}`),r.round(n.toString()),r.result("*");let i=new yt.Position,a=[],s=[],o=[0,0],l=r.mainVariation();W.initialFEN||(W.initialFEN="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1");let u=W.initialFEN.split(" ")[1]||"w";i.fen(W.initialFEN),j.info("starting game",{round:n,side:u,fen:i.fen()});let d=i.fen();for(;;){if(e.state!=="ready"||t.state!=="ready"){j.warn("engine not ready, aborting");break}s.push(d);let c=u==="w"?await e.play(d):await t.play(d);if(c.lines.length<1)continue;o[u==="w"?0:1]+=c.time;let m=c.lines[0].moves[0];if(!m)continue;let _=i.uci(m),E=i.notation(_);a.push(m),i.play(E),l=l.play(E),d=i.fen();let F={turn:l.fullMoveNumber(),side:u,move:c.lines[0].moves[0],fen:d,time:c.time,depth:c.depth},re="";for(let we of cl){let it=i.square(we);it[0]==="w"?re+=it[1].toUpperCase():it[0]==="b"&&(re+=it[1])}if(F.pieces=re.length,W.solvedDepth&&re.length<=W.solvedDepth){let we=await e.solve();we&&(F.solved=we)}let ye=ha(a);ye&&(F.opening={eco:ye.eco,name:ye.name},r.eco(ye.eco),r.opening(ye.name));let Tt=s.filter(we=>we===F.fen).length;if(Tt>=1&&(F.repeat=Tt),i.isCheck()&&(F.check=!0),_.isCapture()&&(F.capture=_.capturedColoredPiece()),i.isCheckmate()&&(F.checkmate=!0),i.isStalemate()&&(F.stalemate=!0),i.isInsufficientMaterial()&&(F.insufficient=!0),c.lines[0].score.type==="cp"&&(F.score=c.lines[0].score.score),c.lines[0].score.type==="syzygy"&&(F.score=c.lines[0].score.score,F.solved=!0),c.lines[0].score.type==="mate"&&(F.mate=c.lines[0].score.score),j.info(F),!i.isLegal()){j.error("illegal position reached",i.fen());break}if(i.isCheckmate()){r.result(i.turn()==="w"?"0-1":"1-0"),r.termination((i.turn()==="w"?"Black":"White")+" wins");break}if(i.isStalemate()){r.termination("Stalemate"),r.result("1/2-1/2");break}if(i.isInsufficientMaterial()){r.termination("Insufficient material"),r.result("1/2-1/2");break}if(W.maxMoves&&l.fullMoveNumber()>=W.maxMoves){r.termination("Maxmimum moves reached");break}if(Tt>=3){r.termination("3-fold repetition"),r.result("1/2-1/2");break}u=u==="w"?"b":"w",i.turn(u)}return r.playerTitle("w",r.playerTitle("w")+` usedTime: ${o[0]} ms`),r.playerTitle("b",r.playerTitle("b")+` usedTime: ${o[1]} ms`),r}async function dl(){j.configure({inspect:{breakLength:400}}),j.headerJson();let e=process.argv[2]||"battle.json";j.info({configFile:e});let t=xn.readFileSync(e,"utf-8");W=JSON.parse(t),j.info("config",W),Ar(W.openings);let n=new Xt(W.engineOptions[0]);await n.ready(),j.state("engine white",{name:n.name,state:n.state});let r=new Xt(W.engineOptions[1]);await r.ready(),j.state("engine black",{name:r.name,state:r.state});let i="";W.numGames||(W.numGames=1);for(let a=1;a<=W.numGames;a++){let s=await hl(n,r,a);i+=yt.pgnWrite(s,{withPlyCount:!0})+`
`}W.pgnOutput?(xn.writeFileSync(W.pgnOutput,i,"utf-8"),j.data("pgn",{file:W.pgnOutput},`
${i}`)):j.data("pgn",`
${i}`),n.terminate(),r.terminate(),process.exit(0)}dl();
//# sourceMappingURL=battle.js.map
