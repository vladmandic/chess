/*
  Chess
  homepage: <https://github.com/vladmandic/chess>
  author: <https://github.com/vladmandic>'
*/

"use strict";var ys=Object.create;var rn=Object.defineProperty;var Cs=Object.getOwnPropertyDescriptor;var Ps=Object.getOwnPropertyNames;var As=Object.getPrototypeOf,ks=Object.prototype.hasOwnProperty;var Ts=(e,t,n)=>t in e?rn(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n;var D=(e,t)=>()=>(t||e((t={exports:{}}).exports,t),t.exports);var xi=(e,t,n,i)=>{if(t&&typeof t=="object"||typeof t=="function")for(let r of Ps(t))!ks.call(e,r)&&r!==n&&rn(e,r,{get:()=>t[r],enumerable:!(i=Cs(t,r))||i.enumerable});return e};var Se=(e,t,n)=>(n=e!=null?ys(As(e)):{},xi(t||!e||!e.__esModule?rn(n,"default",{value:e,enumerable:!0}):n,e)),Ms=e=>xi(rn({},"__esModule",{value:!0}),e);var M=(e,t,n)=>(Ts(e,typeof t!="symbol"?t+"":t,n),n);var mt=D((Ml,Zi)=>{"use strict";var Os=Object.create,cn=Object.defineProperty,Fs=Object.getOwnPropertyDescriptor,Wi=Object.getOwnPropertyNames,Ls=Object.getPrototypeOf,xs=Object.prototype.hasOwnProperty,Ds=(e,t)=>function(){return t||(0,e[Wi(e)[0]])((t={exports:{}}).exports,t),t.exports},Vs=(e,t)=>{for(var n in t)cn(e,n,{get:t[n],enumerable:!0})},ji=(e,t,n,i)=>{if(t&&typeof t=="object"||typeof t=="function")for(let r of Wi(t))!xs.call(e,r)&&r!==n&&cn(e,r,{get:()=>t[r],enumerable:!(i=Fs(t,r))||i.enumerable});return e},et=(e,t,n)=>(n=e!=null?Os(Ls(e)):{},ji(t||!e||!e.__esModule?cn(n,"default",{value:e,enumerable:!0}):n,e)),Rs=e=>ji(cn({},"__esModule",{value:!0}),e),qs=Ds({"node_modules/.pnpm/dayjs@1.11.4/node_modules/dayjs/dayjs.min.js"(e,t){(function(n,i){typeof e=="object"&&typeof t<"u"?t.exports=i():typeof define=="function"&&define.amd?define(i):(n=typeof globalThis<"u"?globalThis:n||self).dayjs=i()})(e,function(){"use strict";var n=1e3,i=6e4,r=36e5,s="millisecond",a="second",o="minute",l="hour",u="day",f="week",d="month",m="quarter",_="year",E="date",q="Invalid Date",le=/^(\d{4})[-/]?(\d{1,2})?[-/]?(\d{0,2})[Tt\s]*(\d{1,2})?:?(\d{1,2})?:?(\d{1,2})?[.:]?(\d+)?$/,L=/\[([^\]]+)]|Y{1,4}|M{1,4}|D{1,2}|d{1,4}|H{1,2}|h{1,2}|a|A|m{1,2}|s{1,2}|Z{1,2}|SSS/g,ft={name:"en",weekdays:"Sunday_Monday_Tuesday_Wednesday_Thursday_Friday_Saturday".split("_"),months:"January_February_March_April_May_June_July_August_September_October_November_December".split("_")},Ee=function(w,g,c){var v=String(w);return!v||v.length>=g?w:""+Array(g+1-v.length).join(c)+w},Je={s:Ee,z:function(w){var g=-w.utcOffset(),c=Math.abs(g),v=Math.floor(c/60),h=c%60;return(g<=0?"+":"-")+Ee(v,2,"0")+":"+Ee(h,2,"0")},m:function w(g,c){if(g.date()<c.date())return-w(c,g);var v=12*(c.year()-g.year())+(c.month()-g.month()),h=g.clone().add(v,d),N=c-h<0,I=g.clone().add(v+(N?-1:1),d);return+(-(v+(c-h)/(N?h-I:I-h))||0)},a:function(w){return w<0?Math.ceil(w)||0:Math.floor(w)},p:function(w){return{M:d,y:_,w:f,d:u,D:E,h:l,m:o,s:a,ms:s,Q:m}[w]||String(w||"").toLowerCase().replace(/s$/,"")},u:function(w){return w===void 0}},Me="en",H={};H[Me]=ft;var Ge=function(w){return w instanceof tn},en=function w(g,c,v){var h;if(!g)return Me;if(typeof g=="string"){var N=g.toLowerCase();H[N]&&(h=N),c&&(H[N]=c,h=N);var I=g.split("-");if(!h&&I.length>1)return w(I[0])}else{var T=g.name;H[T]=g,h=T}return!v&&h&&(Me=h),h||!v&&Me},j=function(w,g){if(Ge(w))return w.clone();var c=typeof g=="object"?g:{};return c.date=w,c.args=arguments,new tn(c)},x=Je;x.l=en,x.i=Ge,x.w=function(w,g){return j(w,{locale:g.$L,utc:g.$u,x:g.$x,$offset:g.$offset})};var tn=function(){function w(c){this.$L=en(c.locale,null,!0),this.parse(c)}var g=w.prototype;return g.parse=function(c){this.$d=function(v){var h=v.date,N=v.utc;if(h===null)return new Date(NaN);if(x.u(h))return new Date;if(h instanceof Date)return new Date(h);if(typeof h=="string"&&!/Z$/i.test(h)){var I=h.match(le);if(I){var T=I[2]-1||0,B=(I[7]||"0").substring(0,3);return N?new Date(Date.UTC(I[1],T,I[3]||1,I[4]||0,I[5]||0,I[6]||0,B)):new Date(I[1],T,I[3]||1,I[4]||0,I[5]||0,I[6]||0,B)}}return new Date(h)}(c),this.$x=c.x||{},this.init()},g.init=function(){var c=this.$d;this.$y=c.getFullYear(),this.$M=c.getMonth(),this.$D=c.getDate(),this.$W=c.getDay(),this.$H=c.getHours(),this.$m=c.getMinutes(),this.$s=c.getSeconds(),this.$ms=c.getMilliseconds()},g.$utils=function(){return x},g.isValid=function(){return this.$d.toString()!==q},g.isSame=function(c,v){var h=j(c);return this.startOf(v)<=h&&h<=this.endOf(v)},g.isAfter=function(c,v){return j(c)<this.startOf(v)},g.isBefore=function(c,v){return this.endOf(v)<j(c)},g.$g=function(c,v,h){return x.u(c)?this[v]:this.set(h,c)},g.unix=function(){return Math.floor(this.valueOf()/1e3)},g.valueOf=function(){return this.$d.getTime()},g.startOf=function(c,v){var h=this,N=!!x.u(v)||v,I=x.p(c),T=function(ht,ie){var Be=x.w(h.$u?Date.UTC(h.$y,ie,ht):new Date(h.$y,ie,ht),h);return N?Be:Be.endOf(u)},B=function(ht,ie){return x.w(h.toDate()[ht].apply(h.toDate("s"),(N?[0,0,0,0]:[23,59,59,999]).slice(ie)),h)},G=this.$W,X=this.$M,$e=this.$D,Oe="set"+(this.$u?"UTC":"");switch(I){case _:return N?T(1,0):T(31,11);case d:return N?T(1,X):T(0,X+1);case f:var Ft=this.$locale().weekStart||0,Lt=(G<Ft?G+7:G)-Ft;return T(N?$e-Lt:$e+(6-Lt),X);case u:case E:return B(Oe+"Hours",0);case l:return B(Oe+"Minutes",1);case o:return B(Oe+"Seconds",2);case a:return B(Oe+"Milliseconds",3);default:return this.clone()}},g.endOf=function(c){return this.startOf(c,!1)},g.$set=function(c,v){var h,N=x.p(c),I="set"+(this.$u?"UTC":""),T=(h={},h[u]=I+"Date",h[E]=I+"Date",h[d]=I+"Month",h[_]=I+"FullYear",h[l]=I+"Hours",h[o]=I+"Minutes",h[a]=I+"Seconds",h[s]=I+"Milliseconds",h)[N],B=N===u?this.$D+(v-this.$W):v;if(N===d||N===_){var G=this.clone().set(E,1);G.$d[T](B),G.init(),this.$d=G.set(E,Math.min(this.$D,G.daysInMonth())).$d}else T&&this.$d[T](B);return this.init(),this},g.set=function(c,v){return this.clone().$set(c,v)},g.get=function(c){return this[x.p(c)]()},g.add=function(c,v){var h,N=this;c=Number(c);var I=x.p(v),T=function(X){var $e=j(N);return x.w($e.date($e.date()+Math.round(X*c)),N)};if(I===d)return this.set(d,this.$M+c);if(I===_)return this.set(_,this.$y+c);if(I===u)return T(1);if(I===f)return T(7);var B=(h={},h[o]=i,h[l]=r,h[a]=n,h)[I]||1,G=this.$d.getTime()+c*B;return x.w(G,this)},g.subtract=function(c,v){return this.add(-1*c,v)},g.format=function(c){var v=this,h=this.$locale();if(!this.isValid())return h.invalidDate||q;var N=c||"YYYY-MM-DDTHH:mm:ssZ",I=x.z(this),T=this.$H,B=this.$m,G=this.$M,X=h.weekdays,$e=h.months,Oe=function(ie,Be,Wn,nn){return ie&&(ie[Be]||ie(v,N))||Wn[Be].slice(0,nn)},Ft=function(ie){return x.s(T%12||12,ie,"0")},Lt=h.meridiem||function(ie,Be,Wn){var nn=ie<12?"AM":"PM";return Wn?nn.toLowerCase():nn},ht={YY:String(this.$y).slice(-2),YYYY:this.$y,M:G+1,MM:x.s(G+1,2,"0"),MMM:Oe(h.monthsShort,G,$e,3),MMMM:Oe($e,G),D:this.$D,DD:x.s(this.$D,2,"0"),d:String(this.$W),dd:Oe(h.weekdaysMin,this.$W,X,2),ddd:Oe(h.weekdaysShort,this.$W,X,3),dddd:X[this.$W],H:String(T),HH:x.s(T,2,"0"),h:Ft(1),hh:Ft(2),a:Lt(T,B,!0),A:Lt(T,B,!1),m:String(B),mm:x.s(B,2,"0"),s:String(this.$s),ss:x.s(this.$s,2,"0"),SSS:x.s(this.$ms,3,"0"),Z:I};return N.replace(L,function(ie,Be){return Be||ht[ie]||I.replace(":","")})},g.utcOffset=function(){return 15*-Math.round(this.$d.getTimezoneOffset()/15)},g.diff=function(c,v,h){var N,I=x.p(v),T=j(c),B=(T.utcOffset()-this.utcOffset())*i,G=this-T,X=x.m(this,T);return X=(N={},N[_]=X/12,N[d]=X,N[m]=X/3,N[f]=(G-B)/6048e5,N[u]=(G-B)/864e5,N[l]=G/r,N[o]=G/i,N[a]=G/n,N)[I]||G,h?X:x.a(X)},g.daysInMonth=function(){return this.endOf(d).$D},g.$locale=function(){return H[this.$L]},g.locale=function(c,v){if(!c)return this.$L;var h=this.clone(),N=en(c,v,!0);return N&&(h.$L=N),h},g.clone=function(){return x.w(this.$d,this)},g.toDate=function(){return new Date(this.valueOf())},g.toJSON=function(){return this.isValid()?this.toISOString():null},g.toISOString=function(){return this.$d.toISOString()},g.toString=function(){return this.$d.toUTCString()},w}(),Li=tn.prototype;return j.prototype=Li,[["$ms",s],["$s",a],["$m",o],["$H",l],["$W",u],["$M",d],["$y",_],["$D",E]].forEach(function(w){Li[w[1]]=function(g){return this.$g(g,w[0],w[1])}}),j.extend=function(w,g){return w.$i||(w(g,tn,j),w.$i=!0),j},j.locale=en,j.isDayjs=Ge,j.unix=function(w){return j(1e3*w)},j.en=H[Me],j.Ls=H,j.p={},j})}}),Ki={};Vs(Ki,{access:()=>ra,accessFile:()=>Qi,assert:()=>ia,blank:()=>ua,client:()=>sa,clientFile:()=>Ji,configure:()=>aa,console:()=>va,data:()=>ha,debug:()=>pa,error:()=>ga,fatal:()=>ma,header:()=>oa,headerJson:()=>la,info:()=>ca,logFile:()=>Xi,options:()=>y,print:()=>Ce,ring:()=>sn,state:()=>fa,tags:()=>oe,timed:()=>na,verbose:()=>_a,warn:()=>da});Zi.exports=Rs(Ki);var Hi=et(require("os")),Ze=et(require("fs")),Fe=et(require("path")),Vt=et(qs()),jn=10,Di=(e=0)=>t=>`\x1B[${t+e}m`,Vi=(e=0)=>t=>`\x1B[${38+e};5;${t}m`,Ri=(e=0)=>(t,n,i)=>`\x1B[${38+e};2;${t};${n};${i}m`;function Gs(){let e=new Map,t={modifier:{reset:[0,0],bold:[1,22],dim:[2,22],italic:[3,23],underline:[4,24],overline:[53,55],inverse:[7,27],hidden:[8,28],strikethrough:[9,29]},color:{black:[30,39],red:[31,39],green:[32,39],yellow:[33,39],blue:[34,39],magenta:[35,39],cyan:[36,39],white:[37,39],blackBright:[90,39],redBright:[91,39],greenBright:[92,39],yellowBright:[93,39],blueBright:[94,39],magentaBright:[95,39],cyanBright:[96,39],whiteBright:[97,39]},bgColor:{bgBlack:[40,49],bgRed:[41,49],bgGreen:[42,49],bgYellow:[43,49],bgBlue:[44,49],bgMagenta:[45,49],bgCyan:[46,49],bgWhite:[47,49],bgBlackBright:[100,49],bgRedBright:[101,49],bgGreenBright:[102,49],bgYellowBright:[103,49],bgBlueBright:[104,49],bgMagentaBright:[105,49],bgCyanBright:[106,49],bgWhiteBright:[107,49]}};t.color.gray=t.color.blackBright,t.bgColor.bgGray=t.bgColor.bgBlackBright,t.color.grey=t.color.blackBright,t.bgColor.bgGrey=t.bgColor.bgBlackBright;for(let[n,i]of Object.entries(t)){for(let[r,s]of Object.entries(i))t[r]={open:`\x1B[${s[0]}m`,close:`\x1B[${s[1]}m`},i[r]=t[r],e.set(s[0],s[1]);Object.defineProperty(t,n,{value:i,enumerable:!1})}return Object.defineProperty(t,"codes",{value:e,enumerable:!1}),t.color.close="\x1B[39m",t.bgColor.close="\x1B[49m",t.color.ansi=Di(),t.color.ansi256=Vi(),t.color.ansi16m=Ri(),t.bgColor.ansi=Di(jn),t.bgColor.ansi256=Vi(jn),t.bgColor.ansi16m=Ri(jn),Object.defineProperties(t,{rgbToAnsi256:{value:(n,i,r)=>n===i&&i===r?n<8?16:n>248?231:Math.round((n-8)/247*24)+232:16+36*Math.round(n/255*5)+6*Math.round(i/255*5)+Math.round(r/255*5),enumerable:!1},hexToRgb:{value:n=>{let i=/(?<colorString>[a-f\d]{6}|[a-f\d]{3})/i.exec(n.toString(16));if(!i)return[0,0,0];let{colorString:r}=i.groups;r.length===3&&(r=[...r].map(a=>a+a).join(""));let s=Number.parseInt(r,16);return[s>>16&255,s>>8&255,s&255]},enumerable:!1},hexToAnsi256:{value:n=>t.rgbToAnsi256(...t.hexToRgb(n)),enumerable:!1},ansi256ToAnsi:{value:n=>{if(n<8)return 30+n;if(n<16)return 90+(n-8);let i,r,s;if(n>=232)i=((n-232)*10+8)/255,r=i,s=i;else{n-=16;let l=n%36;i=Math.floor(n/36)/5,r=Math.floor(l/6)/5,s=l%6/5}let a=Math.max(i,r,s)*2;if(a===0)return 30;let o=30+(Math.round(s)<<2|Math.round(r)<<1|Math.round(i));return a===2&&(o+=60),o},enumerable:!1},rgbToAnsi:{value:(n,i,r)=>t.ansi256ToAnsi(t.rgbToAnsi256(n,i,r)),enumerable:!1},hexToAnsi:{value:n=>t.ansi256ToAnsi(t.hexToAnsi256(n)),enumerable:!1}}),t}var $s=Gs(),ye=$s,zn=et(require("process"),1),Bs=et(require("os"),1),qi=et(require("tty"),1);function ue(e,t=zn.default.argv){let n=e.startsWith("-")?"":e.length===1?"-":"--",i=t.indexOf(n+e),r=t.indexOf("--");return i!==-1&&(r===-1||i<r)}var{env:U}=zn.default,on;ue("no-color")||ue("no-colors")||ue("color=false")||ue("color=never")?on=0:(ue("color")||ue("colors")||ue("color=true")||ue("color=always"))&&(on=1);function Us(){if("FORCE_COLOR"in U)return U.FORCE_COLOR==="true"?1:U.FORCE_COLOR==="false"?0:U.FORCE_COLOR.length===0?1:Math.min(Number.parseInt(U.FORCE_COLOR,10),3)}function Ws(e){return e===0?!1:{level:e,hasBasic:!0,has256:e>=2,has16m:e>=3}}function js(e,{streamIsTTY:t,sniffFlags:n=!0}={}){let i=Us();i!==void 0&&(on=i);let r=n?on:i;if(r===0)return 0;if(n){if(ue("color=16m")||ue("color=full")||ue("color=truecolor"))return 3;if(ue("color=256"))return 2}if(e&&!t&&r===void 0)return 0;let s=r||0;if(U.TERM==="dumb")return s;if(zn.default.platform==="win32"){let a=Bs.default.release().split(".");return Number(a[0])>=10&&Number(a[2])>=10586?Number(a[2])>=14931?3:2:1}if("CI"in U)return["TRAVIS","CIRCLECI","APPVEYOR","GITLAB_CI","GITHUB_ACTIONS","BUILDKITE","DRONE"].some(a=>a in U)||U.CI_NAME==="codeship"?1:s;if("TEAMCITY_VERSION"in U)return/^(9\.(0*[1-9]\d*)\.|\d{2,}\.)/.test(U.TEAMCITY_VERSION)?1:0;if("TF_BUILD"in U&&"AGENT_NAME"in U)return 1;if(U.COLORTERM==="truecolor")return 3;if("TERM_PROGRAM"in U){let a=Number.parseInt((U.TERM_PROGRAM_VERSION||"").split(".")[0],10);switch(U.TERM_PROGRAM){case"iTerm.app":return a>=3?3:2;case"Apple_Terminal":return 2}}return/-256(color)?$/i.test(U.TERM)?2:/^screen|^xterm|^vt100|^vt220|^rxvt|color|ansi|cygwin|linux/i.test(U.TERM)||"COLORTERM"in U?1:s}function Gi(e,t={}){let n=js(e,{streamIsTTY:e&&e.isTTY,...t});return Ws(n)}var Ks={stdout:Gi({isTTY:qi.default.isatty(1)}),stderr:Gi({isTTY:qi.default.isatty(2)})},Hs=Ks;function Ys(e,t,n){let i=e.indexOf(t);if(i===-1)return e;let r=t.length,s=0,a="";do a+=e.substr(s,i-s)+t+n,s=i+r,i=e.indexOf(t,s);while(i!==-1);return a+=e.slice(s),a}function zs(e,t,n,i){let r=0,s="";do{let a=e[i-1]==="\r";s+=e.substr(r,(a?i-1:i)-r)+t+(a?`\r
`:`
`)+n,r=i+1,i=e.indexOf(`
`,r)}while(i!==-1);return s+=e.slice(r),s}var{stdout:$i,stderr:Bi}=Hs,Kn=Symbol("GENERATOR"),dt=Symbol("STYLER"),xt=Symbol("IS_EMPTY"),Ui=["ansi","ansi","ansi256","ansi16m"],gt=Object.create(null),Xs=(e,t={})=>{if(t.level&&!(Number.isInteger(t.level)&&t.level>=0&&t.level<=3))throw new Error("The `level` option should be an integer from 0 to 3");let n=$i?$i.level:0;e.level=t.level===void 0?n:t.level},Qs=class{constructor(e){return Yi(e)}},Yi=e=>{let t=(...n)=>n.join(" ");return Xs(t,e),Object.setPrototypeOf(t,Rt.prototype),t};function Rt(e){return Yi(e)}Object.setPrototypeOf(Rt.prototype,Function.prototype);for(let[e,t]of Object.entries(ye))gt[e]={get(){let n=ln(this,Yn(t.open,t.close,this[dt]),this[xt]);return Object.defineProperty(this,e,{value:n}),n}};gt.visible={get(){let e=ln(this,this[dt],!0);return Object.defineProperty(this,"visible",{value:e}),e}};var Hn=(e,t,n,...i)=>e==="rgb"?t==="ansi16m"?ye[n].ansi16m(...i):t==="ansi256"?ye[n].ansi256(ye.rgbToAnsi256(...i)):ye[n].ansi(ye.rgbToAnsi(...i)):e==="hex"?Hn("rgb",t,n,...ye.hexToRgb(...i)):ye[n][e](...i),Js=["rgb","hex","ansi256"];for(let e of Js){gt[e]={get(){let{level:n}=this;return function(...i){let r=Yn(Hn(e,Ui[n],"color",...i),ye.color.close,this[dt]);return ln(this,r,this[xt])}}};let t="bg"+e[0].toUpperCase()+e.slice(1);gt[t]={get(){let{level:n}=this;return function(...i){let r=Yn(Hn(e,Ui[n],"bgColor",...i),ye.bgColor.close,this[dt]);return ln(this,r,this[xt])}}}}var Zs=Object.defineProperties(()=>{},{...gt,level:{enumerable:!0,get(){return this[Kn].level},set(e){this[Kn].level=e}}}),Yn=(e,t,n)=>{let i,r;return n===void 0?(i=e,r=t):(i=n.openAll+e,r=t+n.closeAll),{open:e,close:t,openAll:i,closeAll:r,parent:n}},ln=(e,t,n)=>{let i=(...r)=>ea(i,r.length===1?""+r[0]:r.join(" "));return Object.setPrototypeOf(i,Zs),i[Kn]=e,i[dt]=t,i[xt]=n,i},ea=(e,t)=>{if(e.level<=0||!t)return e[xt]?"":t;let n=e[dt];if(n===void 0)return t;let{openAll:i,closeAll:r}=n;if(t.includes("\x1B"))for(;n!==void 0;)t=Ys(t,n.close,n.open),n=n.parent;let s=t.indexOf(`
`);return s!==-1&&(t=zs(t,r,i,s)),i+t+r};Object.defineProperties(Rt.prototype,gt);var kl=Rt(),Tl=Rt({level:Bi?Bi.level:0}),zi=require("console"),ge=new Qs({level:2}),sn=[],y={dateFormat:"YYYY-MM-DD HH:mm:ss",ringLength:100,console:!0,timeStamp:!0},A={logFile:!1,accessFile:!1,clientFile:!1,logStream:void 0,accessStream:void 0,clientStream:void 0},oe={blank:"",continue:":     ",info:ge.cyan("INFO: "),warn:ge.yellow("WARN: "),data:ge.green("DATA: "),error:ge.red("ERROR:"),fatal:ge.bold.red("FATAL:"),assert:ge.italic.bold.red("ASSERT:"),timed:ge.magentaBright("TIMED:"),state:ge.magenta("STATE:"),verbose:ge.bgGray.yellowBright("VERB: "),debug:ge.bgGray.redBright("DEBUG:"),console:ge.gray("CONSOLE:")},an={showHidden:!1,depth:5,colors:!0,showProxy:!0,maxArrayLength:1024,maxStringLength:10240,breakLength:200,compact:64,sorted:!1,getters:!1},un=new zi.Console({stdout:process.stdout,stderr:process.stderr,ignoreErrors:!0,inspectOptions:an});function ta(e){let t="";try{t=JSON.stringify(e)}catch{}return t}function Dt(...e){let t="";for(let n of e)t+=typeof n=="object"?ta(n):n,t+=" ";return t}function Ce(...e){let t=(0,Vt.default)(Date.now()).format(y.dateFormat);y.console&&(y.timeStamp?un.log(t,...e):un.log(...e))}function Xi(e){typeof e=="string"&&(y.logFile=e,A.logFile=!0,A.logStream=Ze.createWriteStream(Fe.resolve(y.logFile||""),{flags:"a"}),A.logStream&&A.logStream.on("error",t=>{Ce(oe.error,"Cannot open application log",y.logFile,t),A.logFile=!1}))}function Qi(e){typeof e=="string"&&(y.accessFile=e,A.accessFile=!0,A.accessStream=Ze.createWriteStream(Fe.resolve(y.accessFile),{flags:"a"}),A.accessStream&&A.accessStream.on("error",t=>{Ce(oe.error,"Cannot open application log",y.accessFile,t),A.accessFile=!1}))}function Ji(e){typeof e=="string"&&(y.clientFile=e,A.clientFile=!0,A.clientStream=Ze.createWriteStream(Fe.resolve(y.clientFile),{flags:"a"}),A.clientStream&&A.clientStream.on("error",t=>{Ce(oe.error,"Cannot open application log",y.clientFile,t),A.clientFile=!1}))}async function na(e,...t){arguments.length<2&&(t=[e],e=process.hrtime.bigint());let n=process.hrtime.bigint(),i=0;try{i=parseInt((n-e).toString())}catch{}i=Math.round(i/1e6);let r=(0,Vt.default)(Date.now()).format(y.dateFormat);y.console&&un.log(r,oe.timed,`${i.toLocaleString()} ms`,...t),A.logFile&&A.logStream&&A.logStream.write(`${oe.timed} ${r} ${i.toLocaleString()} ms ${Dt(...t)}
`)}async function J(e,...t){let n=(0,Vt.default)(Date.now()).format(y.dateFormat);oe[e]?Ce(oe[e],...t):Ce(...t),A.logFile&&A.logStream&&A.logStream.write(`${n} ${oe[e]} ${Dt(...t)}
`),sn.push({tag:e,time:n,msg:Dt(...t)}),sn.length>y.ringLength&&sn.shift()}async function ia(e,t,...n){e!==t&&J("assert",...n,{res:e,exp:t})}async function ra(...e){let t=(0,Vt.default)(Date.now()).format(y.dateFormat);A.accessFile&&A.accessStream&&A.accessStream.write(`${t} ${Dt(...e)}
`)}async function sa(...e){let t=(0,Vt.default)(Date.now()).format(y.dateFormat);A.clientFile&&A.clientStream&&A.clientStream.write(`${t} ${Dt(...e)}
`)}function aa(e){!e||(e.dateFormat&&(y.dateFormat=e.dateFormat),e.ringLength&&(y.ringLength=e.ringLength),e.logFile&&Xi(e.logFile),e.accessFile&&Qi(e.accessFile),e.clientFile&&Ji(e.clientFile),e.inspect&&(an={...an,...e.inspect}),un=new zi.Console({stdout:process.stdout,stderr:process.stderr,ignoreErrors:!0,inspectOptions:an}))}function oa(){let e="./package.json";if(!Ze.existsSync(e))return;let t=JSON.parse(Ze.readFileSync(e).toString());process.title=t.name,J("info",t.name,"version",t.version),J("info","User:",Hi.userInfo().username,"Platform:",process.platform,"Arch:",process.arch,"Node:",process.version),y.logFile&&A.logFile&&Ce(oe.state,"Application log:",Fe.resolve(y.logFile)),y.accessFile&&A.accessFile&&Ce(oe.state,"Access log:",Fe.resolve(y.accessFile)),y.clientFile&&A.clientFile&&Ce(oe.state,"Client log:",Fe.resolve(y.clientFile))}function la(){let e="./package.json";if(!Ze.existsSync(e))return;let t=JSON.parse(Ze.readFileSync(e).toString());process.title=t.name,J("info",{application:t.name,version:t.version}),J("info",{user:Hi.userInfo().username,platform:process.platform,arch:process.arch,node:process.version}),(y.logFile||y.accessFile||y.clientFile)&&Ce(oe.state,{log:Fe.resolve(y.logFile||""),access:Fe.resolve(y.accessFile||""),client:Fe.resolve(y.clientFile||"")})}var ua=(...e)=>J("blank",...e),ca=(...e)=>J("info",...e),fa=(...e)=>J("state",...e),ha=(...e)=>J("data",...e),da=(...e)=>J("warn",...e),ga=(...e)=>J("error",...e),ma=(...e)=>J("fatal",...e),_a=(...e)=>J("verbose",...e),pa=(...e)=>J("debug",...e),va=(...e)=>J("console",...e)});var Le=D(qt=>{"use strict";Object.defineProperty(qt,"__esModule",{value:!0});qt.i18n=void 0;var Ia;(function(e){e.WRONG_NUMBER_OF_FEN_FIELDS="A FEN string must contain exactly 6 space-separated fields.",e.WRONG_NUMBER_OF_SUBFIELDS_IN_BOARD_FIELD="The 1st field of a FEN string must contain exactly 8 `/`-separated subfields.",e.UNEXPECTED_CHARACTER_IN_BOARD_FIELD="Unexpected character in the 1st field of the FEN string: `{0}`.",e.UNEXPECTED_END_OF_SUBFIELD_IN_BOARD_FIELD="Subfield {0} of the FEN string 1st field is unexpectedly short.",e.INVALID_TURN_FIELD="The 2nd field of a FEN string must be either `w` or `b`.",e.INVALID_CASTLING_FIELD="The 3rd field of a FEN string must be either `-` or a list of characters among `K`, `Q`, `k` and `q` (in this order).",e.INVALID_EN_PASSANT_FIELD="The 4th field of a FEN string must be either `-` or a square from the 3rd or 6th rank where en-passant is allowed.",e.WRONG_RANK_IN_EN_PASSANT_FIELD="The rank number indicated in the FEN string 4th field is inconsistent with respect to the 2nd field.",e.INEFFECTIVE_EN_PASSANT_FIELD="No en-passant capture can happen on file {0} in the position defined in the FEN string.",e.INVALID_HALF_MOVE_COUNT_FIELD="The 5th field of a FEN string must be a number, indicating the number of half-move since the last pawn move or capture.",e.INVALID_MOVE_NUMBER_FIELD="The 6th field of a FEN string must be a number, indicating the move number of the game.",e.INVALID_VARIANT_PREFIX="Invalid variant prefix: `{0}`.",e.INVALID_UCI_NOTATION_SYNTAX="The syntax of the UCI notation is invalid.",e.ILLEGAL_UCI_MOVE="The UCI move is not legal.",e.INVALID_MOVE_NOTATION_SYNTAX="The syntax of the move notation is invalid.",e.ILLEGAL_POSITION="The position is not legal.",e.ILLEGAL_NO_KING_CASTLING="Castling is not legal in the considered position as it has no king.",e.ILLEGAL_QUEEN_SIDE_CASTLING="Queen-side castling is not legal in the considered position.",e.ILLEGAL_KING_SIDE_CASTLING="King-side castling is not legal in the considered position.",e.NO_PIECE_CAN_MOVE_TO="No {0} can move to {1}.",e.NO_PIECE_CAN_MOVE_TO_DISAMBIGUATION="No {0} on the specified rank/file can move to {1}.",e.REQUIRE_DISAMBIGUATION="Cannot determine uniquely which {0} is supposed to move to {1}.",e.WRONG_DISAMBIGUATION_SYMBOL="Wrong disambiguation symbol (expected: `{0}`, observed: `{1}`).",e.CASTLING_MOVE_ENCODED_WITH_ZERO="Capital O must be used for castling moves (instead of digit 0).",e.TRYING_TO_CAPTURE_YOUR_OWN_PIECES="Capturing its own pieces is not legal.",e.CAPTURE_IS_MANDATORY="Capture is mandatory.",e.INVALID_PIECE_SYMBOL="Character `{0}` is not a valid piece symbol.",e.INVALID_PIECE_SYMBOL_COLOR="Invalid color for piece symbol `{0}`.",e.INVALID_CAPTURING_PAWN_MOVE="Invalid capturing pawn move.",e.INVALID_NON_CAPTURING_PAWN_MOVE="Invalid non-capturing pawn move.",e.NOT_SAFE_FOR_WHITE_KING="This move would let the white king in check.",e.NOT_SAFE_FOR_BLACK_KING="This move would let the black king in check.",e.MISSING_PROMOTION="A promoted piece must be specified for this move.",e.MISSING_PROMOTION_SYMBOL="Character `=` is required to specify a promoted piece.",e.INVALID_PROMOTED_PIECE="{0} cannot be specified as a promoted piece.",e.ILLEGAL_PROMOTION="Specifying a promoted piece is illegal for this move.",e.ILLEGAL_NULL_MOVE="Cannot play a null-move in this position.",e.MISSING_CAPTURE_SYMBOL="Capture symbol `x` is missing.",e.INVALID_CAPTURE_SYMBOL="This move is not a capture move.",e.WRONG_CHECK_CHECKMATE_SYMBOL="Wrong check/checkmate symbol (expected: `{0}`, observed: `{1}`).",e.INVALID_PGN_TOKEN="Unrecognized character or group of characters.",e.INVALID_MOVE_IN_PGN_TEXT="Invalid move ({0}). {1}",e.INVALID_FEN_IN_PGN_TEXT="Invalid FEN string in the initial position header. {0}",e.UNEXPECTED_PGN_HEADER="Unexpected PGN game header.",e.MISSING_PGN_HEADER_ID="Missing or invalid PGN game header ID.",e.MISSING_PGN_HEADER_VALUE="Missing or invalid PGN game header value.",e.MISSING_END_OF_PGN_HEADER="Missing or invalid end of PGN game header.",e.UNEXPECTED_BEGIN_OF_VARIATION="Unexpected begin of variation.",e.UNEXPECTED_END_OF_VARIATION="Unexpected end of variation.",e.UNEXPECTED_END_OF_GAME="Unexpected end of game: there are pending variations.",e.UNEXPECTED_END_OF_TEXT="Unexpected end of text: there is a pending game.",e.INVALID_GAME_INDEX="Game index {0} is invalid (only {1} game(s) found in the PGN data).",e.UNKNOWN_VARIANT="Unknown chess game variant ({0}).",e.VARIANT_WITHOUT_FEN="For game variant {0}, the FEN header is mandatory."})(Ia=qt.i18n||(qt.i18n={}))});var Z=D(Pe=>{"use strict";Object.defineProperty(Pe,"__esModule",{value:!0});Pe.InvalidPGN=Pe.InvalidNotation=Pe.InvalidFEN=Pe.IllegalArgument=void 0;var Xn=class{constructor(t){this.functionName=t}toString(){return`Illegal argument in function ${this.functionName}`}};Pe.IllegalArgument=Xn;var Qn=class{constructor(t,n,...i){this.fen=t,this.message=ei(n,i)}toString(){return ti("InvalidFEN",this.message)}};Pe.InvalidFEN=Qn;var Jn=class{constructor(t,n,i,...r){this.fen=t,this.notation=n,this.message=ei(i,r)}toString(){return ti("InvalidNotation",this.message)}};Pe.InvalidNotation=Jn;var Zn=class{constructor(t,n,i,r,...s){this.pgn=t,this.index=n,this.lineNumber=i,this.message=ei(r,s)}toString(){return ti("InvalidPGN",`[character=${this.index} line=${this.lineNumber}] ${this.message}`)}};Pe.InvalidPGN=Zn;function ei(e,t){return e.replace(/{(\d+)}/g,(n,i)=>{let r=Number(i);return r<t.length?t[r]:n})}function ti(e,t){return e+" -> "+t}});var xe=D(b=>{"use strict";Object.defineProperty(b,"__esModule",{value:!0});b.squareColorImpl=b.coloredPieceFromString=b.coloredPieceToString=b.squareFromString=b.squareToString=b.variantFromString=b.resultFromString=b.fileFromString=b.rankFromString=b.figurineFromString=b.pieceFromString=b.colorFromString=b.variantToString=b.resultToString=b.fileToString=b.rankToString=b.figurineToString=b.pieceToString=b.colorToString=void 0;var fn=[..."wb"],hn=[..."kqrbnp"],er=[..."\u2654\u265A\u2655\u265B\u2656\u265C\u2657\u265D\u2658\u265E\u2659\u265F"],dn=[..."12345678"],gn=[..."abcdefgh"],tr=["1-0","0-1","1/2-1/2","*"],nr=["regular","chess960","no-king","white-king-only","black-king-only","antichess","horde"];function Na(e){return fn[e]}b.colorToString=Na;function ba(e){return hn[e]}b.pieceToString=ba;function wa(e){return er[e]}b.figurineToString=wa;function Ea(e){return dn[e]}b.rankToString=Ea;function Sa(e){return gn[e]}b.fileToString=Sa;function ya(e){return tr[e]}b.resultToString=ya;function Ca(e){return nr[e]}b.variantToString=Ca;function Pa(e){return fn.indexOf(e)}b.colorFromString=Pa;function Aa(e){return hn.indexOf(e)}b.pieceFromString=Aa;function ka(e){return er.indexOf(e)}b.figurineFromString=ka;function Ta(e){return dn.indexOf(e)}b.rankFromString=Ta;function Ma(e){return gn.indexOf(e)}b.fileFromString=Ma;function Oa(e){return tr.indexOf(e)}b.resultFromString=Oa;function Fa(e){return nr.indexOf(e)}b.variantFromString=Fa;function La(e){return gn[e%16]+dn[Math.trunc(e/16)]}b.squareToString=La;function xa(e){if(typeof e!="string"||!/^[a-h][1-8]$/.test(e))return-1;let t=gn.indexOf(e[0]);return dn.indexOf(e[1])*16+t}b.squareFromString=xa;function Da(e){return fn[e%2]+hn[Math.trunc(e/2)]}b.coloredPieceToString=Da;function Va(e){if(typeof e!="string"||!/^[wb][kqrbnp]$/.test(e))return-1;let t=fn.indexOf(e[0]);return hn.indexOf(e[1])*2+t}b.coloredPieceFromString=Va;function Ra(e){return(~e^e>>4)&1}b.squareColorImpl=Ra});var Gt=D(ce=>{"use strict";Object.defineProperty(ce,"__esModule",{value:!0});ce.makeCopy=ce.make960FromScharnagl=ce.makeInitial=ce.makeEmpty=ce.hasCanonicalStartPosition=void 0;var qa=[-1,-1,-1,-1,-1,-1,-1,-1,-2,-2,-2,-2,-2,-2,-2,-2,-1,-1,-1,-1,-1,-1,-1,-1,-2,-2,-2,-2,-2,-2,-2,-2,-1,-1,-1,-1,-1,-1,-1,-1,-2,-2,-2,-2,-2,-2,-2,-2,-1,-1,-1,-1,-1,-1,-1,-1,-2,-2,-2,-2,-2,-2,-2,-2,-1,-1,-1,-1,-1,-1,-1,-1,-2,-2,-2,-2,-2,-2,-2,-2,-1,-1,-1,-1,-1,-1,-1,-1,-2,-2,-2,-2,-2,-2,-2,-2,-1,-1,-1,-1,-1,-1,-1,-1,-2,-2,-2,-2,-2,-2,-2,-2,-1,-1,-1,-1,-1,-1,-1,-1],ir=[4,8,6,2,0,6,8,4,-2,-2,-2,-2,-2,-2,-2,-2,10,10,10,10,10,10,10,10,-2,-2,-2,-2,-2,-2,-2,-2,-1,-1,-1,-1,-1,-1,-1,-1,-2,-2,-2,-2,-2,-2,-2,-2,-1,-1,-1,-1,-1,-1,-1,-1,-2,-2,-2,-2,-2,-2,-2,-2,-1,-1,-1,-1,-1,-1,-1,-1,-2,-2,-2,-2,-2,-2,-2,-2,-1,-1,-1,-1,-1,-1,-1,-1,-2,-2,-2,-2,-2,-2,-2,-2,11,11,11,11,11,11,11,11,-2,-2,-2,-2,-2,-2,-2,-2,5,9,7,3,1,7,9,5],Ga=[10,10,10,10,10,10,10,10,-2,-2,-2,-2,-2,-2,-2,-2,10,10,10,10,10,10,10,10,-2,-2,-2,-2,-2,-2,-2,-2,10,10,10,10,10,10,10,10,-2,-2,-2,-2,-2,-2,-2,-2,10,10,10,10,10,10,10,10,-2,-2,-2,-2,-2,-2,-2,-2,-1,10,10,-1,-1,10,10,-1,-2,-2,-2,-2,-2,-2,-2,-2,-1,-1,-1,-1,-1,-1,-1,-1,-2,-2,-2,-2,-2,-2,-2,-2,11,11,11,11,11,11,11,11,-2,-2,-2,-2,-2,-2,-2,-2,5,9,7,3,1,7,9,5],rr=[{board:ir,castling:[129,129],king:[4,116]},null,null,null,null,{board:ir,castling:[0,0],king:[-1,-1]},{board:Ga,castling:[0,129],king:[-1,116]}];function $a(e){return rr[e]!==null}ce.hasCanonicalStartPosition=$a;function Ba(e){return{board:qa.slice(),turn:0,castling:[0,0],enPassant:-1,variant:e,legal:e===2,king:[-1,-1],effectiveCastling:[0,0],effectiveEnPassant:-1}}ce.makeEmpty=Ba;function Ua(e){let t=rr[e];return{board:t.board.slice(),turn:0,castling:t.castling.slice(),enPassant:-1,variant:e,legal:!0,king:t.king.slice(),effectiveCastling:t.castling.slice(),effectiveEnPassant:-1}}ce.makeInitial=Ua;function Wa(e){let t=ja(e),n=t.pieceScheme.map(r=>r*2+0),i=t.pieceScheme.map(r=>r*2+1);return{board:[n[0],n[1],n[2],n[3],n[4],n[5],n[6],n[7],-2,-2,-2,-2,-2,-2,-2,-2,10,10,10,10,10,10,10,10,-2,-2,-2,-2,-2,-2,-2,-2,-1,-1,-1,-1,-1,-1,-1,-1,-2,-2,-2,-2,-2,-2,-2,-2,-1,-1,-1,-1,-1,-1,-1,-1,-2,-2,-2,-2,-2,-2,-2,-2,-1,-1,-1,-1,-1,-1,-1,-1,-2,-2,-2,-2,-2,-2,-2,-2,-1,-1,-1,-1,-1,-1,-1,-1,-2,-2,-2,-2,-2,-2,-2,-2,11,11,11,11,11,11,11,11,-2,-2,-2,-2,-2,-2,-2,-2,i[0],i[1],i[2],i[3],i[4],i[5],i[6],i[7]],turn:0,castling:[t.castling,t.castling],enPassant:-1,variant:1,legal:!0,king:[0+t.kingFile,112+t.kingFile],effectiveCastling:[t.castling,t.castling],effectiveEnPassant:-1}}ce.make960FromScharnagl=Wa;function ja(e){let t=[-1,-1,-1,-1,-1,-1,-1,-1],n=0,i=-1;function r(a){let o=0;for(let l=0;l<8;++l)t[l]>=0||(a(l,o),++o)}function s(a,o,l){r((u,f)=>{(f===o||f===l)&&(t[u]=a)})}switch(t[e%4*2+1]=3,e=Math.trunc(e/4),t[e%4*2]=3,e=Math.trunc(e/4),s(1,e%6,-1),e=Math.trunc(e/6),e){case 0:s(4,0,1);break;case 1:s(4,0,2);break;case 2:s(4,0,3);break;case 3:s(4,0,4);break;case 4:s(4,1,2);break;case 5:s(4,1,3);break;case 6:s(4,1,4);break;case 7:s(4,2,3);break;case 8:s(4,2,4);break;case 9:s(4,3,4);break}return r((a,o)=>{o===1?(t[a]=0,i=a):(t[a]=2,n|=1<<a)}),{pieceScheme:t,castling:n,kingFile:i}}function Ka(e){return{board:e.board.slice(),turn:e.turn,castling:e.castling.slice(),enPassant:e.enPassant,variant:e.variant,legal:e.legal,king:e.king.slice(),effectiveCastling:e.effectiveCastling===null?null:e.effectiveCastling.slice(),effectiveEnPassant:e.effectiveEnPassant}}ce.makeCopy=Ka});var $t=D(K=>{"use strict";Object.defineProperty(K,"__esModule",{value:!0});K.isValidECO=K.nagSymbol=K.variantWithCanonicalStartPosition=K.oppositeColor=K.coordinatesToSquare=K.squareToCoordinates=K.squareColor=K.forEachSquare=void 0;var _t=Z(),Ae=xe(),Ha=Gt();function Ya(e){for(let t=0;t<8;++t)for(let n=0;n<8;++n)e((0,Ae.squareToString)(t*16+n))}K.forEachSquare=Ya;function za(e){let t=(0,Ae.squareFromString)(e);if(t<0)throw new _t.IllegalArgument("squareColor()");return(0,Ae.colorToString)((0,Ae.squareColorImpl)(t))}K.squareColor=za;function Xa(e){let t=(0,Ae.squareFromString)(e);if(t<0)throw new _t.IllegalArgument("squareToCoordinates()");return{rank:Math.trunc(t/16),file:t%16}}K.squareToCoordinates=Xa;function Qa(e,t){let n=typeof e=="number"?e:e.file,i=typeof e=="number"?t:e.rank;if(!Number.isInteger(n)||!Number.isInteger(i)||n<0||n>=8||i<0||i>=8)throw new _t.IllegalArgument("coordinatesToSquare()");return(0,Ae.fileToString)(n)+(0,Ae.rankToString)(i)}K.coordinatesToSquare=Qa;function Ja(e){let t=(0,Ae.colorFromString)(e);if(t<0)throw new _t.IllegalArgument("oppositeColor()");return(0,Ae.colorToString)(1-t)}K.oppositeColor=Ja;function Za(e){let t=(0,Ae.variantFromString)(e);if(t<0)throw new _t.IllegalArgument("variantWithCanonicalStartPosition()");return(0,Ha.hasCanonicalStartPosition)(t)}K.variantWithCanonicalStartPosition=Za;var k=new Map;k.set(1,"!");k.set(2,"?");k.set(3,"!!");k.set(4,"??");k.set(5,"!?");k.set(6,"?!");k.set(7,"\u25A1");k.set(8,"\u25A1");k.set(10,"=");k.set(11,"=");k.set(13,"\u221E");k.set(14,"\u2A72");k.set(15,"\u2A71");k.set(16,"\xB1");k.set(17,"\u2213");k.set(18,"+\u2212");k.set(19,"\u2212+");k.set(22,"\u2A00");k.set(32,"\u27F3");k.set(36,"\u2191");k.set(40,"\u2192");k.set(132,"\u21C6");k.set(138,"\u2A01");k.set(140,"\u2206");k.set(141,"\u2207");k.set(142,"\u2313");k.set(143,"\u2264");k.set(145,"RR");k.set(146,"N");function eo(e){if(!Number.isInteger(e)||e<0)throw new _t.IllegalArgument("nagSymbol()");let t=k.get(e);return t===void 0?"$"+e:t}K.nagSymbol=eo;function to(e){return/^[A-E][0-9][0-9]$/.test(e)}K.isValidECO=to});var mn=D(We=>{"use strict";var Ue=We&&We.__classPrivateFieldSet||function(e,t,n,i,r){if(i==="m")throw new TypeError("Private method is not writable");if(i==="a"&&!r)throw new TypeError("Private accessor was defined without a setter");if(typeof t=="function"?e!==t||!r:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return i==="a"?r.call(e,n):r?r.value=n:t.set(e,n),n},R=We&&We.__classPrivateFieldGet||function(e,t,n,i){if(n==="a"&&!i)throw new TypeError("Private accessor was defined without a getter");if(typeof t=="function"?e!==t||!i:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return n==="m"?i:n==="a"?i.call(e):i?i.value:t.get(e)},pt,me,fe,_e;Object.defineProperty(We,"__esModule",{value:!0});We.DateValue=void 0;var ni=Z(),ri=class{constructor(t,n,i){if(pt.set(this,void 0),me.set(this,void 0),fe.set(this,void 0),_e.set(this,void 0),t instanceof Date)Ue(this,pt,"ymd","f"),Ue(this,me,t.getFullYear(),"f"),Ue(this,fe,t.getMonth()+1,"f"),Ue(this,_e,t.getDate(),"f");else{let r=ar(t,n,i);if(!r)throw new ni.IllegalArgument("DateValue()");Ue(this,pt,r,"f"),Ue(this,me,t,"f"),Ue(this,fe,n===null?void 0:n,"f"),Ue(this,_e,i===null?void 0:i,"f")}}type(){return R(this,pt,"f")}year(){return R(this,me,"f")}month(){if(R(this,fe,"f")===void 0)throw new ni.IllegalArgument("DateValue.month()");return R(this,fe,"f")}day(){if(R(this,_e,"f")===void 0)throw new ni.IllegalArgument("DateValue.day()");return R(this,_e,"f")}toDate(){let t=R(this,fe,"f")===void 0?0:R(this,fe,"f")-1,n=R(this,_e,"f")===void 0?1:R(this,_e,"f");return new Date(R(this,me,"f"),t,n)}toString(){return sr(R(this,me,"f"),R(this,fe,"f"),R(this,_e,"f"),"-","**")}toPGNString(){return sr(R(this,me,"f"),R(this,fe,"f"),R(this,_e,"f"),".","??")}toHumanReadableString(t){switch(R(this,pt,"f")){case"ymd":{let n=new Date(R(this,me,"f"),R(this,fe,"f")-1,R(this,_e,"f"));return new Intl.DateTimeFormat(t,{dateStyle:"long"}).format(n)}case"ym":{let n=new Date(R(this,me,"f"),R(this,fe,"f")-1,1);return new Intl.DateTimeFormat(t,{month:"long",year:"numeric"}).format(n)}default:return String(R(this,me,"f"))}}static isValid(t,n,i){return Boolean(ar(t,n,i))}};We.DateValue=ri;pt=new WeakMap,me=new WeakMap,fe=new WeakMap,_e=new WeakMap;function sr(e,t,n,i,r){let s=String(e).padStart(4,"0"),a=t===void 0?r:String(t).padStart(2,"0"),o=n===void 0?r:String(n).padStart(2,"0");return s+i+a+i+o}function ar(e,t,n){return n!=null?ii(e)&&or(t)&&Number.isInteger(n)&&n>=1&&n<=no(e,t)?"ymd":!1:t!=null?ii(e)&&or(t)?"ym":!1:ii(e)?"y":!1}function ii(e){return Number.isInteger(e)&&e>=0}function or(e){return Number.isInteger(e)&&e>=1&&e<=12}function no(e,t){return new Date(e,t,0).getDate()}});var si=D(vt=>{"use strict";Object.defineProperty(vt,"__esModule",{value:!0});vt.isMoveDescriptor=vt.MoveDescriptor=void 0;var _n=class{constructor(){}toString(){let t=this.from()+this.to();return this.isPromotion()?t+=this.promotion().toUpperCase():this.isCastling()&&(t+="O"),t}};vt.MoveDescriptor=_n;function io(e){return e instanceof _n}vt.isMoveDescriptor=io});var Bt=D(he=>{"use strict";Object.defineProperty(he,"__esModule",{value:!0});he.getAttacks=he.isAttacked=he.ATTACK_DIRECTIONS=void 0;he.ATTACK_DIRECTIONS=[[-17,-16,-15,-1,1,15,16,17],[-17,-16,-15,-1,1,15,16,17],[-17,-16,-15,-1,1,15,16,17],[-17,-16,-15,-1,1,15,16,17],[-16,-1,1,16],[-16,-1,1,16],[-17,-15,15,17],[-17,-15,15,17],[-33,-31,-18,-14,14,18,31,33],[-33,-31,-18,-14,14,18,31,33],[15,17],[-17,-15]];function ro(e,t,n){return ai(e,t,0*2+n)||ai(e,t,4*2+n)||ai(e,t,5*2+n)||lr(e,t,2*2+n,1*2+n)||lr(e,t,3*2+n,1*2+n)}he.isAttacked=ro;function ai(e,t,n){let i=he.ATTACK_DIRECTIONS[n];for(let r=0;r<i.length;++r){let s=t-i[r];if((s&136)===0&&e.board[s]===n)return!0}return!1}function lr(e,t,n,i){let r=he.ATTACK_DIRECTIONS[n];for(let s=0;s<r.length;++s){let a=t;for(;;){if(a-=r[s],(a&136)===0){let o=e.board[a];if(o===-1)continue;if(o===n||o===i)return!0}break}}return!1}function so(e,t,n){let i=[];return oi(e,t,i,0*2+n),oi(e,t,i,4*2+n),oi(e,t,i,5*2+n),ur(e,t,i,2*2+n,1*2+n),ur(e,t,i,3*2+n,1*2+n),i}he.getAttacks=so;function oi(e,t,n,i){let r=he.ATTACK_DIRECTIONS[i];for(let s=0;s<r.length;++s){let a=t-r[s];(a&136)===0&&e.board[a]===i&&n.push(a)}}function ur(e,t,n,i,r){let s=he.ATTACK_DIRECTIONS[i];for(let a=0;a<s.length;++a){let o=t;for(;;){if(o-=s[a],(o&136)===0){let l=e.board[o];if(l===-1)continue;(l===i||l===r)&&n.push(o)}break}}}});var It=D(re=>{"use strict";Object.defineProperty(re,"__esModule",{value:!0});re.isEqual=re.refreshEffectiveEnPassant=re.refreshEffectiveCastling=re.isKingSafeAfterMove=re.refreshLegalFlagAndKingSquares=re.isLegal=void 0;var gr=Bt();function ao(e){return pn(e),e.legal}re.isLegal=ao;function pn(e){if(e.legal!==null)return;e.legal=!1;let t=cr(e,0),n=cr(e,1);if(!t||!n)return;if(e.variant===5){if(!fr(e,1-e.turn))return}else if(e.variant===6&&e.turn===1&&!fr(e,0))return;if(e.king[1-e.turn]>=0&&(0,gr.isAttacked)(e,e.king[1-e.turn],e.turn))return;let i=e.variant===6?-2:10;for(let r=0;r<8;++r){let s=e.board[0+r],a=e.board[112+r];if(s===i||a===10||s===11||a===11)return}e.legal=!0}re.refreshLegalFlagAndKingSquares=pn;function cr(e,t){let n=0+t;if(e.king[t]=-1,e.variant===5)return!0;if(e.variant===2||e.variant===4-t||e.variant===6&&t===0){for(let i=0;i<120;i+=(i&7)===7?9:1)if(e.board[i]===n)return!1;return!0}else{for(let i=0;i<120;i+=(i&7)===7?9:1)if(e.board[i]===n)if(e.king[t]<0)e.king[t]=i;else return e.king[t]=-1,!1;return e.king[t]>=0}}function fr(e,t){for(let n=0;n<120;n+=(n&7)===7?9:1)if(e.board[n]!==-1&&e.board[n]%2===t)return!0;return!1}function li(e,t,n,i=-1){if(e.king[e.turn]<0)return!0;let r=e.board[t],s=e.board[n],a=Math.trunc(r/2);e.board[n]=r,e.board[t]=-1,i>=0&&(e.board[i]=-1);try{return!(0,gr.isAttacked)(e,a===0?n:e.king[e.turn],1-e.turn)}finally{e.board[t]=r,e.board[n]=s,i>=0&&(e.board[i]=5*2+1-e.turn)}}re.isKingSafeAfterMove=li;function ui(e){e.effectiveCastling===null&&(pn(e),e.effectiveCastling=e.variant===1?[dr(e,0),dr(e,1)]:[hr(e,0),hr(e,1)])}re.refreshEffectiveCastling=ui;function hr(e,t){let n=112*t;if(e.king[t]!==n+4||e.castling[t]===0)return 0;let i=2*2+t,r=0;return(e.castling[t]&1)!==0&&e.board[n]===i&&(r|=1),(e.castling[t]&128)!==0&&e.board[n+7]===i&&(r|=128),r}function dr(e,t){let n=112*t;if(e.king[t]<=n||e.king[t]>=n+7||e.castling[t]===0)return 0;let i=2*2+t,r=0,s=-1;for(let o=e.king[t]%16-1;o>=0;--o)if(!((e.castling[t]&1<<o)===0||e.board[n+o]!==i))if(s<0)s=o;else{s=-1;break}s>=0&&(r|=1<<s);let a=-1;for(let o=e.king[t]%16+1;o<8;++o)if(!((e.castling[t]&1<<o)===0||e.board[n+o]!==i))if(a<0)a=o;else{a=-1;break}return a>=0&&(r|=1<<a),r}function ci(e){if(e.effectiveEnPassant!==null||(e.effectiveEnPassant=-1,e.enPassant<0))return;let t=(6-e.turn*5)*16+e.enPassant,n=(5-e.turn*3)*16+e.enPassant,i=(4-e.turn)*16+e.enPassant,r=5*2+e.turn,s=5*2+1-e.turn;if(e.board[t]!==-1||e.board[n]!==-1||e.board[i]!==s)return;let a=(i-1&136)===0&&e.board[i-1]===r,o=(i+1&136)===0&&e.board[i+1]===r;!a&&!o||(pn(e),!(!(a&&li(e,i-1,n,i))&&!(o&&li(e,i+1,n,i)))&&(e.effectiveEnPassant=e.enPassant))}re.refreshEffectiveEnPassant=ci;function oo(e,t){if(e.turn!==t.turn||e.variant!==t.variant)return!1;for(let n=0;n<120;n+=(n&7)===7?9:1)if(e.board[n]!==t.board[n])return!1;return ui(e),ui(t),e.effectiveCastling[0]!==t.effectiveCastling[0]||e.effectiveCastling[1]!==t.effectiveCastling[1]?!1:(ci(e),ci(t),e.effectiveEnPassant===t.effectiveEnPassant)}re.isEqual=oo});var vn=D(je=>{"use strict";Object.defineProperty(je,"__esModule",{value:!0});je.parseFEN=je.getFEN=je.ascii=void 0;var ke=xe(),lo=Gt(),fi=It(),pe=Z(),ve=Le(),hi=[..."KkQqRrBbNnPp"],_r=["6","3"];function uo(e){let t=`+---+---+---+---+---+---+---+---+
`;for(let n=7;n>=0;--n){for(let i=0;i<8;++i){let r=e.board[n*16+i];t+="| "+(r===-1?" ":hi[r])+" "}t+=`|
`,t+=`+---+---+---+---+---+---+---+---+
`}return t+=(0,ke.colorToString)(e.turn)+" "+pr(e)+" "+vr(e),e.variant!==0&&(t+=" ("+(0,ke.variantToString)(e.variant)+")"),t}je.ascii=uo;function co(e,t=0,n=1,i=!1){let r="";for(let s=7;s>=0;--s){let a=0;for(let o=0;o<8;++o){let l=e.board[s*16+o];l===-1?++a:(a>0&&(r+=a,a=0),r+=hi[l])}a>0&&(r+=a),s>0&&(r+="/")}return r+=" "+(0,ke.colorToString)(e.turn)+" "+pr(e,i)+" "+vr(e),r+=" "+t+" "+n,r}je.getFEN=co;function pr(e,t=!1){if((0,fi.refreshEffectiveCastling)(e),e.variant===1){if(t){let r=mr(e,0),s=mr(e,1);if(r!==!1&&s!==!1)return r===""&&s===""?"-":r.toUpperCase()+s}let n="",i="";for(let r=0;r<8;++r)e.effectiveCastling[0]&1<<r&&(n+=(0,ke.fileToString)(r)),e.effectiveCastling[1]&1<<r&&(i+=(0,ke.fileToString)(r));return n===""&&i===""?"-":n.toUpperCase()+i}else{let n="";return e.effectiveCastling[0]&128&&(n+="K"),e.effectiveCastling[0]&1&&(n+="Q"),e.effectiveCastling[1]&128&&(n+="k"),e.effectiveCastling[1]&1&&(n+="q"),n===""?"-":n}}function mr(e,t){let n=1<<e.king[t]%16,i=e.effectiveCastling[t]&~(n|n-1),r=e.effectiveCastling[t]&n-1,s="",a=112*t,o=112*t+7,l=2*2+t;if(i!==0){let u=!1;for(let f=e.king[t]+1;f<=o;++f)if(e.board[f]===l){if(u)return!1;u=!0}s+="k"}if(r!==0){let u=!1;for(let f=e.king[t]-1;f>=a;--f)if(e.board[f]===l){if(u)return!1;u=!0}s+="q"}return s}function vr(e){return(0,fi.refreshEffectiveEnPassant)(e),e.effectiveEnPassant<0?"-":(0,ke.fileToString)(e.effectiveEnPassant)+_r[e.turn]}function fo(e,t,n){let i=n?t.split(" "):t.replace(/^\s+|\s+$/g,"").split(/\s+/);if(i.length!==6)throw new pe.InvalidFEN(t,ve.i18n.WRONG_NUMBER_OF_FEN_FIELDS);let r=i[0].split("/");if(r.length!==8)throw new pe.InvalidFEN(t,ve.i18n.WRONG_NUMBER_OF_SUBFIELDS_IN_BOARD_FIELD);let s=(0,lo.makeEmpty)(e);s.legal=null,s.effectiveCastling=null,s.effectiveEnPassant=null;for(let u=7;u>=0;--u){let f=r[7-u],d=0,m=0;for(;d<f.length&&m<8;){let _=f[d],E=hi.indexOf(_);if(/^[1-8]$/.test(_))m+=parseInt(_,10);else if(E>=0)s.board[u*16+m]=E,++m;else throw new pe.InvalidFEN(t,ve.i18n.UNEXPECTED_CHARACTER_IN_BOARD_FIELD,_);++d}if(d!==f.length||m!==8)throw new pe.InvalidFEN(t,ve.i18n.UNEXPECTED_END_OF_SUBFIELD_IN_BOARD_FIELD,8-u)}if(s.turn=(0,ke.colorFromString)(i[1]),s.turn<0)throw new pe.InvalidFEN(t,ve.i18n.INVALID_TURN_FIELD);let a=e===1?go(i[2],n,s.board):ho(i[2],n);if(a===null)throw new pe.InvalidFEN(t,ve.i18n.INVALID_CASTLING_FIELD);s.castling=a;let o=i[3];if(o!=="-"){if(!/^[a-h][36]$/.test(o))throw new pe.InvalidFEN(t,ve.i18n.INVALID_EN_PASSANT_FIELD);if(s.enPassant=(0,ke.fileFromString)(o[0]),n){if(o[1]!==_r[s.turn])throw new pe.InvalidFEN(t,ve.i18n.WRONG_RANK_IN_EN_PASSANT_FIELD);if((0,fi.refreshEffectiveEnPassant)(s),s.enPassant!==s.effectiveEnPassant)throw new pe.InvalidFEN(t,ve.i18n.INEFFECTIVE_EN_PASSANT_FIELD,(0,ke.fileToString)(s.enPassant))}}let l=n?/^(?:0|[1-9][0-9]*)$/:/^[0-9]+$/;if(!l.test(i[4]))throw new pe.InvalidFEN(t,ve.i18n.INVALID_HALF_MOVE_COUNT_FIELD);if(!l.test(i[5]))throw new pe.InvalidFEN(t,ve.i18n.INVALID_MOVE_NUMBER_FIELD);return{position:s,fiftyMoveClock:parseInt(i[4],10),fullMoveNumber:parseInt(i[5],10)}}je.parseFEN=fo;function ho(e,t){let n=[0,0];return e==="-"?n:(t?/^K?Q?k?q?$/:/^[KQkq]*$/).test(e)?(e.indexOf("K")>=0&&(n[0]|=1<<7),e.indexOf("Q")>=0&&(n[0]|=1<<0),e.indexOf("k")>=0&&(n[1]|=1<<7),e.indexOf("q")>=0&&(n[1]|=1<<0),n):null}function go(e,t,n){let i=[0,0];if(e==="-")return i;if(!(t?/^[A-H]{0,2}[a-h]{0,2}$/:/^[A-Ha-h]*|[KQkq]*$/).test(e))return null;function r(a){let o=4+a,l=0*2+a;for(let u=112*a;u<112*a+8;++u){if(n[u]===o)return u%8;if(n[u]===l)break}return 0}function s(a){let o=4+a,l=0*2+a;for(let u=112*a+7;u>=112*a;--u){if(n[u]===o)return u%8;if(n[u]===l)break}return 7}t||(e.indexOf("K")>=0&&(i[0]|=1<<s(0)),e.indexOf("Q")>=0&&(i[0]|=1<<r(0)),e.indexOf("k")>=0&&(i[1]|=1<<s(1)),e.indexOf("q")>=0&&(i[1]|=1<<r(1)));for(let a=0;a<8;++a){let o=(0,ke.fileToString)(a);e.indexOf(o.toUpperCase())>=0&&(i[0]|=1<<a),e.indexOf(o)>=0&&(i[1]|=1<<a)}return i}});var bn=D(Nn=>{"use strict";Object.defineProperty(Nn,"__esModule",{value:!0});Nn.MoveDescriptorImpl=void 0;var de=xe(),tt=Z(),mo=si(),Ir=1,Nr=2,In=4,br=8,Ke=class extends mo.MoveDescriptor{constructor(t,n,i,r,s,a,o,l){super(),this._flags=t,this._from=n,this._to=i,this._movingColoredPiece=r,this._finalColoredPiece=s,this._optionalColoredPiece=a,this._optionalSquare1=o,this._optionalSquare2=l}static make(t,n,i,r){let s=r===-1?0:In;return new Ke(s,t,n,i,i,r,-1,-1)}static makeCastling(t,n,i,r,s){let a=0+s,o=2*2+s;return new Ke(Ir,t,n,a,a,o,i,r)}static makeEnPassant(t,n,i,r){let s=Nr|In,a=5*2+r,o=5*2+1-r;return new Ke(s,t,n,a,a,o,i,-1)}static makePromotion(t,n,i,r,s){let a=br|(r===-1?0:In),o=5*2+i,l=s*2+i;return new Ke(a,t,n,o,l,r,-1,-1)}isCastling(){return(this._flags&Ir)!==0}isEnPassant(){return(this._flags&Nr)!==0}isCapture(){return(this._flags&In)!==0}isPromotion(){return(this._flags&br)!==0}from(){return(0,de.squareToString)(this._from)}to(){return(0,de.squareToString)(this._to)}color(){return(0,de.colorToString)(this._movingColoredPiece%2)}movingPiece(){return(0,de.pieceToString)(Math.trunc(this._movingColoredPiece/2))}movingColoredPiece(){return(0,de.coloredPieceToString)(this._movingColoredPiece)}capturedPiece(){if(!this.isCapture())throw new tt.IllegalArgument("MoveDescriptor.capturedPiece()");return(0,de.pieceToString)(Math.trunc(this._optionalColoredPiece/2))}capturedColoredPiece(){if(!this.isCapture())throw new tt.IllegalArgument("MoveDescriptor.capturedColoredPiece()");return(0,de.coloredPieceToString)(this._optionalColoredPiece)}rookFrom(){if(!this.isCastling())throw new tt.IllegalArgument("MoveDescriptor.rookFrom()");return(0,de.squareToString)(this._optionalSquare1)}rookTo(){if(!this.isCastling())throw new tt.IllegalArgument("MoveDescriptor.rookTo()");return(0,de.squareToString)(this._optionalSquare2)}enPassantSquare(){if(!this.isEnPassant())throw new tt.IllegalArgument("MoveDescriptor.enPassantSquare()");return(0,de.squareToString)(this._optionalSquare1)}promotion(){if(!this.isPromotion())throw new tt.IllegalArgument("MoveDescriptor.promotion()");return(0,de.pieceToString)(Math.trunc(this._finalColoredPiece/2))}coloredPromotion(){if(!this.isPromotion())throw new tt.IllegalArgument("MoveDescriptor.coloredPromotion()");return(0,de.coloredPieceToString)(this._finalColoredPiece)}};Nn.MoveDescriptorImpl=Ke});var En=D(V=>{"use strict";Object.defineProperty(V,"__esModule",{value:!0});V.playNullMove=V.isNullMoveLegal=V.play=V.isMoveLegal=V.isCastlingMoveLegal=V.isCaptureMandatory=V.moves=V.hasMove=V.isDead=V.isStalemate=V.isCheckmate=V.isCheck=void 0;var Nt=Bt(),Er=xe(),$=It(),Q=bn(),_o=[204,0,0,0,0,0,0,60,0,0,0,0,0,0,204,0,0,204,0,0,0,0,0,60,0,0,0,0,0,204,0,0,0,0,204,0,0,0,0,60,0,0,0,0,204,0,0,0,0,0,0,204,0,0,0,60,0,0,0,204,0,0,0,0,0,0,0,0,204,0,0,60,0,0,204,0,0,0,0,0,0,0,0,0,0,204,768,60,768,204,0,0,0,0,0,0,0,0,0,0,0,768,2255,2111,2255,768,0,0,0,0,0,0,60,60,60,60,60,60,63,0,63,60,60,60,60,60,60,0,0,0,0,0,0,768,1231,1087,1231,768,0,0,0,0,0,0,0,0,0,0,0,204,768,60,768,204,0,0,0,0,0,0,0,0,0,0,204,0,0,60,0,0,204,0,0,0,0,0,0,0,0,204,0,0,0,60,0,0,0,204,0,0,0,0,0,0,204,0,0,0,0,60,0,0,0,0,204,0,0,0,0,204,0,0,0,0,0,60,0,0,0,0,0,204,0,0,204,0,0,0,0,0,0,60,0,0,0,0,0,0,204,0],po=[-17,0,0,0,0,0,0,-16,0,0,0,0,0,0,-15,0,0,-17,0,0,0,0,0,-16,0,0,0,0,0,-15,0,0,0,0,-17,0,0,0,0,-16,0,0,0,0,-15,0,0,0,0,0,0,-17,0,0,0,-16,0,0,0,-15,0,0,0,0,0,0,0,0,-17,0,0,-16,0,0,-15,0,0,0,0,0,0,0,0,0,0,-17,0,-16,0,-15,0,0,0,0,0,0,0,0,0,0,0,0,-17,-16,-15,0,0,0,0,0,0,0,-1,-1,-1,-1,-1,-1,-1,0,1,1,1,1,1,1,1,0,0,0,0,0,0,0,15,16,17,0,0,0,0,0,0,0,0,0,0,0,0,15,0,16,0,17,0,0,0,0,0,0,0,0,0,0,15,0,0,16,0,0,17,0,0,0,0,0,0,0,0,15,0,0,0,16,0,0,0,17,0,0,0,0,0,0,15,0,0,0,0,16,0,0,0,0,17,0,0,0,0,15,0,0,0,0,0,16,0,0,0,0,0,17,0,0,15,0,0,0,0,0,0,16,0,0,0,0,0,0,17,0];function Sr(e,t){for(let n=0;n<120;n+=(n&7)===7?9:1)if(e.board[n]!==-1&&e.board[n]%2===t)return!0;return!1}function wn(e){return e.king[e.turn]>=0&&(0,Nt.isAttacked)(e,e.king[e.turn],1-e.turn)}function vo(e){return(0,$.isLegal)(e)&&wn(e)}V.isCheck=vo;function Io(e){return!(0,$.isLegal)(e)||di(e)?!1:e.variant===5?!0:e.variant===6&&e.turn===0?!Sr(e,0):wn(e)}V.isCheckmate=Io;function No(e){return!(0,$.isLegal)(e)||di(e)?!1:e.variant===5?!0:e.variant===6&&e.turn===0?Sr(e,0):!wn(e)}V.isStalemate=No;function bo(e,t){return(0,$.isLegal)(e)&&(e.variant===0||e.variant===1)?t?Eo(e):wo(e):!1}V.isDead=bo;function wo(e){let t=!1,n=-1;for(let i=0;i<120;i+=(i&7)===7?9:1){let r=e.board[i];if(r===-1)continue;let s=Math.trunc(r/2);if(s===3){let a=(0,Er.squareColorImpl)(i);if(n===a)continue;n=a}if(s===3||s===4){if(t)return!1;t=!0}else if(s!==0)return!1}return!0}function Eo(e){let t=[0,0],n=[-1,-1];for(let i=0;i<120;i+=(i&7)===7?9:1){let r=e.board[i];if(r===-1)continue;let s=r%2,a=Math.trunc(r/2);if(a===3){let o=(0,Er.squareColorImpl)(i);if(n[s]===o)continue;n[s]=o}if(a===3||a===4){if(t[s]+=a===3?2:1,t[s]>=3)return!1}else if(a!==0)return!1}return!0}function di(e){class t{}try{return yr(e,()=>{throw new t}),!1}catch(n){if(n instanceof t)return!0;throw n}}V.hasMove=di;function So(e){let t=[];return yr(e,n=>{t.push(n)}),t}V.moves=So;function yr(e,t){if(!(0,$.isLegal)(e))return;let n=!gi(e);if((0,$.refreshEffectiveCastling)(e),n&&e.effectiveCastling[e.turn]!==0){let i=112*e.turn;for(let r=0;r<8;++r)if((e.effectiveCastling[e.turn]&1<<r)!==0){let s=i+r,a=i+(s<e.king[e.turn]?3:5),o=i+(s<e.king[e.turn]?2:6);Pr(e,e.king[e.turn],o,s,a)&&t(Q.MoveDescriptorImpl.makeCastling(e.king[e.turn],o,s,a,e.turn))}}if((0,$.refreshEffectiveEnPassant)(e),e.effectiveEnPassant>=0){let i=(5-e.turn*3)*16+e.effectiveEnPassant,r=(4-e.turn)*16+e.effectiveEnPassant,s=5*2+e.turn;(r-1&136)===0&&e.board[r-1]===s&&(0,$.isKingSafeAfterMove)(e,r-1,i,r)&&t(Q.MoveDescriptorImpl.makeEnPassant(r-1,i,r,e.turn)),(r+1&136)===0&&e.board[r+1]===s&&(0,$.isKingSafeAfterMove)(e,r+1,i,r)&&t(Q.MoveDescriptorImpl.makeEnPassant(r+1,i,r,e.turn))}for(let i=0;i<120;i+=(i&7)===7?9:1){let r=e.board[i],s=Math.trunc(r/2);if(!(r===-1||r%2!==e.turn))if(s===5){let a=Nt.ATTACK_DIRECTIONS[r];for(let o=0;o<a.length;++o){let l=i+a[o];(l&136)===0&&e.board[l]!==-1&&e.board[l]%2!==e.turn&&(0,$.isKingSafeAfterMove)(e,i,l)&&wr(e,i,l,t)}if(n){let o=16-e.turn*32,l=i+o;if(e.board[l]===-1){(0,$.isKingSafeAfterMove)(e,i,l)&&wr(e,i,l,t);let u=e.turn*96;i>=u&&i<u+24&&(l+=o,e.board[l]===-1&&(0,$.isKingSafeAfterMove)(e,i,l)&&t(Q.MoveDescriptorImpl.make(i,l,r,-1)))}}}else if(s===4||s===0){let a=Nt.ATTACK_DIRECTIONS[r];for(let o=0;o<a.length;++o){let l=i+a[o];if((l&136)===0){let u=e.board[l];(u===-1?n:u%2!==e.turn)&&(0,$.isKingSafeAfterMove)(e,i,l)&&t(Q.MoveDescriptorImpl.make(i,l,r,u))}}}else{let a=Nt.ATTACK_DIRECTIONS[r];for(let o=0;o<a.length;++o)for(let l=i+a[o];(l&136)===0;l+=a[o]){let u=e.board[l];if((u===-1?n:u%2!==e.turn)&&(0,$.isKingSafeAfterMove)(e,i,l)&&t(Q.MoveDescriptorImpl.make(i,l,r,u)),u!==-1)break}}}}function wr(e,t,n,i){let r=e.board[n];n<8||n>=112?(i(Q.MoveDescriptorImpl.makePromotion(t,n,e.turn,r,1)),i(Q.MoveDescriptorImpl.makePromotion(t,n,e.turn,r,2)),i(Q.MoveDescriptorImpl.makePromotion(t,n,e.turn,r,3)),i(Q.MoveDescriptorImpl.makePromotion(t,n,e.turn,r,4)),e.variant===5&&i(Q.MoveDescriptorImpl.makePromotion(t,n,e.turn,r,0))):i(Q.MoveDescriptorImpl.make(t,n,5*2+e.turn,r))}function gi(e){if(e.variant!==5)return!1;for(let t=0;t<120;t+=(t&7)===7?9:1){let n=e.board[t];if(n!==-1&&n%2!==e.turn&&(0,Nt.isAttacked)(e,t,e.turn))return!0}return(0,$.refreshEffectiveEnPassant)(e),e.effectiveEnPassant>=0}V.isCaptureMandatory=gi;function Cr(e,t,n){let i=-1,r=-1;if(e.variant===1){let s=n%16;if(Math.trunc(n/16)!==e.turn*7||(e.effectiveCastling[e.turn]&1<<s)===0)return!1;i=n,r=(t>n?3:5)+112*e.turn,n=(t>n?2:6)+112*e.turn}else if(n===2+e.turn*112){if((e.effectiveCastling[e.turn]&1)===0)return!1;i=112*e.turn,r=3+112*e.turn}else if(n===6+e.turn*112){if((e.effectiveCastling[e.turn]&1<<7)===0)return!1;i=7+112*e.turn,r=5+112*e.turn}else return!1;return Pr(e,t,n,i,r)?Q.MoveDescriptorImpl.makeCastling(t,n,i,r,e.turn):!1}V.isCastlingMoveLegal=Cr;function Pr(e,t,n,i,r){e.board[t]=-1,e.board[i]=-1;try{for(let a=Math.min(t,n,i,r);a<=Math.max(t,n,i,r);++a)if(e.board[a]!==-1)return!1;let s=1-e.turn;for(let a=Math.min(t,n);a<=Math.max(t,n);++a)if((0,Nt.isAttacked)(e,a,s))return!1;return!0}finally{e.board[t]=0*2+e.turn,e.board[i]=2*2+e.turn}}function yo(e,t,n){if(!(0,$.isLegal)(e))return!1;let i=e.board[t],r=e.board[n],s=Math.trunc(i/2);if(i===-1||i%2!==e.turn)return!1;let a=n-t+119,o=-1,l=!1,u=s===5&&(n<8||n>=112),f=gi(e);if(s===0&&!f&&((0,$.refreshEffectiveCastling)(e),e.effectiveCastling[e.turn]!==0)){let d=Cr(e,t,n);if(d)return{type:"regular",moveDescriptor:d}}if((_o[a]&1<<i)===0)if(s===5&&a===151-e.turn*64){let d=e.turn*96;if(t<d||t>=d+24)return!1;l=!0}else return!1;if(s===5){if((0,$.refreshEffectiveEnPassant)(e),a===135-e.turn*32||l){if(f||r!==-1)return!1}else if(r===-1){if(n!==(5-e.turn*3)*16+e.effectiveEnPassant)return!1;o=(4-e.turn)*16+e.effectiveEnPassant}else if(r%2===e.turn)return!1}else if(r===-1?f:r%2===e.turn)return!1;if(s===3||s===2||s===1){let d=po[a];for(let m=t+d;m!==n;m+=d)if(e.board[m]!==-1)return!1}else if(l&&e.board[(t+n)/2]!==-1)return!1;return(0,$.isKingSafeAfterMove)(e,t,n,o)?u?{type:"promotion",moveDescriptorFactory:Co(t,n,e.variant,e.turn,r)}:{type:"regular",moveDescriptor:o>=0?Q.MoveDescriptorImpl.makeEnPassant(t,n,o,e.turn):Q.MoveDescriptorImpl.make(t,n,i,r)}:!1}V.isMoveLegal=yo;function Co(e,t,n,i,r){return s=>s===5||s===0&&n!==5?!1:Q.MoveDescriptorImpl.makePromotion(e,t,i,r,s)}function Po(e,t){(0,$.refreshEffectiveCastling)(e),e.board[t._from]=-1,t.isEnPassant()?e.board[t._optionalSquare1]=-1:t.isCastling()&&(e.board[t._optionalSquare1]=-1,e.board[t._optionalSquare2]=t._optionalColoredPiece),e.board[t._to]=t._finalColoredPiece;let n=Math.trunc(t._movingColoredPiece/2);if(n===0&&(e.effectiveCastling[e.turn]=0),t._from<8&&(e.effectiveCastling[0]&=~(1<<t._from)),t._to<8&&(e.effectiveCastling[0]&=~(1<<t._to)),t._from>=112&&(e.effectiveCastling[1]&=~(1<<t._from%16)),t._to>=112&&(e.effectiveCastling[1]&=~(1<<t._to%16)),e.castling[0]=e.effectiveCastling[0],e.castling[1]=e.effectiveCastling[1],e.enPassant=-1,e.effectiveEnPassant=-1,n===5&&Math.abs(t._from-t._to)===32){let i=(1+5*e.turn)*16;if(t._from>=i&&t._from<i+8){let r=t._movingColoredPiece^1;((t._to-1&136)===0&&e.board[t._to-1]===r||(t._to+1&136)===0&&e.board[t._to+1]===r)&&(e.enPassant=t._to%16,e.effectiveEnPassant=null)}}n===0&&e.king[e.turn]>=0&&(e.king[e.turn]=t._to),e.turn=1-e.turn}V.play=Po;function Ar(e){return(0,$.isLegal)(e)&&!wn(e)}V.isNullMoveLegal=Ar;function Ao(e){return Ar(e)?(e.turn=1-e.turn,e.enPassant=-1,e.effectiveEnPassant=-1,!0):!1}V.playNullMove=Ao});var Lr=D(wt=>{"use strict";Object.defineProperty(wt,"__esModule",{value:!0});wt.parseNotation=wt.getNotation=void 0;var Tr=Bt(),ee=xe(),C=vn(),ko=Gt(),Ut=It(),yn=bn(),bt=En(),P=Z(),S=Le();function To(e,t,n){let i="";return t.isCastling()?i=t._to%16===6?"O-O":"O-O-O":Math.trunc(t._movingColoredPiece/2)===5?(t.isCapture()&&(i+=(0,ee.fileToString)(t._from%16)+"x"),i+=(0,ee.squareToString)(t._to),t.isPromotion()&&(i+="="+kr(t._finalColoredPiece,n))):(i+=kr(t._movingColoredPiece,n),i+=Or(e,t._from,t._to),t.isCapture()&&(i+="x"),i+=(0,ee.squareToString)(t._to)),i+=Mr(e,t),i}wt.getNotation=To;function kr(e,t){switch(t){case"figurine":return(0,ee.figurineToString)(e);case"standard":return(0,ee.pieceToString)(Math.trunc(e/2)).toUpperCase()}}function Mr(e,t){let n=(0,ko.makeCopy)(e);return(0,bt.play)(n,t),(0,bt.isCheckmate)(n)?"#":(0,bt.isCheck)(n)?"+":""}function Or(e,t,n){let i=(0,Tr.getAttacks)(e,n,e.turn).filter(u=>e.board[u]===e.board[t]);if(i.length<2)return"";let r=!1,s=!1,a=!1,o=Math.trunc(t/16),l=t%16;for(let u=0;u<i.length;++u){let f=i[u];f===t||Mo(e,f,n)||(r=!0,o===Math.trunc(f/16)&&(s=!0),l===f%16&&(a=!0))}return a?s?(0,ee.squareToString)(t):(0,ee.rankToString)(o):r?(0,ee.fileToString)(l):""}function Mo(e,t,n){let i=e.king[e.turn];if(i<0)return!1;let r=Math.abs(i-t),s=Math.abs(n-t),a=1*2+1-e.turn,o=2*2+1-e.turn,l=3*2+1-e.turn;return r<8?s>=8&&Sn(e,i,t,i<t?1:-1,o,a):r%16===0?s%16!==0&&Sn(e,i,t,i<t?16:-16,o,a):r%15===0?s%15!==0&&Sn(e,i,t,i<t?15:-15,l,a):r%17===0?s%17!==0&&Sn(e,i,t,i<t?17:-17,l,a):!1}function Sn(e,t,n,i,r,s){for(let a=t+i;a!==n;a+=i)if(e.board[a]!==-1)return!1;for(let a=n+i;(a&136)===0;a+=i)if(e.board[a]!==-1)return e.board[a]===r||e.board[a]===s;return!1}function Oo(e,t,n,i){let r=/^(?:(O-O-O|0-0-0)|(O-O|0-0)|([A-Z\u2654-\u265f])([a-h])?([1-8])?(x)?([a-h][1-8])|(?:([a-h])(x)?)?([a-h][1-8])(?:(=)?([A-Z\u2654-\u265f]))?)([+#])?$/.exec(t);if(r===null)throw new P.InvalidNotation((0,C.getFEN)(e),t,S.i18n.INVALID_MOVE_NOTATION_SYNTAX);if(!(0,Ut.isLegal)(e))throw new P.InvalidNotation((0,C.getFEN)(e),t,S.i18n.ILLEGAL_POSITION);let s=!1;if(r[1]!==void 0||r[2]!==void 0?s=Fo(e,t,n,r[1],r[2]):r[3]!==void 0?s=xo(e,t,n,i,r[3],r[4],r[5],r[7]):s=Do(e,t,n,i,r[8],r[10],r[11],r[12]),n){let a=r[6]!==void 0||r[9]!==void 0;if(s.isCapture()!==a){let u=s.isCapture()?S.i18n.MISSING_CAPTURE_SYMBOL:S.i18n.INVALID_CAPTURE_SYMBOL;throw new P.InvalidNotation((0,C.getFEN)(e),t,u)}let o=Mr(e,s),l=r[13]===void 0?"":r[13];if(o!==l)throw new P.InvalidNotation((0,C.getFEN)(e),t,S.i18n.WRONG_CHECK_CHECKMATE_SYMBOL,o,l)}return s}wt.parseNotation=Oo;function Fo(e,t,n,i,r){let s=e.king[e.turn];if(s<0)throw new P.InvalidNotation((0,C.getFEN)(e),t,S.i18n.ILLEGAL_NO_KING_CASTLING);(0,Ut.refreshEffectiveCastling)(e);let a=r!==void 0,o=Lo(e,a),l=o>=0?(0,bt.isCastlingMoveLegal)(e,s,o+112*e.turn):!1;if(!l){let u=a?S.i18n.ILLEGAL_KING_SIDE_CASTLING:S.i18n.ILLEGAL_QUEEN_SIDE_CASTLING;throw new P.InvalidNotation((0,C.getFEN)(e),t,u)}if(n&&(a?r:i).charAt(0)==="0")throw new P.InvalidNotation((0,C.getFEN)(e),t,S.i18n.CASTLING_MOVE_ENCODED_WITH_ZERO);return l}function Lo(e,t){if(e.variant===1){if(e.effectiveCastling[e.turn]!==0){let n=0+e.turn;for(let i=t?7:0;e.board[i+112*e.turn]!==n;i+=t?-1:1)if((e.effectiveCastling[e.turn]&1<<i)!==0)return i}return-1}else return t?6:2}function xo(e,t,n,i,r,s,a,o){let l=Fr(e,t,r,n,i)*2+e.turn,u=(0,ee.squareFromString)(o),f=e.board[u];if(f!==-1&&f%2===e.turn)throw new P.InvalidNotation((0,C.getFEN)(e),t,S.i18n.TRYING_TO_CAPTURE_YOUR_OWN_PIECES);if(f===-1&&(0,bt.isCaptureMandatory)(e))throw new P.InvalidNotation((0,C.getFEN)(e),t,S.i18n.CAPTURE_IS_MANDATORY);let d=(0,Tr.getAttacks)(e,u,e.turn).filter(_=>e.board[_]===l);if(s!==void 0){let _=(0,ee.fileFromString)(s);d=d.filter(E=>E%16===_)}if(a!==void 0){let _=(0,ee.rankFromString)(a);d=d.filter(E=>Math.trunc(E/16)===_)}if(d.length===0){let _=s===void 0&&a===void 0?S.i18n.NO_PIECE_CAN_MOVE_TO:S.i18n.NO_PIECE_CAN_MOVE_TO_DISAMBIGUATION;throw new P.InvalidNotation((0,C.getFEN)(e),t,_,r,o)}let m=!1;for(let _=0;_<d.length;++_)if((0,Ut.isKingSafeAfterMove)(e,d[_],u)){if(m)throw new P.InvalidNotation((0,C.getFEN)(e),t,S.i18n.REQUIRE_DISAMBIGUATION,r,o);m=yn.MoveDescriptorImpl.make(d[_],u,l,f)}if(!m){let _=e.turn===0?S.i18n.NOT_SAFE_FOR_WHITE_KING:S.i18n.NOT_SAFE_FOR_BLACK_KING;throw new P.InvalidNotation((0,C.getFEN)(e),t,_)}if(n){let _=Or(e,m._from,u),E=(s===void 0?"":s)+(a===void 0?"":a);if(_!==E)throw new P.InvalidNotation((0,C.getFEN)(e),t,S.i18n.WRONG_DISAMBIGUATION_SYMBOL,_,E)}return m}function Do(e,t,n,i,r,s,a,o){let l=10+e.turn,u=(0,ee.squareFromString)(s),f=e.board[u],d=16-e.turn*32,m=u-d,_=-1;if(r!==void 0){if((m&136)!==0)throw new P.InvalidNotation((0,C.getFEN)(e),t,S.i18n.INVALID_CAPTURING_PAWN_MOVE);let E=(0,ee.fileFromString)(r),q=u%16;if(q-E===1)m-=1;else if(q-E===-1)m+=1;else throw new P.InvalidNotation((0,C.getFEN)(e),t,S.i18n.INVALID_CAPTURING_PAWN_MOVE);if(e.board[m]!==l)throw new P.InvalidNotation((0,C.getFEN)(e),t,S.i18n.INVALID_CAPTURING_PAWN_MOVE);if(f===-1){if((0,Ut.refreshEffectiveEnPassant)(e),u!==(5-e.turn*3)*16+e.effectiveEnPassant)throw new P.InvalidNotation((0,C.getFEN)(e),t,S.i18n.INVALID_CAPTURING_PAWN_MOVE);_=(4-e.turn)*16+e.effectiveEnPassant}else if(f%2===e.turn)throw new P.InvalidNotation((0,C.getFEN)(e),t,S.i18n.INVALID_CAPTURING_PAWN_MOVE)}else{if((0,bt.isCaptureMandatory)(e))throw new P.InvalidNotation((0,C.getFEN)(e),t,S.i18n.CAPTURE_IS_MANDATORY);if((m&136)!==0)throw new P.InvalidNotation((0,C.getFEN)(e),t,S.i18n.INVALID_NON_CAPTURING_PAWN_MOVE);if(f!==-1)throw new P.InvalidNotation((0,C.getFEN)(e),t,S.i18n.INVALID_NON_CAPTURING_PAWN_MOVE);if(e.board[m]===-1){m-=d;let E=e.turn*96;if(m<E||m>=E+24||e.board[m]!==l)throw new P.InvalidNotation((0,C.getFEN)(e),t,S.i18n.INVALID_NON_CAPTURING_PAWN_MOVE)}else if(e.board[m]!==l)throw new P.InvalidNotation((0,C.getFEN)(e),t,S.i18n.INVALID_NON_CAPTURING_PAWN_MOVE)}if(!(0,Ut.isKingSafeAfterMove)(e,m,u,_)){let E=e.turn===0?S.i18n.NOT_SAFE_FOR_WHITE_KING:S.i18n.NOT_SAFE_FOR_BLACK_KING;throw new P.InvalidNotation((0,C.getFEN)(e),t,E)}if(u<8||u>=112){if(o===void 0)throw new P.InvalidNotation((0,C.getFEN)(e),t,S.i18n.MISSING_PROMOTION);let E=Fr(e,t,o,n,i);if(E===5||E===0&&e.variant!==5)throw new P.InvalidNotation((0,C.getFEN)(e),t,S.i18n.INVALID_PROMOTED_PIECE,o);if(n&&a===void 0)throw new P.InvalidNotation((0,C.getFEN)(e),t,S.i18n.MISSING_PROMOTION_SYMBOL);return yn.MoveDescriptorImpl.makePromotion(m,u,e.turn,f,E)}else{if(o!==void 0)throw new P.InvalidNotation((0,C.getFEN)(e),t,S.i18n.ILLEGAL_PROMOTION);return _>=0?yn.MoveDescriptorImpl.makeEnPassant(m,u,_,e.turn):yn.MoveDescriptorImpl.make(m,u,l,f)}}function Fr(e,t,n,i,r){switch(r){case"figurine":{let s=(0,ee.figurineFromString)(n);if(s<0)throw new P.InvalidNotation((0,C.getFEN)(e),t,S.i18n.INVALID_PIECE_SYMBOL,n);if(i&&s%2!==e.turn)throw new P.InvalidNotation((0,C.getFEN)(e),t,S.i18n.INVALID_PIECE_SYMBOL_COLOR,n);return Math.trunc(s/2)}case"standard":{let s=(0,ee.pieceFromString)(n.toLowerCase());if(s<0)throw new P.InvalidNotation((0,C.getFEN)(e),t,S.i18n.INVALID_PIECE_SYMBOL,n);return s}}}});var xr=D(Et=>{"use strict";Object.defineProperty(Et,"__esModule",{value:!0});Et.parseUCINotation=Et.getUCINotation=void 0;var mi=xe(),nt=vn(),Vo=It(),Ro=En(),it=Z(),rt=Le();function qo(e,t,n){let i=t.from();return t.isCastling()?i+=n||e.variant===1?t.rookFrom():t.to():i+=t.to(),t.isPromotion()&&(i+=t.promotion()),i}Et.getUCINotation=qo;function Go(e,t,n){let i=/^([a-h][1-8])([a-h][1-8])([kqrbnp]?)$/.exec(t);if(i===null)throw new it.InvalidNotation((0,nt.getFEN)(e),t,rt.i18n.INVALID_UCI_NOTATION_SYNTAX);if(!(0,Vo.isLegal)(e))throw new it.InvalidNotation((0,nt.getFEN)(e),t,rt.i18n.ILLEGAL_POSITION);let r=(0,mi.squareFromString)(i[1]),s=(0,mi.squareFromString)(i[2]),a=!1,o=-1;if(e.variant!==1&&!n&&e.board[r]!==-1&&e.board[s]!==-1&&e.board[r]%2===e.board[s]%2){let f=Math.trunc(e.board[r]/2),d=Math.trunc(e.board[s]/2);f===0&&d===2&&(a=!0,o=s,s=e.turn*112+(r<s?6:2))}let l=(0,Ro.isMoveLegal)(e,r,s),u=!1;if(!l)throw new it.InvalidNotation((0,nt.getFEN)(e),t,rt.i18n.ILLEGAL_UCI_MOVE);if(l.type==="promotion"){if(i[3]==="")throw new it.InvalidNotation((0,nt.getFEN)(e),t,rt.i18n.ILLEGAL_UCI_MOVE);if(u=l.moveDescriptorFactory((0,mi.pieceFromString)(i[3])),!u)throw new it.InvalidNotation((0,nt.getFEN)(e),t,rt.i18n.ILLEGAL_UCI_MOVE)}else{if(i[3]!=="")throw new it.InvalidNotation((0,nt.getFEN)(e),t,rt.i18n.ILLEGAL_UCI_MOVE);u=l.moveDescriptor}if(a&&(!u.isCastling()||o!==u._optionalSquare1))throw new it.InvalidNotation((0,nt.getFEN)(e),t,rt.i18n.ILLEGAL_UCI_MOVE);return u}Et.parseUCINotation=Go});var St=D(Pn=>{"use strict";Object.defineProperty(Pn,"__esModule",{value:!0});Pn.Position=void 0;var F=Z(),$o=Le(),Dr=Bt(),O=xe(),He=vn(),te=Gt(),Wt=It(),jt=bn(),Ie=En(),st=Lr(),Cn=xr(),at=class{constructor(t,n){switch(arguments.length){case 0:this._impl=(0,te.makeInitial)(0);break;case 1:{if(t==="start")this._impl=(0,te.makeInitial)(0);else if(t==="empty")this._impl=(0,te.makeEmpty)(0);else if(t instanceof at)this._impl=(0,te.makeCopy)(t._impl);else{let i=(0,O.variantFromString)(t);if(i>=0){if(!(0,te.hasCanonicalStartPosition)(i))throw new F.IllegalArgument("Position()");this._impl=(0,te.makeInitial)(i)}else if(typeof t=="string"){let r=t.indexOf(":");if(r<0)this._impl=(0,He.parseFEN)(0,t,!1).position;else{let s=t.substring(0,r),a=(0,O.variantFromString)(s);if(a<0)throw new F.InvalidFEN(t,$o.i18n.INVALID_VARIANT_PREFIX,s);this._impl=(0,He.parseFEN)(a,t.substring(r+1),!1).position}}else throw new F.IllegalArgument("Position()")}break}default:{let i=(0,O.variantFromString)(t);if(i<0)throw new F.IllegalArgument("Position()");if(n==="start"){if(!(0,te.hasCanonicalStartPosition)(i))throw new F.IllegalArgument("Position()");this._impl=(0,te.makeInitial)(i)}else if(n==="empty")this._impl=(0,te.makeEmpty)(i);else if(typeof n=="number"){if(i!==1||!Vr(n))throw new F.IllegalArgument("Position()");this._impl=(0,te.make960FromScharnagl)(n)}else if(typeof n=="string")this._impl=(0,He.parseFEN)(i,n,!1).position;else throw new F.IllegalArgument("Position()");break}}}clear(t="regular"){let n=(0,O.variantFromString)(t);if(n<0)throw new F.IllegalArgument("Position.clear()");this._impl=(0,te.makeEmpty)(n)}reset(){this._impl=(0,te.makeInitial)(0)}reset960(t){if(!Vr(t))throw new F.IllegalArgument("Position.reset960()");this._impl=(0,te.make960FromScharnagl)(t)}resetAntichess(){this._impl=(0,te.makeInitial)(5)}resetHorde(){this._impl=(0,te.makeInitial)(6)}static isEqual(t,n){return t instanceof at&&n instanceof at&&(0,Wt.isEqual)(t._impl,n._impl)}ascii(){return(0,He.ascii)(this._impl)}fen(t,n){if(arguments.length===0)return(0,He.getFEN)(this._impl);if(arguments.length===1&&typeof t=="object"){let i=Bo(t,"Position.fen()"),r=i("fiftyMoveClock",0,l=>Number.isInteger(l)),s=i("fullMoveNumber",1,l=>Number.isInteger(l)),a=i("withVariant",!1,l=>typeof l=="boolean"),o=i("regularFENIfPossible",!1,l=>typeof l=="boolean");return(a?(0,O.variantToString)(this._impl.variant)+":":"")+(0,He.getFEN)(this._impl,r,s,o)}else if(arguments.length===1&&typeof t=="string"){let i=(0,He.parseFEN)(this._impl.variant,t,!1);return this._impl=i.position,{fiftyMoveClock:i.fiftyMoveClock,fullMoveNumber:i.fullMoveNumber}}else if(arguments.length>=2&&typeof t=="string"&&typeof n=="boolean"){let i=(0,He.parseFEN)(this._impl.variant,t,n);return this._impl=i.position,{fiftyMoveClock:i.fiftyMoveClock,fullMoveNumber:i.fullMoveNumber}}else throw new F.IllegalArgument("Position.fen()")}variant(){return(0,O.variantToString)(this._impl.variant)}square(t,n){let i=(0,O.squareFromString)(t);if(i<0)throw new F.IllegalArgument("Position.square()");if(arguments.length===1){let r=this._impl.board[i];return r===-1?"-":(0,O.coloredPieceToString)(r)}else if(n==="-")this._impl.board[i]=-1,this._impl.legal=null,this._impl.effectiveCastling=null,this._impl.effectiveEnPassant=null;else{let r=(0,O.coloredPieceFromString)(n);if(r<0)throw new F.IllegalArgument("Position.square()");this._impl.board[i]=r,this._impl.legal=null,this._impl.effectiveCastling=null,this._impl.effectiveEnPassant=null}}turn(t){if(arguments.length===0)return(0,O.colorToString)(this._impl.turn);{let n=(0,O.colorFromString)(t);if(n<0)throw new F.IllegalArgument("Position.turn()");this._impl.turn=n,this._impl.legal=null,this._impl.effectiveEnPassant=null}}castling(t,n){if(typeof t!="string"||!(this._impl.variant===1?/^[wb][a-h]$/:/^[wb][kq]$/).test(t))throw new F.IllegalArgument("Position.castling()");let i=(0,O.colorFromString)(t[0]),r=this._impl.variant===1?(0,O.fileFromString)(t[1]):t[1]==="k"?7:0;if(arguments.length===1)return(this._impl.castling[i]&1<<r)!==0;if(typeof n=="boolean")n?this._impl.castling[i]|=1<<r:this._impl.castling[i]&=~(1<<r),this._impl.effectiveCastling=null;else throw new F.IllegalArgument("Position.castling()")}effectiveCastling(t){if(typeof t!="string"||!(this._impl.variant===1?/^[wb][a-h]$/:/^[wb][kq]$/).test(t))throw new F.IllegalArgument("Position.effectiveCastling()");let n=(0,O.colorFromString)(t[0]),i=this._impl.variant===1?(0,O.fileFromString)(t[1]):t[1]==="k"?7:0;return(0,Wt.refreshEffectiveCastling)(this._impl),(this._impl.effectiveCastling[n]&1<<i)!==0}enPassant(t){if(arguments.length===0)return this._impl.enPassant<0?"-":(0,O.fileToString)(this._impl.enPassant);if(t==="-")this._impl.enPassant=-1,this._impl.effectiveEnPassant=-1;else{let n=(0,O.fileFromString)(t);if(n<0)throw new F.IllegalArgument("Position.enPassant()");this._impl.enPassant=n,this._impl.effectiveEnPassant=null}}effectiveEnPassant(){return(0,Wt.refreshEffectiveEnPassant)(this._impl),this._impl.effectiveEnPassant<0?"-":(0,O.fileToString)(this._impl.effectiveEnPassant)}isAttacked(t,n){let i=(0,O.squareFromString)(t),r=(0,O.colorFromString)(n);if(i<0||r<0)throw new F.IllegalArgument("Position.isAttacked()");return(0,Dr.isAttacked)(this._impl,i,r)}getAttacks(t,n){let i=(0,O.squareFromString)(t),r=(0,O.colorFromString)(n);if(i<0||r<0)throw new F.IllegalArgument("Position.getAttacks()");return(0,Dr.getAttacks)(this._impl,i,r).map(O.squareToString)}isLegal(){return(0,Wt.isLegal)(this._impl)}kingSquare(t){let n=(0,O.colorFromString)(t);if(n<0)throw new F.IllegalArgument("Position.kingSquare()");(0,Wt.refreshLegalFlagAndKingSquares)(this._impl);let i=this._impl.king[n];return i<0?!1:(0,O.squareToString)(i)}isCheck(){return(0,Ie.isCheck)(this._impl)}isCheckmate(){return(0,Ie.isCheckmate)(this._impl)}isStalemate(){return(0,Ie.isStalemate)(this._impl)}isDead(t=!1){return(0,Ie.isDead)(this._impl,t)}hasMove(){return(0,Ie.hasMove)(this._impl)}moves(){return(0,Ie.moves)(this._impl)}isMoveLegal(t,n){let i=(0,O.squareFromString)(t),r=(0,O.squareFromString)(n);if(i<0||r<0)throw new F.IllegalArgument("Position.isMoveLegal()");let s=(0,Ie.isMoveLegal)(this._impl,i,r);if(!s)return!1;switch(s.type){case"promotion":{let a=o=>{let l=(0,O.pieceFromString)(o);if(l>=0){let u=s.moveDescriptorFactory(l);if(u)return u}throw new F.IllegalArgument("Position.isMoveLegal()")};return a.status="promotion",a}case"regular":{let a=()=>s.moveDescriptor;return a.status="regular",a}}}play(t){if(typeof t=="string")try{return(0,Ie.play)(this._impl,(0,st.parseNotation)(this._impl,t,!1,"standard")),!0}catch(n){if(n instanceof F.InvalidNotation)return!1;throw n}else{if(t instanceof jt.MoveDescriptorImpl)return(0,Ie.play)(this._impl,t),!0;throw new F.IllegalArgument("Position.play()")}}isNullMoveLegal(){return(0,Ie.isNullMoveLegal)(this._impl)}playNullMove(){return(0,Ie.playNullMove)(this._impl)}notation(t,n){if(arguments.length===1&&t instanceof jt.MoveDescriptorImpl)return(0,st.getNotation)(this._impl,t,"standard");if(arguments.length===1&&typeof t=="string")return(0,st.parseNotation)(this._impl,t,!1,"standard");if(arguments.length>=2&&typeof t=="string"&&typeof n=="boolean")return(0,st.parseNotation)(this._impl,t,n,"standard");throw new F.IllegalArgument("Position.notation()")}figurineNotation(t,n){if(arguments.length===1&&t instanceof jt.MoveDescriptorImpl)return(0,st.getNotation)(this._impl,t,"figurine");if(arguments.length===1&&typeof t=="string")return(0,st.parseNotation)(this._impl,t,!1,"figurine");if(arguments.length>=2&&typeof t=="string"&&typeof n=="boolean")return(0,st.parseNotation)(this._impl,t,n,"figurine");throw new F.IllegalArgument("Position.figurineNotation()")}uci(t,n){if(arguments.length===1&&t instanceof jt.MoveDescriptorImpl)return(0,Cn.getUCINotation)(this._impl,t,!1);if(arguments.length>=2&&t instanceof jt.MoveDescriptorImpl&&typeof n=="boolean")return(0,Cn.getUCINotation)(this._impl,t,n);if(arguments.length===1&&typeof t=="string")return(0,Cn.parseUCINotation)(this._impl,t,!1);if(arguments.length>=2&&typeof t=="string"&&typeof n=="boolean")return(0,Cn.parseUCINotation)(this._impl,t,n);throw new F.IllegalArgument("Position.uci()")}};Pn.Position=at;function Vr(e){return Number.isInteger(e)&&e>=0&&e<960}function Bo(e,t){return function(n,i,r){if(e[n]===void 0)return i;{let s=e[n];if(!r(s))throw new F.IllegalArgument(t);return s}}}});var Ht=D(Ye=>{"use strict";Object.defineProperty(Ye,"__esModule",{value:!0});Ye.Variation=Ye.Node=Ye.AbstractNode=void 0;var Kt=class{constructor(){}};Ye.AbstractNode=Kt;var _i=class extends Kt{constructor(){super()}isVariation(){return!1}toString(){return`${this.id()}[${this.notation()}]`}};Ye.Node=_i;var pi=class extends Kt{constructor(){super()}isVariation(){return!0}toString(){return this.id()}};Ye.Variation=pi});var kn=D(An=>{"use strict";Object.defineProperty(An,"__esModule",{value:!0});An.trimAndCollapseSpaces=void 0;function Uo(e){return e.replace(/^\s+|\s+$/g,"").replace(/\s+/g," ")}An.trimAndCollapseSpaces=Uo});var Kr=D(On=>{"use strict";Object.defineProperty(On,"__esModule",{value:!0});On.MoveTreeRoot=void 0;var se=Z(),Wo=Le(),Gr=Ht(),De=St(),ze=class{constructor(){this._position=new De.Position,this._fullMoveNumber=1,this._mainVariationData=Mn(this,!0)}clearTree(){this._mainVariationData=Mn(this,!0)}mainVariation(){return new lt(this._mainVariationData,this._position)}findById(t){let n=t.split("-");if(n.length%2!==1)return;let i=new De.Position(this._position),r=this._mainVariationData;for(let a=0;a+1<n.length;a+=2){let o=Rr(r,n[a],i);if(o===void 0)return;let l=/^v(\d+)$/.exec(n[a+1]);if(!l)return;let u=parseInt(l[1]);if(u>=o.variations.length)return;r=o.variations[u]}let s=n[n.length-1];if(s==="start")return new lt(r,i);{let a=Rr(r,s,i);return a===void 0?void 0:new Ne(a,i)}}};On.MoveTreeRoot=ze;function Rr(e,t,n){let i=e.child;for(;i!==void 0;){if(t===i.fullMoveNumber+i.moveColor)return i;ot(n,i),i=i.child}}function $r(e,t,n,i){return{parentVariation:e,child:void 0,variations:[],moveColor:t,fullMoveNumber:n,moveDescriptor:i,nags:new Set,tags:new Map,comment:void 0,isLongComment:!1}}function Mn(e,t){return{parent:e,child:void 0,isLongVariation:t,nags:new Set,tags:new Map,comment:void 0,isLongComment:!1}}function Br(e,t){if(t==="--"){if(!e.isNullMoveLegal())throw new se.InvalidNotation(e.fen(),"--",Wo.i18n.ILLEGAL_NULL_MOVE);return null}else return e.notation(t)}function ot(e,t){t.moveDescriptor===null?e.playNullMove():e.play(t.moveDescriptor)}function vi(e){if(e.parent instanceof ze)return new De.Position(e.parent._position);{let t=e.parent.parentVariation.child,n=vi(e.parent.parentVariation);for(;t!==e.parent;)ot(n,t),t=t.child;return n}}function Ur(e){return Wr(e.parentVariation)+e.fullMoveNumber+e.moveColor}function Wr(e){if(e.parent instanceof ze)return"";{let t=Ur(e.parent),n=e.parent.variations.indexOf(e);return`${t}-v${n}-`}}function Ii(e){for(;;){if(!e.isLongVariation)return!1;if(e.parent instanceof ze)return!0;e=e.parent.parentVariation}}function Tn(e,t){return Number.isInteger(e)&&e>=0&&e<t.variations.length}function yt(e){return Number.isInteger(e)&&e>=0}function jr(e){return typeof e=="string"&&/^\w+$/.test(e)}var Ne=class extends Gr.Node{constructor(t,n){super(),this._data=t,this._positionBefore=n}id(){return Ur(this._data)}nags(){let t=[];for(let n of this._data.nags)t.push(n);return t.sort((n,i)=>n-i)}hasNag(t){if(!yt(t))throw new se.IllegalArgument("Node.hasNag()");return this._data.nags.has(t)}addNag(t){if(!yt(t))throw new se.IllegalArgument("Node.addNag()");return this._data.nags.add(t)}removeNag(t){if(!yt(t))throw new se.IllegalArgument("Node.removeNag()");return this._data.nags.delete(t)}tags(){let t=[];for(let n of this._data.tags.keys())t.push(n);return t.sort()}tag(t,n){if(!jr(t))throw new se.IllegalArgument("Node.tag()");if(arguments.length===1)return this._data.tags.get(t);if(arguments.length>=2)n==null?this._data.tags.delete(t):this._data.tags.set(t,String(n));else throw new se.IllegalArgument("Node.tag()")}comment(t,n){if(arguments.length===0)return this._data.comment;t==null?(this._data.comment=void 0,this._data.isLongComment=!1):(this._data.comment=String(t),this._data.isLongComment=Boolean(n))}isLongComment(){return this._data.isLongComment&&Ii(this._data.parentVariation)}parentVariation(){let t=vi(this._data.parentVariation);return new lt(this._data.parentVariation,t)}previous(){let t=this._data.parentVariation.child;if(t===this._data)return;let n=vi(this._data.parentVariation);for(;t.child!==this._data;)ot(n,t),t=t.child;return new Ne(t,n)}next(){if(this._data.child===void 0)return;let t=new De.Position(this._positionBefore);return ot(t,this._data),new Ne(this._data.child,t)}notation(){return this._data.moveDescriptor===null?"--":this._positionBefore.notation(this._data.moveDescriptor)}figurineNotation(){return this._data.moveDescriptor===null?"--":this._positionBefore.figurineNotation(this._data.moveDescriptor)}positionBefore(){return new De.Position(this._positionBefore)}position(){let t=new De.Position(this._positionBefore);return ot(t,this._data),t}fullMoveNumber(){return this._data.fullMoveNumber}moveColor(){return this._data.moveColor}variations(){return this._data.variations.map(t=>new lt(t,this._positionBefore))}play(t){let n=new De.Position(this._positionBefore);ot(n,this._data);let i=n.turn(),r=i==="w"?this._data.fullMoveNumber+1:this._data.fullMoveNumber;return this._data.child=$r(this._data.parentVariation,i,r,Br(n,t)),new Ne(this._data.child,n)}removeFollowingMoves(){this._data.child=void 0}addVariation(t){let n=Mn(this._data,t===void 0?!1:t);return this._data.variations.push(n),new lt(n,this._positionBefore)}removeVariation(t){if(!Tn(t,this._data))throw new se.IllegalArgument("Node.removeVariation()");this._data.variations=this._data.variations.slice(0,t).concat(this._data.variations.slice(t+1))}swapVariations(t,n){if(!Tn(t,this._data)||!Tn(n,this._data))throw new se.IllegalArgument("Node.swapVariations()");let i=this._data.variations[t];this._data.variations[t]=this._data.variations[n],this._data.variations[n]=i}promoteVariation(t){if(!Tn(t,this._data)||this._data.variations[t].child===void 0)throw new se.IllegalArgument("Node.promoteVariation()");let n=this._data,i=this._data.variations[t].child,r=n.variations;n.variations=[],r[t]=Mn(i,!1),r[t].child=n,this._data=i,i.variations=r.concat(i.variations),jo(n).child=i,qr(i,n.parentVariation),qr(n,r[t]);for(let s of i.variations)s.parent=i}};function jo(e){let t=e.parentVariation;for(;t.child!==e;)t=t.child;return t}function qr(e,t){let n=e;for(;n!==void 0;)n.parentVariation=t,n=n.child}var lt=class extends Gr.Variation{constructor(t,n){super(),this._data=t,this._initialPosition=n}id(){return Wr(this._data)+"start"}nags(){let t=[];for(let n of this._data.nags)t.push(n);return t.sort((n,i)=>n-i)}hasNag(t){if(!yt(t))throw new se.IllegalArgument("Variation.hasNag()");return this._data.nags.has(t)}addNag(t){if(!yt(t))throw new se.IllegalArgument("Variation.addNag()");return this._data.nags.add(t)}removeNag(t){if(!yt(t))throw new se.IllegalArgument("Variation.removeNag()");return this._data.nags.delete(t)}tags(){let t=[];for(let n of this._data.tags.keys())t.push(n);return t.sort()}tag(t,n){if(!jr(t))throw new se.IllegalArgument("Variation.tag()");if(arguments.length===1)return this._data.tags.get(t);if(arguments.length>=2)n==null?this._data.tags.delete(t):this._data.tags.set(t,String(n));else throw new se.IllegalArgument("Variation.tag()")}comment(t,n){if(arguments.length===0)return this._data.comment;t==null?(this._data.comment=void 0,this._data.isLongComment=!1):(this._data.comment=String(t),this._data.isLongComment=Boolean(n))}isLongComment(){return this._data.isLongComment&&Ii(this._data)}parentNode(){return this._data.parent instanceof ze?void 0:new Ne(this._data.parent,this._initialPosition)}first(){return this._data.child===void 0?void 0:new Ne(this._data.child,this._initialPosition)}nodes(){let t=[],n=this._data.child,i,r=this._initialPosition;for(;n!==void 0;)r=new De.Position(r),i!==void 0&&ot(r,i),t.push(new Ne(n,r)),i=n,n=n.child;return t}plyCount(){let t=0,n=this._data.child;for(;n!==void 0;)++t,n=n.child;return t}isLongVariation(){return Ii(this._data)}initialPosition(){return new De.Position(this._initialPosition)}initialFullMoveNumber(){return this._data.parent instanceof ze?this._data.parent._fullMoveNumber:this._data.parent.fullMoveNumber}play(t){let n=this._initialPosition.turn(),i=this.initialFullMoveNumber();return this._data.child=$r(this._data,n,i,Br(this._initialPosition,t)),new Ne(this._data.child,this._initialPosition)}clearMoves(){this._data.child=void 0}}});var Ln=D(Fn=>{"use strict";Object.defineProperty(Fn,"__esModule",{value:!0});Fn.Game=void 0;var Ct=mn(),Te=Z(),Ni=$t(),Yt=St(),zr=kn(),Ko=Kr(),Pt=xe(),bi=class{constructor(){this._playerName=[void 0,void 0],this._playerElo=[void 0,void 0],this._playerTitle=[void 0,void 0],this._result=3,this._moveTreeRoot=new Ko.MoveTreeRoot}playerName(t,n){let i=(0,Pt.colorFromString)(t);if(i<0)throw new Te.IllegalArgument("Game.playerName()");if(arguments.length===1)return this._playerName[i];this._playerName[i]=be(n)}playerElo(t,n){let i=(0,Pt.colorFromString)(t);if(i<0)throw new Te.IllegalArgument("Game.playerElo()");if(arguments.length===1)return this._playerElo[i];if(n=Ho(n),n===void 0||Number.isInteger(n)&&n>=0)this._playerElo[i]=n;else throw new Te.IllegalArgument("Game.playerElo()")}playerTitle(t,n){let i=(0,Pt.colorFromString)(t);if(i<0)throw new Te.IllegalArgument("Game.playerTitle()");if(arguments.length===1)return this._playerTitle[i];this._playerTitle[i]=be(n)}event(t){if(arguments.length===0)return this._event;this._event=be(t)}round(t){if(arguments.length===0)return this._round;this._round=be(t)}date(t,n,i){switch(arguments.length){case 0:return this._date;case 1:if(t==null)this._date=void 0;else if(t instanceof Ct.DateValue)this._date=t;else if(t instanceof Date)this._date=new Ct.DateValue(t);else if(Ct.DateValue.isValid(t))this._date=new Ct.DateValue(t);else throw new Te.IllegalArgument("Game.date()");break;default:if(Ct.DateValue.isValid(t,n,i))this._date=new Ct.DateValue(t,n,i);else throw new Te.IllegalArgument("Game.date()");break}}dateAsDate(){return this._date===void 0?void 0:this._date.toDate()}dateAsString(t){return this._date===void 0?void 0:this._date.toHumanReadableString(t)}site(t){if(arguments.length===0)return this._site;this._site=be(t)}annotator(t){if(arguments.length===0)return this._annotator;this._annotator=be(t)}eco(t){if(arguments.length===0)return this._eco;if(t=be(t),t!==void 0&&!(0,Ni.isValidECO)(t))throw new Te.IllegalArgument("Game.eco()");this._eco=t}opening(t){if(arguments.length===0)return this._opening;this._opening=be(t)}openingVariation(t){if(arguments.length===0)return this._openingVariation;this._openingVariation=be(t)}openingSubVariation(t){if(arguments.length===0)return this._openingSubVariation;this._openingSubVariation=be(t)}termination(t){if(arguments.length===0)return this._termination;this._termination=be(t)}result(t){if(arguments.length===0)return(0,Pt.resultToString)(this._result);{let n=(0,Pt.resultFromString)(t);if(n<0)throw new Te.IllegalArgument("Game.result()");this._result=n}}variant(){return this._moveTreeRoot._position.variant()}initialPosition(t,n){if(arguments.length===0)return new Yt.Position(this._moveTreeRoot._position);if(!(t instanceof Yt.Position))throw new Te.IllegalArgument("Game.initialPosition()");if(arguments.length>=2){if(!Number.isInteger(n))throw new Te.IllegalArgument("Game.initialPosition()");this._moveTreeRoot._fullMoveNumber=n}else this._moveTreeRoot._fullMoveNumber=1;this._moveTreeRoot._position=new Yt.Position(t),this._moveTreeRoot.clearTree()}mainVariation(){return this._moveTreeRoot.mainVariation()}nodes(t=!1){if(!t)return this.mainVariation().nodes();let n=[];function i(r){for(let s of r.nodes()){for(let a of s.variations())i(a);n.push(s)}}return i(this.mainVariation()),n}plyCount(){return this._moveTreeRoot.mainVariation().plyCount()}findById(t){return this._moveTreeRoot.findById(t)}ascii(){let t=[];function n(o){o!==void 0&&t.push(o)}n(Yo(this._event,this._round)),n(zt("Site",this._site)),n(zt("Date",this.dateAsString("en-us"))),n(Hr("White",this._playerName[0],this._playerElo[0],this._playerTitle[0])),n(Hr("Black",this._playerName[1],this._playerElo[1],this._playerTitle[1])),n(zt("Annotator",this._annotator)),n(zt("ECO",this._eco)),n(zo(this._opening,this._openingVariation,this._openingSubVariation)),n(zt("Termination",this._termination));let i=this._moveTreeRoot._position.variant();i!=="regular"&&t.push("Variant: "+i),(!(0,Ni.variantWithCanonicalStartPosition)(i)||!Yt.Position.isEqual(this._moveTreeRoot._position,new Yt.Position(i)))&&t.push(this._moveTreeRoot._position.ascii());function r(o){return o.first()!==void 0||o.nags().length>0||o.tags().length>0||o.comment()!==void 0}function s(o,l,u){let f=l+o.fullMoveNumber()+(o.moveColor()==="w"?".":"...")+o.notation(),d=Yr(o);t.push(d.length===0?f:f+" "+d.join(" "));let m=!1;for(let _ of o.variations())r(_)&&(t.push(l+" |"),a(_,l+(u?" |  ":"    "),l+" +- ",!1),m=!0);return m}function a(o,l,u,f){let d=Yr(o);d.length>0&&t.push(u+d.join(" "));let m=o.first(),_=!1,E=!0;for(;m!==void 0;){_&&t.push(l+" |");let q=m.next();_=s(m,E&&d.length===0?u:l,f||q!==void 0),E=!1,m=q}}return a(this._moveTreeRoot.mainVariation(),"","",!1),t.push((0,Pt.resultToString)(this._result)),t.join(`
`)}};Fn.Game=bi;function be(e){return e==null?void 0:String(e)}function Ho(e){return e==null?void 0:Number(e)}function we(e){return e=(0,zr.trimAndCollapseSpaces)(e),e===""?"<empty>":e}function zt(e,t){return t===void 0?void 0:`${e}: ${we(t)}`}function Yo(e,t){if(e===void 0&&t===void 0)return;let n=e===void 0?"Event: <undefined>":`Event: ${we(e)}`;return t!==void 0&&(n+=` (${we(t)})`),n}function Hr(e,t,n,i){if(t===void 0&&n===void 0&&i===void 0)return;let r=t===void 0?`${e}: <undefined>`:`${e}: ${we(t)}`;return n!==void 0&&i!==void 0?r+=` (${we(i)} ${n})`:n!==void 0?r+=` (${n})`:i!==void 0&&(r+=` (${we(i)})`),r}function zo(e,t,n){if(e===void 0&&t===void 0&&n===void 0)return;let i=e===void 0?"Opening: <undefined>":`Opening: ${we(e)}`;return n!==void 0?i+=` (${t===void 0?"<undefined>":we(t)}, ${we(n)})`:t!==void 0&&(i+=` (${we(t)})`),i}function Yr(e){let t=[];for(let i of e.nags())t.push((0,Ni.nagSymbol)(i));for(let i of e.tags())t.push(`${i}={${(0,zr.trimAndCollapseSpaces)(e.tag(i))}}`);let n=e.comment();return n!==void 0&&t.push(we(n)),t}});var xn=D(At=>{"use strict";Object.defineProperty(At,"__esModule",{value:!0});At.Database=At.isValidGameIndex=void 0;var Xo=Z();function Xr(e){return Number.isInteger(e)&&e>=0}At.isValidGameIndex=Xr;var wi=class{constructor(){}gameCount(){return this.doGameCount()}game(t){if(!Xr(t))throw new Xo.IllegalArgument("Database.game()");return this.doGame(t)}};At.Database=wi});var Qr=D(Dn=>{"use strict";Object.defineProperty(Dn,"__esModule",{value:!0});Dn.TokenStream=void 0;var Ei=Z(),Si=Le(),yi=kn();function Y(e,t){let n=e;return n.needIncrementLineIndex=t!==void 0&&t,n.matchedIndex=-1,n.matched=null,n}var Qo=5,Jo=11,W=new Map;W.set("!!",3);W.set("!",1);W.set("!?",5);W.set("?!",6);W.set("?",2);W.set("??",4);W.set("+-",18);W.set("+/-",16);W.set("+/=",14);W.set("+=",14);W.set("=",10);W.set("~",13);W.set("inf",13);W.set("=/+",15);W.set("=+",15);W.set("-/+",17);W.set("-+",19);W.set("RR",145);W.set("N",146);var Ci=class{constructor(t,n){this._pos=0,this._lineIndex=1,this._token=0,this._tokenValue=null,this._tokenCharacterIndex=-1,this._tokenLineIndex=-1,this._emptyLineBeforeToken=!1,this._emptyLineAfterToken=!1,this._matchSpaces=Y(/[ \f\t\v]+/g),this._matchLineBreak=Y(/\r?\n|\r/g,!0),this._matchFastAdvance=Y(/[^ \f\t\v\r\n"{][^ \f\t\v\r\n"{10*]*/g),this._matchBeginHeader=Y(/\[/g),this._matchEndHeader=Y(/\]/g),this._matchHeaderId=Y(/(\w+)/g),this._matchEnterHeaderValue=Y(/"/g),this._matchMoveNumber=Y(/[0-9]+\.(?:\.\.)?/g),this._matchMove=Y(/(?:O-O(?:-O)?|0-0(?:-0)?|[KQRBN][a-h]?[1-8]?x?[a-h][1-8]|(?:[a-h]x?)?[a-h][1-8](?:=?[KQRBNP])?)[+#]?|--/g),this._matchNag=Y(/([!?][!?]?|\+\/?[-=]|[-=]\/?\+|=|inf|~|RR|N)|\$([1-9][0-9]*)/g),this._matchEnterComment=Y(/\{/g),this._matchBeginVariation=Y(/\(/g),this._matchEndVariation=Y(/\)/g),this._matchEndOfGame=Y(/1-0|0-1|1\/2-1\/2|\*/g),this._headerValueMode=Y(/((?:[^\\"\f\t\v\r\n]|\\[^\f\t\v\r\n])*)"/g),this._headerValueDegradedMode=Y(/[^\r\n]*/g),this._commentMode=Y(/((?:[^\\}]|\\(?:.|[\r\n]))*)\}/g,!0),t.codePointAt(0)===65279&&(t=t.substring(1)),this._text=t,n!==void 0&&(this._pos=n.pos,this._lineIndex=n.lineIndex)}text(){return this._text}currentLocation(){return{pos:this._pos,lineIndex:this._lineIndex}}emptyLineBeforeToken(){return this._emptyLineBeforeToken}emptyLineAfterToken(){return this._emptyLineAfterToken}token(){return this._token}tokenValue(){return this._tokenValue}tokenCharacterIndex(){return this._tokenCharacterIndex}tokenLineIndex(){return this._tokenLineIndex}isMoveTextSection(){return this._token>=Qo&&this._token<=Jo}consumeToken(){if(this._emptyLineBeforeToken=this._token===0||this._token===11?this.skipBlanks():this._emptyLineAfterToken,this._pos>=this._text.length)return this._tokenCharacterIndex=this._text.length,this._tokenLineIndex=this._lineIndex,!1;if(this._tokenCharacterIndex=this._pos,this._tokenLineIndex=this._lineIndex,this.testAtPos(this._matchMoveNumber))this._token=5,this._tokenValue=null;else if(this.testAtPos(this._matchMove))this._token=6,this._tokenValue=this._matchMove.matched[0];else if(this.testAtPos(this._matchNag))this._token=7,this._tokenValue=this._matchNag.matched[2]===void 0?W.get(this._matchNag.matched[1]):parseInt(this._matchNag.matched[2],10);else if(this.testAtPos(this._matchEnterComment)){if(!this.testAtPos(this._commentMode))throw new Ei.InvalidPGN(this._text,this._pos,this._lineIndex,Si.i18n.INVALID_PGN_TOKEN);this._token=8,this._tokenValue=el(this._commentMode.matched[1])}else if(this.testAtPos(this._matchBeginVariation))this._token=9,this._tokenValue=null;else if(this.testAtPos(this._matchEndVariation))this._token=10,this._tokenValue=null;else if(this.testAtPos(this._matchEndOfGame))this._token=11,this._tokenValue=this._matchEndOfGame.matched[0];else if(this.testAtPos(this._matchBeginHeader))this._token=1,this._tokenValue=null;else if(this.testAtPos(this._matchEndHeader))this._token=2,this._tokenValue=null;else if(this.testAtPos(this._matchHeaderId))this._token=3,this._tokenValue=this._matchHeaderId.matched[1];else if(this.testAtPos(this._matchEnterHeaderValue)){if(!this.testAtPos(this._headerValueMode))throw new Ei.InvalidPGN(this._text,this._pos,this._lineIndex,Si.i18n.INVALID_PGN_TOKEN);this._token=4,this._tokenValue=Zo(this._headerValueMode.matched[1])}else throw new Ei.InvalidPGN(this._text,this._pos,this._lineIndex,Si.i18n.INVALID_PGN_TOKEN);return this._emptyLineAfterToken=this._token===11?!1:this.skipBlanks(),!0}skipGame(){let t=!1;for(this._token=0;;){if(this.skipBlanks(),this._pos>=this._text.length)return t;if(t=!0,this.testAtPos(this._matchEnterComment)){if(!this.testAtPos(this._commentMode))return this._pos=this._text.length,!0}else if(this.testAtPos(this._matchEnterHeaderValue))this.testAtPos(this._headerValueMode)||this.testAtPos(this._headerValueDegradedMode);else{if(this.testAtPos(this._matchEndOfGame))return!0;this.testAtPos(this._matchFastAdvance)}}}skipBlanks(){let t=0;for(;this._pos<this._text.length;)if(!this.testAtPos(this._matchSpaces))if(this.testAtPos(this._matchLineBreak))++t;else break;return t>=2}testAtPos(t){if(t.matchedIndex<this._pos&&(t.lastIndex=this._pos,t.matched=t.exec(this._text),t.matchedIndex=t.matched===null?this._text.length:t.matched.index),t.matchedIndex===this._pos){if(this._pos=t.lastIndex,t.needIncrementLineIndex){let n=/\r?\n|\r/g;for(;n.exec(t.matched[0]);)++this._lineIndex}return!0}else return!1}};Dn.TokenStream=Ci;function Zo(e){return(0,yi.trimAndCollapseSpaces)(e.replace(/\\([\\"])/g,"$1"))}function el(e){e=e.replace(/\\([\\}])/g,"$1");let t=new Map,n=e.replace(/\[%(\w+)\s([^[\]]*)\]/g,(i,r,s)=>(s=(0,yi.trimAndCollapseSpaces)(s),s!==""&&t.set(r,s)," "));return n=(0,yi.trimAndCollapseSpaces)(n),n===""&&(n=void 0),{comment:n,tags:t}}});var ns=D(kt=>{"use strict";Object.defineProperty(kt,"__esModule",{value:!0});kt.readOneGame=kt.readDatabase=void 0;var tl=xn(),Ve=mn(),z=Z(),nl=Ln(),es=$t(),ne=Le(),Jr=Ht(),Pi=St(),Ai=Qr();function Xt(e){return e==="?"?void 0:e}function Zr(e){if(/^\d+$/.test(e)){let t=Number(e);if(Number.isInteger(t))return t}}function il(e){if(/^([0-9]{4})\.([0-9]{2})\.([0-9]{2})$/.test(e)){let t=RegExp.$1,n=RegExp.$2,i=RegExp.$3,r=parseInt(t,10),s=parseInt(n,10),a=parseInt(i,10);return Ve.DateValue.isValid(r,s,a)?new Ve.DateValue(r,s,a):Ve.DateValue.isValid(r,s)?new Ve.DateValue(r,s):new Ve.DateValue(r)}else if(/^([0-9]{4})\.([0-9]{2})\.\?\?$/.test(e)){let t=RegExp.$1,n=RegExp.$2,i=parseInt(t,10),r=parseInt(n,10);return Ve.DateValue.isValid(i,r)?new Ve.DateValue(i,r):new Ve.DateValue(i)}else if(/^([0-9]{4})(?:\.\?\?\.\?\?)?$/.test(e)){let t=parseInt(RegExp.$1,10);return new Ve.DateValue(t)}else return}function rl(e){return(0,es.isValidECO)(e)?e:void 0}function sl(e){return e=e.toLowerCase(),e==="regular"||e==="standard"?"regular":e==="fischerandom"||/^chess[ -]?960$/.test(e)?"chess960":/^no[ -]king$/.test(e)?"no-king":/^white[ -]king[ -]only$/.test(e)?"white-king-only":/^black[ -]king[ -]only$/.test(e)?"black-king-only":/^anti[ -]?chess/.test(e)?"antichess":e==="horde"?"horde":void 0}function al(e,t,n,i,r,s,a){switch(r=r.trim(),i){case"White":t.playerName("w",Xt(r));break;case"Black":t.playerName("b",Xt(r));break;case"WhiteElo":t.playerElo("w",Zr(r));break;case"BlackElo":t.playerElo("b",Zr(r));break;case"WhiteTitle":t.playerTitle("w",r);break;case"BlackTitle":t.playerTitle("b",r);break;case"Event":t.event(Xt(r));break;case"Round":t.round(Xt(r));break;case"Date":t.date(il(r));break;case"Site":t.site(Xt(r));break;case"Annotator":t.annotator(r);break;case"ECO":t.eco(rl(r));break;case"Opening":t.opening(r);break;case"Variation":t.openingVariation(r);break;case"SubVariation":t.openingSubVariation(r);break;case"Termination":t.termination(r);break;case"FEN":n.fen=r,n.fenTokenCharacterIndex=s,n.fenTokenLineIndex=a;break;case"Variant":if(n.variant=sl(r),n.variant===void 0)throw new z.InvalidPGN(e.text(),s,a,ne.i18n.UNKNOWN_VARIANT,r);n.variantTokenCharacterIndex=s,n.variantTokenLineIndex=a;break}}function ol(e,t,n){if(n.fen!==void 0)try{let i=n.variant===void 0?new Pi.Position:new Pi.Position(n.variant,"empty"),r=i.fen(n.fen);t.initialPosition(i,r.fullMoveNumber)}catch(i){throw i instanceof z.InvalidFEN?new z.InvalidPGN(e.text(),n.fenTokenCharacterIndex,n.fenTokenLineIndex,ne.i18n.INVALID_FEN_IN_PGN_TEXT,i.message):i}else if(n.variant!==void 0)if((0,es.variantWithCanonicalStartPosition)(n.variant)){let i=new Pi.Position(n.variant,"start");t.initialPosition(i,1)}else throw new z.InvalidPGN(e.text(),n.variantTokenCharacterIndex,n.variantTokenLineIndex,ne.i18n.VARIANT_WITHOUT_FEN,n.variant)}function ts(e){let t=null,n=null,i=[],r={};for(;e.consumeToken();)switch(t===null&&(t=new nl.Game),e.isMoveTextSection()&&n===null&&(ol(e,t,r),n=t.mainVariation()),e.token()){case 1:{if(n!==null)throw new z.InvalidPGN(e.text(),e.tokenCharacterIndex(),e.tokenLineIndex(),ne.i18n.UNEXPECTED_PGN_HEADER);if(!e.consumeToken()||e.token()!==3)throw new z.InvalidPGN(e.text(),e.tokenCharacterIndex(),e.tokenLineIndex(),ne.i18n.MISSING_PGN_HEADER_ID);let s=e.tokenValue();if(!e.consumeToken()||e.token()!==4)throw new z.InvalidPGN(e.text(),e.tokenCharacterIndex(),e.tokenLineIndex(),ne.i18n.MISSING_PGN_HEADER_VALUE);let a=e.tokenValue(),o=e.tokenCharacterIndex(),l=e.tokenLineIndex();if(!e.consumeToken()||e.token()!==2)throw new z.InvalidPGN(e.text(),e.tokenCharacterIndex(),e.tokenLineIndex(),ne.i18n.MISSING_END_OF_PGN_HEADER);al(e,t,r,s,a,o,l);break}case 5:break;case 6:try{n=n.play(e.tokenValue())}catch(s){throw s instanceof z.InvalidNotation?new z.InvalidPGN(e.text(),e.tokenCharacterIndex(),e.tokenLineIndex(),ne.i18n.INVALID_MOVE_IN_PGN_TEXT,s.notation,s.message):s}break;case 7:n.addNag(e.tokenValue());break;case 8:{let s=e.tokenValue();for(let[a,o]of s.tags)n.tag(a,o);if(s.comment!==void 0){let a=n instanceof Jr.Variation?e.emptyLineAfterToken():e.emptyLineBeforeToken();n.comment(s.comment,a)}break}case 9:if(n instanceof Jr.Variation)throw new z.InvalidPGN(e.text(),e.tokenCharacterIndex(),e.tokenLineIndex(),ne.i18n.UNEXPECTED_BEGIN_OF_VARIATION);i.push(n),n=n.addVariation(e.emptyLineBeforeToken());break;case 10:if(i.length===0)throw new z.InvalidPGN(e.text(),e.tokenCharacterIndex(),e.tokenLineIndex(),ne.i18n.UNEXPECTED_END_OF_VARIATION);n=i.pop();break;case 11:if(i.length!==0)throw new z.InvalidPGN(e.text(),e.tokenCharacterIndex(),e.tokenLineIndex(),ne.i18n.UNEXPECTED_END_OF_GAME);return t.result(e.tokenValue()),t;default:throw new z.InvalidPGN(e.text(),e.tokenCharacterIndex(),e.tokenLineIndex(),ne.i18n.INVALID_PGN_TOKEN)}throw new z.InvalidPGN(e.text(),e.tokenCharacterIndex(),e.tokenLineIndex(),ne.i18n.UNEXPECTED_END_OF_TEXT)}var ki=class extends tl.Database{constructor(t){for(super(),this._currentGameIndex=-1,this._text=t,this._gameLocations=[],this._stream=new Ai.TokenStream(t);;){let n=this._stream.currentLocation();if(!this._stream.skipGame())break;this._gameLocations.push(n)}}doGameCount(){return this._gameLocations.length}doGame(t){if(t>=this._gameLocations.length)throw new z.InvalidPGN(this._text,-1,-1,ne.i18n.INVALID_GAME_INDEX,t,this._gameLocations.length);this._currentGameIndex!==t&&(this._stream=new Ai.TokenStream(this._text,this._gameLocations[t])),this._currentGameIndex=-1;let n=ts(this._stream);return this._currentGameIndex=t+1,n}};function ll(e){return new ki(e)}kt.readDatabase=ll;function ul(e,t){let n=new Ai.TokenStream(e),i=0;for(;i!==t;)if(n.skipGame())++i;else throw new z.InvalidPGN(e,-1,-1,ne.i18n.INVALID_GAME_INDEX,t,i);return ts(n)}kt.readOneGame=ul});var cs=D(Tt=>{"use strict";Object.defineProperty(Tt,"__esModule",{value:!0});Tt.writeGames=Tt.writeGame=void 0;var cl=$t(),fl=Ht(),is=St(),Vn=kn();function as(e){return e.replace(/([\\"])/g,"\\$1")}function rs(e){return e.replace(/([\\}])/g,"\\$1")}function Qt(e){return e!==void 0&&(e=(0,Vn.trimAndCollapseSpaces)(e)),e?as(e):"?"}function hl(e){return e===void 0?"????.??.??":e.toPGNString()}function dl(e){switch(e){case"regular":return;case"chess960":return"Fischerandom";case"antichess":return"Antichess";case"horde":return"Horde";default:return e}}function Re(e,t){return t!==void 0&&(t=(0,Vn.trimAndCollapseSpaces)(t)),t?`[${e} "${as(t)}"]
`:""}function ss(e,t){return t===void 0?"":`[${e} "${t}"]
`}function os(e,t,n,i){for(let l of e.nags())n("$"+l,!1,!1);let r=e.comment();r!==void 0&&(r=(0,Vn.trimAndCollapseSpaces)(r));let s=e.tags(),a=new Map,o=!1;for(let l of s){let u=(0,Vn.trimAndCollapseSpaces)(e.tag(l).replace(/[[\]]/g,""));u&&(a.set(l,u),o=!0)}if(o||r){r&&e.isLongComment()&&e instanceof fl.Node&&i(),n("{",!1,!0);for(let l of s){let u=a.get(l);if(u){n("[%"+l,!1,!1);for(let f of rs(u+"]").split(" "))n(f,!1,!1)}}if(r)for(let l of rs(r).split(" "))n(l,!1,!1);return n("}",!0,!1),r&&e.isLongComment()&&t&&i(),!0}else return!1}function gl(e,t,n,i,r){e.moveColor()==="w"?i(e.fullMoveNumber()+".",!1,!1):t&&i(e.fullMoveNumber()+"...",!1,!1),i(e.notation(),!1,!1);let s=e.variations(),a=-1;for(let l=s.length-1;l>=0;--l)if(s[l].first()!==void 0){a=l;break}let o=os(e,(n||e.next()!==void 0)&&a<0,i,r);for(let l=0;l<s.length;++l){let u=s[l];u.first()!==void 0&&(u.isLongVariation()&&r(),i("(",!1,!0),ls(u,!1,i,r),i(")",!0,!1),l===a&&u.isLongVariation()&&r(),o=!0)}return o}function ls(e,t,n,i){os(e,!0,n,i);let r=e.first(),s=!0;for(;r!==void 0;)s=gl(r,s,t,n,i),r=r.next()}function us(e,t){let n="";n+=`[Event "${Qt(e.event())}"]
`,n+=`[Site "${Qt(e.site())}"]
`,n+=`[Date "${hl(e.date())}"]
`,n+=`[Round "${Qt(e.round())}"]
`,n+=`[White "${Qt(e.playerName("w"))}"]
`,n+=`[Black "${Qt(e.playerName("b"))}"]
`,n+=`[Result "${e.result()}"]
`;let i=e.variant(),r=e.initialPosition(),s=!(0,cl.variantWithCanonicalStartPosition)(i)||!is.Position.isEqual(r,new is.Position(i));n+=Re("Annotator",e.annotator()),n+=ss("BlackElo",e.playerElo("b")),n+=Re("BlackTitle",e.playerTitle("b")),n+=Re("ECO",e.eco()),s&&(n+=`[FEN "${r.fen({fullMoveNumber:e.mainVariation().initialFullMoveNumber(),regularFENIfPossible:!0})}"]
`),n+=Re("Opening",e.opening()),t.withPlyCount&&(n+=`[PlyCount "${e.plyCount()}"]
`),s&&(n+=`[SetUp "1"]
`),n+=Re("SubVariation",e.openingSubVariation()),n+=Re("Termination",e.termination()),n+=Re("Variant",dl(i)),n+=Re("Variation",e.openingVariation()),n+=ss("WhiteElo",e.playerElo("w")),n+=Re("WhiteTitle",e.playerTitle("w")),n+=`
`;let a="",o=!1;function l(f,d,m){a.length===0?a=f:a.length+f.length+(o||d?0:1)<=80?a+=(o||d?"":" ")+f:(n+=a+`
`,a=f),o=m}function u(){n+=a+`
`,n+=`
`,a="",o=!1}return ls(e.mainVariation(),!0,l,u),l(e.result(),!1,!1),n+=a+`
`,n}Tt.writeGame=us;function ml(e,t){return e.map(n=>us(n,t)).join(`

`)}Tt.writeGames=ml});var gs=D(Mt=>{"use strict";Object.defineProperty(Mt,"__esModule",{value:!0});Mt.pgnWrite=Mt.pgnRead=void 0;var _l=xn(),Ti=Z(),fs=Ln(),hs=ns(),ds=cs();function pl(e,t){if(typeof e!="string")throw new Ti.IllegalArgument("pgnRead()");if(arguments.length===1)return(0,hs.readDatabase)(e);if(!(0,_l.isValidGameIndex)(t))throw new Ti.IllegalArgument("pgnRead()");return(0,hs.readOneGame)(e,t)}Mt.pgnRead=pl;function vl(e,t){if(t==null&&(t={}),e instanceof fs.Game)return(0,ds.writeGame)(e,t);if(Array.isArray(e)&&e.every(n=>n instanceof fs.Game))return(0,ds.writeGames)(e,t);throw new Ti.IllegalArgument("pgnWrite()")}Mt.pgnWrite=vl});var Oi=D(p=>{"use strict";Object.defineProperty(p,"__esModule",{value:!0});p.pgnWrite=p.pgnRead=p.Database=p.Game=p.Variation=p.Node=p.AbstractNode=p.Position=p.isMoveDescriptor=p.MoveDescriptor=p.DateValue=p.isValidECO=p.nagSymbol=p.variantWithCanonicalStartPosition=p.oppositeColor=p.coordinatesToSquare=p.squareToCoordinates=p.squareColor=p.forEachSquare=p.exception=p.i18n=void 0;var Il=Le();Object.defineProperty(p,"i18n",{enumerable:!0,get:function(){return Il.i18n}});p.exception=Z();var Xe=$t();Object.defineProperty(p,"forEachSquare",{enumerable:!0,get:function(){return Xe.forEachSquare}});Object.defineProperty(p,"squareColor",{enumerable:!0,get:function(){return Xe.squareColor}});Object.defineProperty(p,"squareToCoordinates",{enumerable:!0,get:function(){return Xe.squareToCoordinates}});Object.defineProperty(p,"coordinatesToSquare",{enumerable:!0,get:function(){return Xe.coordinatesToSquare}});Object.defineProperty(p,"oppositeColor",{enumerable:!0,get:function(){return Xe.oppositeColor}});Object.defineProperty(p,"variantWithCanonicalStartPosition",{enumerable:!0,get:function(){return Xe.variantWithCanonicalStartPosition}});Object.defineProperty(p,"nagSymbol",{enumerable:!0,get:function(){return Xe.nagSymbol}});Object.defineProperty(p,"isValidECO",{enumerable:!0,get:function(){return Xe.isValidECO}});var Nl=mn();Object.defineProperty(p,"DateValue",{enumerable:!0,get:function(){return Nl.DateValue}});var ms=si();Object.defineProperty(p,"MoveDescriptor",{enumerable:!0,get:function(){return ms.MoveDescriptor}});Object.defineProperty(p,"isMoveDescriptor",{enumerable:!0,get:function(){return ms.isMoveDescriptor}});var bl=St();Object.defineProperty(p,"Position",{enumerable:!0,get:function(){return bl.Position}});var Mi=Ht();Object.defineProperty(p,"AbstractNode",{enumerable:!0,get:function(){return Mi.AbstractNode}});Object.defineProperty(p,"Node",{enumerable:!0,get:function(){return Mi.Node}});Object.defineProperty(p,"Variation",{enumerable:!0,get:function(){return Mi.Variation}});var wl=Ln();Object.defineProperty(p,"Game",{enumerable:!0,get:function(){return wl.Game}});var El=xn();Object.defineProperty(p,"Database",{enumerable:!0,get:function(){return El.Database}});var _s=gs();Object.defineProperty(p,"pgnRead",{enumerable:!0,get:function(){return _s.pgnRead}});Object.defineProperty(p,"pgnWrite",{enumerable:!0,get:function(){return _s.pgnWrite}})});var Pl={};module.exports=Ms(Pl);var Un=Se(require("fs")),ae=Se(mt()),Ss=Se(Oi());var ct=Se(mt());var Gn=Se(require("fs")),ps=require("readline"),vs=require("child_process"),ut=Se(mt());var Jt=e=>{ut.error("uci",e),process.exit(1)},Rn=class{constructor(t,n){M(this,"instance");M(this,"callback");M(this,"options");if(this.options=t.options,this.callback=n,Gn.existsSync(this.options.engine)||Jt(`engine not found: ${this.options.engine}`),Gn.statSync(this.options.engine).isFile()||Jt(`engine not valid: ${this.options.engine}`),this.instance=(0,vs.spawn)(this.options.engine),!this.instance.stdout||!this.instance.stderr)return;(0,ps.createInterface)({input:this.instance.stdout}).on("line",r=>{this.options.debug&&ut.debug("uci receive:",r),this.callback(r,t)})}async init(){this.send("isready")}send(t){this.options.debug&&ut.debug("uci send:",t),this.instance?.stdin?.writable&&!this.instance.exitCode&&this.instance?.stdin?.write(`${t}
`)}exit(){!this.instance||this.instance.exitCode||(this.send("stop"),this.send("quit"),setTimeout(()=>this.instance.kill("SIGTERM"),10),setTimeout(()=>this.instance.kill("SIGKILL"),100))}},qn=class{constructor(t,n){M(this,"instance");M(this,"callback");M(this,"options");M(this,"parent");this.options=t.options,this.callback=n,this.parent=t}async init(){let t=await import(this.options.engine);global.fetch&&delete global.fetch,this.instance=await t.default(),this.instance.addMessageListener(n=>{this.options.debug&&ut.debug("uci receive:",n),this.callback(n,this.parent)}),this.instance.postMessage("isready")}send(t){this.options.debug&&ut.debug("uci send:",t),this.instance&&this.instance.postMessage(t)}exit(){!this.instance||(this.send("stop"),this.send("quit"))}};var Ot=class{constructor(t,n,i){M(this,"score");M(this,"moves");M(this,"type");this.score=t,(n==="syzygy"||n==="mate")&&(this.score=100-this.score),this.moves=i,this.type=n}toString(){switch(this.type){case"cp":return this.score;case"syzygy":return`solved score ${this.moves}`;case"mate":return`mate in ${this.moves}`;case"lowerbound":return`>= ${this.score}`;case"upperbound":return`<= ${this.score}`;default:return""}}},Zt=class{constructor(t){M(this,"instance");M(this,"timeout");M(this,"startTime",process.hrtime.bigint());M(this,"noMoves",!1);M(this,"lines",new Map);M(this,"depth",0);M(this,"turn");M(this,"engineOptions",[]);M(this,"duration",0);M(this,"lastFen","");M(this,"lastReady",0n);M(this,"syzygy",{wdl:void 0,dtz:void 0});M(this,"name");M(this,"info",[]);M(this,"options",{lines:1,depth:10,maxTime:0,engine:"",nnue:"",syzygy:"",debug:!1,verbose:!0,maxScore:10,options:[],type:"process"});M(this,"state");this.state="starting",t?.depth&&(this.options.depth=t.depth),t?.lines&&(this.options.lines=t.lines),t?.maxTime&&(this.options.maxTime=t.maxTime),t?.debug&&(this.options.debug=t.debug),t?.engine&&(this.options.engine=t.engine),t?.syzygy&&(this.options.syzygy=t.syzygy),t?.nnue&&(this.options.nnue=t.nnue),t?.options&&(this.options.options=t.options),t?.type&&(this.options.type=t.type),this.instance=this.options.type==="process"?new Rn(this,this.processLine):new qn(this,this.processLine)}async init(){await this.instance.init(),this.instance.send("compiler"),this.instance.send("uci"),this.instance.send("setoption name UCI_AnalyseMode value true"),this.instance.send("setoption name Ponder value false"),this.options.nnue.length>0?(this.instance.send(`setoption name EvalFile value ${this.options.nnue}`),this.instance.send("setoption name Use NNUE value true")):this.instance.send("setoption name Use NNUE value false"),this.options.syzygy.length>0&&this.instance.send(`setoption name SyzygyPath value ${this.options.syzygy}`),this.options.lines>1&&this.instance.send(`setoption name MultiPV value ${this.options.lines}`);for(let t of this.options.options)this.instance.send(`setoption name ${t}`);this.instance.send("go depth 1"),this.instance.send("stop"),this.reset(),await this.ready()}async reset(){this.startTime=process.hrtime.bigint(),this.duration=0,this.lines=new Map,this.depth=0,this.noMoves=!1,this.state="busy",this.instance.send("stop"),this.instance.send("ucinewgame"),this.instance.send("position startpos"),this.instance.send("isready"),await this.ready()}async ready(){return new Promise(t=>{let n=setInterval(()=>{this.state==="ready"&&this.name&&(this.lastReady=process.hrtime.bigint(),clearInterval(n),t(!0)),this.lastReady>0n&&Number(process.hrtime.bigint()-this.lastReady)/1e3/1e3>2*this.options.maxTime&&(this.options.debug&&ct.warn("uci ready timeout:",Number(process.hrtime.bigint()-this.lastReady)/1e3/1e3),this.instance.send("stop"),this.instance.send("isready")),this.lastReady>0n&&Number(process.hrtime.bigint()-this.lastReady)/1e3/1e3>1e4&&(this.options.debug&&ct.warn("uci ready abort:",Number(process.hrtime.bigint()-this.lastReady)/1e3/1e3),Jt("engine process unresponsive"))},1)})}set fen(t){this.lastFen=t,this.noMoves=!1,this.instance.send(`position fen ${t}`),this.turn=t.split(" ")[1]==="b"?"black":"white"}get fen(){return this.lastFen}get validOptions(){return this.engineOptions}set move(t){this.instance.send(`position startpos moves ${t}`),this.turn=t.split(" ").length%2?"black":"white"}async stop(){this.instance.send("stop"),this.state="stopping",await this.ready()}async play(t){return this.fen=t,this.state="busy",this.startTime=process.hrtime.bigint(),this.lines=new Map,this.depth=0,this.timeout&&clearTimeout(this.timeout),this.options.maxTime&&this.options.maxTime>0&&(this.timeout=setTimeout(()=>this.instance.send("stop"),this.options.maxTime)),this.options.depth>0?this.instance.send(`go depth ${this.options.depth}`):this.instance.send("go infinite"),await this.ready(),this.analysis}async solve(){this.state="busy",this.instance.send("d"),this.instance.send("isready"),await this.ready();let t=this.syzygy.wdl?{wdl:this.syzygy.wdl||""}:void 0;return this.syzygy.dtz&&t&&(t.dtz=this.syzygy.dtz),t}get analysis(){if(this.noMoves)return{depth:0,time:0,lines:[{score:{type:"mate",score:0,moves:0},nodes:0,tb:-1,depth:0,moves:[]}]};let t=[];for(let n=this.depth;n>=this.depth-1;n--){let i=(this.lines.get(n)||[]).filter(r=>r);for(let r=0;r<i.length;r++)t.findIndex(s=>s.moves[0]===i[r].moves[0])===-1&&t.push(i[r])}return t.length>this.options.lines&&(t.length=this.options.lines),t.length>this.depth/2&&(t.length=Math.trunc(this.depth/2)),{depth:this.depth,time:this.duration,lines:t}}terminate(){this.instance&&this.instance.exit()}processSolve(t){let n=t.split(" ").map(l=>l.trim()).filter(l=>l),i=l=>n.findIndex(u=>u===l)+1,r=l=>i(l)>0?n[i(l)]:void 0,s=l=>Number(r(l)),a=r("WDL:"),o=s("DTZ:");this.options.debug&&ct.debug("uci solve:",{wdl:a,dtz:o}),a&&(this.syzygy.wdl=a),o&&(this.syzygy.dtz=o)}processInfo(t){let n=t.replace("info string ","").replace("Compiled by","").trim();n.startsWith("time")||(this.info.includes(n)||this.info.push(n),this.options.debug&&ct.debug("uci info:",{info:n}))}processData(t){if(t.includes("mate 0")&&(this.noMoves=!0),t.includes("currmove")||t.indexOf(" score ")===-1||t.indexOf(" depth ")===-1||this.noMoves)return;let n=t.split(" ").map(le=>le.trim()),i=le=>n.findIndex(L=>L===le)+1,r=le=>n[i(le)],s=le=>Number(r(le)),a=s("depth")||0,o=s("multipv")||1,l=s("tbhits")||0,u=s("nodes")||0,f=r("score"),d=Number(n[i("score")+1])||0,m;switch(f){case"cp":m=new Ot(d/100,"cp",0);break;case"lowerbound":m=new Ot(d/100,"lowerbound",0);break;case"upperbound":m=new Ot(d/100,"upperbound",0);break;case"mate":m=new Ot(d,"mate",d);break;default:Jt(`engine parse error: ${t}`)}if(!m)return;this.turn==="black"&&(m.score*=-1);let _=n.slice(i("pv")),E={score:m,moves:_,depth:a,nodes:u,tb:l},q=this.lines.get(a)||new Array(this.options.lines);q[o-1]=E,this.lines.set(a,q),a>this.depth&&(this.depth=a),this.options.debug&&ct.debug("uci parse:",{depth:a,score:q[0].score,move:q[0].moves[0],nodes:q[0].nodes,tb:q[0].tb})}processLine(t,n){n||(n=this),t.startsWith("id name")&&(n.name=t.replace("id name ","")),t.startsWith("option")&&n.engineOptions.push(t.replace("option name ","")),t.startsWith("uciok")&&(n.state="started"),t.startsWith("Tablebases")&&n.processSolve(t),(t.startsWith("info string")||t.startsWith("Compiled"))&&n.processInfo(t),t.startsWith("info depth")&&n.processData(t),(t.startsWith("readyok")||t.startsWith("bestmove")||t.startsWith("error"))&&(n.duration=Number((process.hrtime.bigint()-n.startTime)/1000n/1000n),n.lastReady=process.hrtime.bigint(),n.state="ready")}};var $n=Se(require("fs")),Ns=Se(mt()),Qe=[],Is=(e,t)=>{if(t.length<e.length)return!1;let n=!0;for(let i=0;i<e.length;i++)if(e[i]!==t[i]){n=!1;break}return n},Fi=(e="src/openings.json")=>{if(!$n.existsSync(e)){Ns.warn("openings file cannot be located:",e);return}let t=$n.readFileSync(e,"utf8");Qe=JSON.parse(t),Qe.forEach(n=>n.uciMoves=n.uci?.split(" ")||[]),Qe.forEach(n=>n.agMoves=n.pgn?.replace(/[0-9]?[0-9]\. /g,"").split(" ")||[]),Qe.forEach(n=>n.depth=n.uciMoves?.length||0)},bs=e=>{let t=e[0].length===4&&e[0][1].match(/[0-9]/)&&e[0][3].match(/[0-9]/);Qe.length===0&&Fi();let n=t?Qe.find(i=>i.uciMoves?.length===e.length&&Is(e,i.uciMoves)):Qe.find(i=>i.agMoves?.length===e.length&&Is(e,i.agMoves));if(n)return n},ws=e=>{let t=e.split(" ")[0],n=Qe.find(i=>i.epd?.startsWith(t));if(n)return n};var qe=Se(mt()),Bn=Se(Oi());var yl=["a1","b1","c1","d1","e1","f1","g1","h1","a2","b2","c2","d2","e2","f2","g2","h2","a3","b3","c3","d3","e3","f3","g3","h3","a4","b4","c4","d4","e4","f4","g4","h4","a5","b5","c5","d5","e5","f5","g5","h5","a6","b6","c6","d6","e6","f6","g6","h6","a7","b7","c7","d7","e7","f7","g7","h7","a8","b8","c8","d8","e8","f8","g8","h8"];async function Es(e,t,n,i){await e.reset(),await t.reset();let r=new Bn.Game;r.date(new Date),r.event("battle"),r.playerName("w",e.name?.toLocaleLowerCase()),r.playerName("b",t.name?.toLocaleLowerCase()),r.annotator("https://github.com/vladmandic/chess"),r.site("https://github.com/vladmandic/chess"),r.playerTitle("w",`depth:${e.options.depth} maxtime:${e.options.maxTime}`),r.playerTitle("b",`depth:${t.options.depth} maxtime:${t.options.maxTime}`),r.round(n.toString()),r.result("*");let s=new Bn.Position,a=[],o=[],l=[0,0],u=[0,0],f=i.initialFEN?.split(" ")[1]||"w";i.initialFEN&&s.fen(i.initialFEN),r.initialPosition(s);let d=r.mainVariation();qe.info("starting game",{round:n,side:f,fen:s.fen()});let m=s.fen();for(;;){if(f==="w"?e.state!=="ready":t.state!=="ready"){qe.error("engine not ready, aborting:",{side:f});break}o.push(m);let _=f==="w"?await e.play(m):await t.play(m);if((_?.lines?.length||0)<1){qe.warn("no move found, retrying:",_);continue}l[f==="w"?0:1]+=_.time;let E=_.lines[0].moves[0];if(!E)continue;u[f==="w"?0:1]+=_.lines[0].nodes;let q=s.uci(E),le=s.notation(q);a.push(E),s.play(le),d=d.play(le),m=s.fen();let L={turn:d.fullMoveNumber(),side:f,move:_.lines[0].moves[0],fen:m,time:_.time,depth:_.depth},ft="";for(let H of yl){let Ge=s.square(H);Ge[0]==="w"?ft+=Ge[1].toUpperCase():Ge[0]==="b"&&(ft+=Ge[1])}if(L.pieces=ft.length,i.solvedDepth&&ft.length<=i.solvedDepth){let H=await e.solve();H&&(L.solved=H)}let Ee=bs(a);Ee&&(L.opening={eco:Ee.eco,name:Ee.name},r.eco(Ee.eco),r.opening(Ee.name));let Je=ws(m);if(Je&&Je?.eco!==Ee?.eco){L.position={eco:Je.eco,name:Je.name};let H=r.opening()||"";r.opening(`${H?H+" => ":""}${Je.name}`)}let Me=o.filter(H=>H===L.fen).length-1;if(Me>=1&&(L.repeat=Me),q.isCapture()&&(L.capture=q.capturedColoredPiece()),q.isCastling()&&(L.castle=!0),q.isPromotion()&&(L.promotion=q.coloredPromotion()),s.isCheck()&&(L.check=!0),s.isCheckmate()&&(L.checkmate=!0),s.isStalemate()&&(L.stalemate=!0),s.isDead()&&(L.insufficient=!0),s.isLegal()||(L.illegal=!0),_.lines[0].score.type==="cp"&&(L.score=_.lines[0].score.score),_.lines[0].score.type==="syzygy"&&(L.score=_.lines[0].score.score,L.solved=!0),_.lines[0].score.type==="mate"&&(L.mate=_.lines[0].score.score),qe.data(L),L.illegal){qe.error("Illegal position reached",s.fen());break}if(L.checkmate){r.result(s.turn()==="w"?"0-1":"1-0"),r.termination((s.turn()==="w"?"Black":"White")+" wins");break}if(L.stalemate){r.termination("Stalemate"),r.result("1/2-1/2");break}if(L.insufficient){r.termination("Insufficient material"),r.result("1/2-1/2");break}if(i.maxMoves&&d.fullMoveNumber()>=i.maxMoves){r.termination("Maxmimum moves reached");break}if(Me>=3){r.termination("3-fold repetition"),r.result("1/2-1/2");break}f=f==="w"?"b":"w",s.turn(f)}return r.playerTitle("w",r.playerTitle("w")+` nodes:${u[0]} usedTime:${l[0]}ms`),r.playerTitle("b",r.playerTitle("b")+` nodes:${u[1]} usedTime:${l[1]}ms`),r}async function Cl(){ae.configure({inspect:{breakLength:250}}),ae.headerJson();let e=process.argv[2]||"battle.json";ae.info({configFile:e});let t=Un.readFileSync(e,"utf-8"),n=JSON.parse(t);ae.info("config",n),n.engineOptions.length!==2&&(ae.error("config requires two configured engines"),process.exit(1)),n.numGames||(n.numGames=1),Fi(n.openings);let i=new Zt(n.engineOptions[0]);await i.init(),ae.state("engine white",{name:i.name,type:i.options.type,state:i.state,info:i.info});let r=new Zt(n.engineOptions[1]);await r.init(),ae.state("engine black",{name:r.name,type:r.options.type,state:r.state,info:r.info}),n.initialFEN||(n.initialFEN="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1");let s="";for(let a=1;a<=n.numGames;a++){let o=await Es(i,r,a,n);s+=Ss.pgnWrite(o,{withPlyCount:!0})+`
`}n.pgnOutput?(Un.writeFileSync(n.pgnOutput,s,"utf-8"),ae.info("pgn",{file:n.pgnOutput},`
${s}`)):ae.info("pgn",`
${s}`),i.terminate(),r.terminate(),process.exit(0)}Cl();
//# sourceMappingURL=battle.js.map
